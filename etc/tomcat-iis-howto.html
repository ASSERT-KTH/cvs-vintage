<html>

<head>
<title>Tomcat IIS HowTo</title>
</head>

<body>

<h1>Tomcat IIS HowTo</h1>

<p>By Gal Shachor <tt>&lt;shachor@il.ibm.com&gt;</tt></p>

<p>This document explains how to set up IIS to cooperate with Tomcat.
Normally IIS can not execute Servlets and Java Server Pages (JSPs),
configuring IIS to use the Tomcat redirector plugin will let IIS send servlet
and JSP requests to Tomcat (and this way, serve them to clients). </p>

<h2>Document Conventions and Assumptions</h2>

<p>&lt;tomcat_root&gt; is the root directory of tomcat. Your Tomcat
installation should have the following subdirectories:

<ol>
  <li>&lt;tomcat_root&gt;\conf - Where you can place various configuration files</li>
  <li>&lt;tomcat_root&gt;\webapps - Containing example applications </li>
  <li>&lt;tomcat_root&gt;\bin - Where you place web server plugins </li>
</ol>

<p>In all the examples in this document &lt;tomcat_root&gt; will be d:\tomcat.</p>

<p>A <tt>worker</tt> is defined to be a tomcat process that accepts work from the IIS
server.</p>

<h2>Supported Configuration</h2>

<p>The IIS-Tomcat redirector was developed and tested on:

<ol>
  <li>WinNT4.0-i386 SP4/SP5/SP6a (it should be able to work on other
  versions of the NT service pack.) </li>
  <li>IIS4.0 and PWS4.0 </li>
  <li>Tomcat3.0 - Tomcat3.1 build of 02/07/2000</li>
</ol>

<p>The redirector uses <b>ajp12</b> to send requests to the Tomcat
containers. There is also an option to use Tomcat in process, more about the
in-process mode can be found in the in process howto.</p>

<h2>Installation</h2>

<p>The IIS redirector is not part of the "official" build of Jakarta, You
can obtain the code and binaries needed for it by accessing
http://jakarta.apache.org/builds/tomcat/release/v3.1_beta_1/bin/win32/i386/. 
The redirector related file is <tt>isapi_redirect.dll</tt>.</p>

<p>The Tomcat redirector requires three entities:

<ol>
  <li>isapi_redirect.dll - The IIS server plugin, either obtain a pre-built
  DLL or build it yourself (see the build section).</li>
  <li>workers.properties - A file that describes the host(s) and port(s) used
  by the workers (Tomcat processes). A sample <tt>workers.properties</tt> can
  be found under <tt>tomcat/conf</tt>. </li>
  <li>uriworkermap.properties - A file that maps URL-Path patterns to
  workers. A sample <tt>uriworkermap.properties</tt> can be found in the CVS
  under <tt>tomcat/conf</tt>. </li>
</ol>

<p>The installation includes the following parts:

<ol>
  <li>Configuring the ISAPI redirector with a default /examples context and
  checking that you can serve servlets with IIS.</li>
  <li>Adding more contexts to the configuration.</li>
</ol>

<h3>Configuring the ISAPI Redirector</h3>

<p>In this document I will assume that isapi_redirect.dll is placed in
d:\tomcat\bin\iis\i386\isapi_redirect.dll and that you created the properties
files are in d:\tomcat\conf.</p>

<ol>
  <li>In the registry, create a new registry key named <br>
    <tt>&quot;HKEY_LOCAL_MACHINE\SOFTWARE\Apache Software Foundation\Jakarta Isapi
    Redirector\1.0&quot;</tt></li>
  <li>Add a string value with the name <tt>extension_uri</tt> and a value of
    /jakarta/isapi_redirect.dll</li>
  <li>Add a string value with the name <tt>log_file</tt> and a value pointing
    to where you want your log file to be (for example
	<tt>d:\tomcat\isapi.log)</tt></li>
  <li>Add a string value with the name <tt>log_level</tt> and a value for
    your log level (can be <tt>debug</tt>, <tt>inform</tt>, <tt>error</tt>
	or <tt>emerg</tt>). </li>
  <li>Add a string value with the name <tt>worker_file</tt> and a value of
    <tt>D:\tomcat\conf\workers.properties</tt> (you can copy this file
	from the CVS)</li>
  <li>Add a string value with the name <tt>worker_mount_file</tt>and a value of
    <tt>D:\tomcat\conf\uriworkermap.properties</tt> (you can copy this file
	from the CVS) </li>
  <li>Using the IIS management console, add a new virtual directory to your
    IIS/PWS web site. The name of the virtual directory must be jakarta, its
	physical path should be the directory where you placed isapi_redirect.dll
	(in our example it is d:\tomcat\bin\iis\i386). While creating this new
	virtual directory assign it with execute access.</li>
  <li>Using the IIS management console, add isapi_redirect.dll as a filter
    in your IIS/PWS web site. The name of the filter should reflect its task
	(I use the name jakarta), its executable must be our
	<tt>d:\tomcat\bin\iis\i386\isapi_redirect.dll</tt>. For PWS, you'll need 
	to use regedit and add/edit the "Filter DLLs" key under 
	HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\W3SVC\Parameters. This key 
        contains a "," separated list of dlls ( full paths ) - you need to insert the 
        full path to isapi_redirect.dll.</li>
  <li>Restart IIS (stop + start the IIS admin server), make sure that the
    jakarta filter is marked with a green up-pointing arrow. <br>(costin)Under Win98 you may 
    need to cd WINDOWS\SYSTEM\inetsrv and type PWS /stop ( the DLL and log files are locked -
    even if you click the stop button, PWS will still keep the DLLs in memory. ). Type pws
    to start it again.
 </li>
</ol>

<p>That's all, you should now start tomcat and ask IIS to serve you the /examples context.</p>

<h3>Adding additional Contexts</h3>

<p>The examples context is useful for verifying your installation, but you will also need
to add your own contexts. Adding a new context requires two operations:

<ol>
  <li>Adding the context to Tomcat (I am not going to talk about this).</li>
  <li>Adding the context to the ISAPI redirector.</li>
</ol>

<p>Adding a context to the ISAPI redirector is simple, all you need to do is to edit your
<tt>uriworkermap.properties</tt> and to add a line that looks like: </p>

<p><tt>/context/*=worker_name</tt></p>

<p>Workers and their name are defined in workers.properties, by default workers.properties
comes with a single pre-configured worker named &quot;ajp12&quot; so you can use it. As an
example, if you want to add a context named &quot;shop&quot;, the line that you should add
to <tt>uriworkermap.properties</tt> will be:</p>

<p><tt>/shop/*=ajp12</tt></p>

<p>After saving <tt>uriworkermap.properties</tt> restart IIS and it will serve the new context.</p>

<h2>Building the redirector</h2>

<p>The redirector was developed using Visual C++ Ver.6.0, so having this environment is a
prereq if you want to perform a custom build.</p>

<p>The steps that you need to take are:

<ol>
  <li>Change directory to the isapi plugins source directory.</li>
  <li>Execute the following command:<br>
    <tt>MSDEV isapi.dsp /MAKE ALL</tt><br>
    If msdev is not in your path, enter the full path to msdev.exe</li>
</ol>

<p>This will build both release and debug versions of the redirector plugin. </p>

<p>An alternative will be to open the isapi workspace file (isapi.dsw) in msdev and build
it using the build menu.</p>

<h2>How does it work? </h2>

<ol>
  <li>The IIS-Tomcat redirector is an IIS plugin (filter + extension), IIS load the redirector
    plugin and calls its filter function for each in-coming request. </li>
  <li>The filter then tests the request URL against a list of URI-paths held inside
    <tt>uriworkermap.properties</tt>, If the current request matches one of the entries in the list of
    URI-paths, the filter transfer the request to the extension.</li>
  <li>The extension collects the request parameters and forwards them to the appropriate
    worker using the ajp12 protocol.</li>
  <li>The extension collects the response from the worker and returns it to the browser.</li>
</ol>

<h2>Advanced Context Configuration</h2>

<p>Sometimes it is better to have IIS serve the static pages (html, gif, jpeg etc.) even
if these files are part of a context served by Tomcat. For example, consider the html and
gif files in the examples context, there is no need to serve them from the Tomcat process,
IIS will suffice.</p>

<p>Making IIS serve static files that are part of the Tomcat contexts requires the
following:

<ol>
  <li>Configuring IIS to know about the Tomcat contexts</li>
  <li>Configuring the redirector to leave the static files for IIS</li>
</ol>

<p>Adding a Tomcat context to IIS requires the addition of a new IIS virtual directory
that covers the Tomcat context. For example adding a /example IIS virtual directory that
covers the d:\tomkat\webapps\examples directory. </p>

<p>Configuring the redirector is somewhat harder, you will need to specify the exact
URL-Path pattern(s) that you want Tomcat to handle (usually only JSP files and servlets).
This requires a change to the <tt>uriworkermap.properties</tt>. For the examples context it
requires to replace the following line:</p>

<p><tt>/examples/*=ajp12</tt></p>

<p>with the following two lines:</p>

<p><tt>/examples/*.jsp=ajp12 <br>
/examples/servlet/*=ajp12 </tt></p>

<p>As you can see the second configuration is more explicit, it actually instruct the
redirector to redirect only requests to resources under <tt>/examples/servlet/</tt> and
resources under <tt>/examples/ </tt>whose name ends with <tt>.jsp</tt>. You can even be
more explicit and provide lines such as:</p>

<p><tt>/example/servletname=ajp12</tt> </p>

<p>that instructs the redirector to redirect request whose URL-Path equals
<tt>/example/servletname </tt>to the worker named ajp12.</p>

<h3>Protecting the WEB-INF Directory</h3>

<p>Each servlet application (context) has a special directory named WEB-INF, this
directory contains sensitive configurations data and Java classes and must be kept hidden
from web users. Using the IIS management console it is possible to protect the WEB-INF
directory from user access, this however requires the administrator to remember that. To
avoid this need the redirector plugin automatically protects your WEB-INF directories by
rejecting any request that contains WEB-INF in its URL-Path.</p>

<h2>Advanced Worker Configuration</h2>

<p>Sometimes you want to serve different contexts with different Tomcat processes (for
example to spread the load among different machines). To achieve such goal you will need
to define several workers and assign each context with its own worker.</p>

<p>Defining workers is done in <tt>workers.properties</tt>, this file includes
two types of entries:

<ol>
  <li>An entry that lists all the workers defined. For example:<br>
    <tt>worker.list=ajp12, ajp12second</tt></li>
  <li>Entries that define the host and port associated with these workers. For example:<br>
    <tt>worker.ajp12.host=localhost<br>
    worker.ajp12.port=8007<br>
    worker.ajp12second.host=otherhost<br>
    worker.ajp12second.port=8007</tt></li>
</ol>

<p>The above examples defined two workers, now we can use these workers to serve two
different contexts each with its own worker. For example look at the following
<tt>uriworkermap.properties</tt> fragment:</p>

<p><tt>/examples/*=ajp12 <br>
/webpages/*=ajp12second </tt></p>

<p>As you can see the examples context is served by ajp12 while the webpages context is
served by ajp12second.</p>

<h2>Feedback</h2>

<p>Please send feedback, bug report or any additional information to
<tt>tomcat-user@jakarta.apache.org</tt></p>
</body>
</html>
