$Id: recording-issues.txt,v 1.11 2002/12/17 21:26:06 jmcnally Exp $

This document details all of the database modifications for each
'action'. In other words, if you want to create a dependency (the
action), then you would follow the steps immediately below to insert the
appropriate data into the right parts of the database schema. This
document should eventually evolve into a set of tests which can be run
to ensure that the right data gets inserted into the right places. There
are several areas in this document where there are bugs in the current
code. These areas are marked with a FIXME. While most of them are not
critical to the execution of Scarab, they are critical when it comes to
trying to export the data and re-import it back in because in some cases
data is not being saved or it is being saved in the wrong places.

This document is a work in progress and is currently incomplete, however
the parts that are currently in the document can be considered complete.

RULE #1:
    Comments (saved as Attachments) about the Activit(y/ies) are always
    added to the ActivitySet, not the Activity, regardless of the number
    of Activities in the ActivitySet.

RULE #2:
  > Why is it that for URLs and files, the attachment is associated with the 
  > Activity, but for Comments, it asso. with the ActivitySet?

The reason is that, based on the UI, a change to a URL or File could
generate more than one activity record in the activity set with multiple
attachments.

I (JDM) consider RULE #1 to be incorrect.  All comments, urls, and files should be 
added to the Activity record.  The only attachment that should be associated
with an ActivitySet is the "reason" that ties the activities together.  What is
the justification for overloading the attachment_id in the ActivitySet table?


Attributes:
Dependencies:
URL:
Comments:
Dedupe notes (wizard2 note entry):
User assignment:
File attachments:

-------------------------------------------------------------------------
Attributes:

    Create (on issue entry):

        One ActivitySet
            TYPE_ID = 1
            CREATED_BY = user that created issue
            CREATED_DATE = date created
            AttachmentId = null if no comment added during initial Wizard3 entry otherwise...
                           (FIXME: the comment attachment is not being associated here)
                ATTACHMENT_TYPE_ID = 2 (comment)
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'reason for attribute being set'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = NULL
                CREATED_BY = user doing attribute/issue create
                MODIFIED_DATE = NULL
                CREATED_DATE = SET to cre date
                DELETED = 0

        SCARAB_ISSUE_ATTRIBUTE_VALUE (is one entry for each attribute assigned):
            IssueId = SCB1 (100)
            AttributeId = *VARIES depending on attribute*
            NUMERIC_VALUE = 0 || NULL || (value of attribute)
            OPTION_ID = NULL || (value of attribute)
            USER_ID = NULL || (value of attribute)
            VALUE = (text value of attribute)
            DELETED = 0

        Activity N (one for each attribute that is set)
            IssueId = SCB1 (100)
            AttributeId = (the attribute id that is set)
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = 'alskdjf' (if text attribute)
            OLD_OPTION_ID = NULL
            NEW_OPTION_ID = ID (if option attribute)
            OLD_NUMERIC_VALUE = NULL
            NEW_NUMERIC_VALUE = value (if integer attribute)
            DESCRIPTION = 'Summary set to 'alskdjf''
            AttachmentId = null
            END_DATE = null

    Update (NEED TO FINISH):
    
        One ActivitySet
            TYPE_ID = 2
            CREATED_BY = user that updated issue
            CREATED_DATE = date created
            AttachmentId = comment if provided otherwise null
                ATTACHMENT_TYPE_ID = 2 (comment)
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'reason for attribute being set'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = NULL
                CREATED_BY = user doing attribute create
                MODIFIED_DATE = NULL
                CREATED_DATE = SET to cre date
                DELETED = 0
            
        Activity N
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = 'SCB2' (issue id)
            DESCRIPTION = 'Added 'blocking' child dependency on issue SCB2'
            AttachmentId = null (see above requirement)

            Previous Activity record with same issue_id and attribute_id has
            END_DATE set to the CREATE_DATE of this ActivitySet.  This makes
            reporting on past state of db reasonably performant.  This works
            for non-user attributes as they are all currently single valued.
            See user attributes for noted problems in multivalued attributes.

    Delete (NEED TO FINISH):



Move/Copy Issue
    
        One ActivitySet
            TYPE_ID = 3
            CREATED_BY = user that moved issue
            CREATED_DATE = date moved
            AttachmentId = 
                ATTACHMENT_TYPE_ID = 4 (modification)
                ATTACHMENT_NAME = 'Copied issue note'
                ATTACHMENT_DATA =  user-provided reason and selected
                                   attribute data for attributes that
                                   do not exist target module/issue type

                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = NULL
                CREATED_BY = user doing attribute create
                MODIFIED_DATE = Set to cre date
                CREATED_DATE = SET to cre date
                DELETED = 0
            
        Activity N
            IssueId = 100
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = 'SCB1' (old issue id)
            NEW_VALUE = 'SCB2' (new issue id)
            DESCRIPTION = ' copied from issue PACS1 in module Pacman JVM >
                            Source / Defect'
            AttachmentId = null (see above requirement)


Dependencies:

    Create:
    
        One ActivitySet
            TYPE_ID = 2
            AttachmentId = (Can be null if there is no reason)
                ATTACHMENT_TYPE_ID = 4 (modification)
                ATTACHMENT_NAME = 'modification'
                ATTACHMENT_DATA =  user-provided reason
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = NULL
                CREATED_BY = user doing create
                MODIFIED_DATE = Set to cre date
                CREATED_DATE = SET to cre date
                DELETED = 0
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            DEPEND_ID = 31
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Added 'blocking' child dependency on issue SCB2'
            AttachmentId = null

        Activity 2
            IssueId = SCB2 (101)
            AttributeId = 0
            TransactionId = ActivitySetId
            DEPEND_ID = 31
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Added 'blocking' parent dependency on issue SCB1'
            AttachmentId = null

        Scarab_DEPEND
            DEPEND_ID = 31
            OBSERVED_ID = 100
            OBSERVER_ID = 101
            DEPEND_TYPE_ID = 1 (blocking)
            DELETED = 0

    Update:

        One ActivitySet
            TYPE_ID = 2
            AttachmentId = (Can be null if there is no reason)
                ATTACHMENT_TYPE_ID = 4 (modification)
                ATTACHMENT_NAME = 'modification'
                ATTACHMENT_DATA =  user-provided reason
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = NULL
                CREATED_BY = user doing create
                MODIFIED_DATE = Set to cre date
                CREATED_DATE = SET to cre date
                DELETED = 0
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            DEPEND_ID = 31
            OLD_VALUE = blocking
            NEW_VALUE = non-blocking
            DESCRIPTION = 'On issue PACS1, the dependency type for issue PACS2 changed from blocking to non-blocking'
            AttachmentId = null

        Activity 2
            IssueId = SCB2 (101)
            AttributeId = 0
            TransactionId = ActivitySetId
            DEPEND_ID = 31
            OLD_VALUE = blocking
            NEW_VALUE = non-blocking
            DESCRIPTION = 'On issue PACS1, the dependency type for issue PACS2 changed from blocking to non-blocking'
            AttachmentId = null

        Scarab_DEPEND
            DEPEND_ID = 31
            OBSERVED_ID = 100
            OBSERVER_ID = 101
            DEPEND_TYPE_ID = 3 (non-blocking)
            DELETED = 0

    Delete:
    
        One ActivitySet
            TYPE_ID = 2
            AttachmentId = (Can be null if there is no reason)
                ATTACHMENT_TYPE_ID = 4 (modification)
                ATTACHMENT_NAME = 'modification'
                ATTACHMENT_DATA =  user-provided reason
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = NULL
                CREATED_BY = user doing update
                MODIFIED_DATE = Set to up date
                CREATED_DATE = SET to up date
                DELETED = 0
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            DEPEND_ID = 31
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Removed 'blocking' child dependency on issue SCB2'
            AttachmentId = null

        Activity 2
            IssueId = SCB2 (101)
            AttributeId = 0
            TransactionId = ActivitySetId
            DEPEND_ID = 31
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Removed 'blocking' parent dependency on issue SCB1'
            AttachmentId = null

        Scarab_DEPEND
            DEPEND_ID = 31
            OBSERVED_ID = 100
            OBSERVER_ID = 101
            DEPEND_TYPE_ID = 1 (blocking)
            DELETED = 1

URL:

    Create:

        One ActivitySet
            TYPE_ID = 2
            AttachmentId = (FIXME: future, Need to add a UI box to allow user to describe the change.)
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Added URL 'StudioZ.tv'
            AttachmentId = 
                ATTACHMENT_TYPE_ID = 3
                ATTACHMENT_NAME = 'StudioZ.tv'
                ATTACHMENT_DATA = 'http://studioz.tv'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = null
                CREATED_BY = SET to creator
                MODIFIED_DATE = null
                CREATED_DATE = SET to cre date
                DELETED = 0

    Update:

        One ActivitySet
            TYPE_ID = 2
            AttachmentId = (FIXME: future, Need to add a UI box to allow user to describe the change.)
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Modified URL set 'StudioZ.tv' to 'Foo Bar'
            AttachmentId = id of created attachment
                ATTACHMENT_TYPE_ID = 3
                ATTACHMENT_NAME = 'Foo Bar'
                ATTACHMENT_DATA = 'http://foo.bar'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = SET to modified by
                CREATED_BY = DO NOT TOUCH
                MODIFIED_DATE = SET to mod date
                CREATED_DATE = DO NOT TOUCH
                DELETED = 0

    Delete:

        One ActivitySet
            TYPE_ID = 2
            AttachmentId = (FIXME: future, Need to add a UI box to allow user to describe the change.)
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Deleted URL 'Foo Bar'
            AttachmentId =  id of created attachment
                ATTACHMENT_TYPE_ID = 3
                ATTACHMENT_NAME = 'Foo Bar'
                ATTACHMENT_DATA = 'http://foo.bar'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = SET to modified by
                CREATED_BY = DO NOT TOUCH
                MODIFIED_DATE = SET to mod date
                CREATED_DATE = DO NOT TOUCH
                DELETED = 1

Comments:

    Create:
    
        One ActivitySet
            TYPE_ID = 2
            AttachmentId = null
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Added comment 'First few words...'
            AttachmentId = 
                ATTACHMENT_TYPE_ID = 2
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'First few words and then the rest of the comment'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = null
                CREATED_BY = SET to creator
                MODIFIED_DATE = null
                CREATED_DATE = SET to cre date
                DELETED = 0

    Update:
    
        One ActivitySet
            TYPE_ID = 2
            AttachmentId = null
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Modified comment 'First few words...'
            AttachmentId = id of created attachment
                ATTACHMENT_TYPE_ID = 2
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'This is now a modified comment'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = SET to modified by
                CREATED_BY = DO NOT TOUCH
                MODIFIED_DATE = SET to mod date
                CREATED_DATE = DO NOT TOUCH
                DELETED = 0

    Delete:
    
        One ActivitySet
            TYPE_ID = 2
            AttachmentId = null
        
        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Deleted comment 'This is now a modified comment...'
            AttachmentId = id of created attachment
                ATTACHMENT_TYPE_ID = 2
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'This is now a modified comment'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = SET to modified by
                CREATED_BY = DO NOT TOUCH
                MODIFIED_DATE = SET to mod date
                CREATED_DATE = DO NOT TOUCH
                DELETED = 1

Dedupe notes (wizard2 note entry):

    Create (uses Issue.addNote() method):
    
        One ActivitySet (if there are multiple issues, then one activity set for all issues)
            TYPE_ID = 2 (ActivitySetTypePeer.EDIT_ISSUE__PK)
            AttachmentId = null
            User = user who created the note
        
        Activity N  (if there are multiple issues, then one activiy for each issue)
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            OLD_VALUE = NULL
            NEW_VALUE = NULL
            DESCRIPTION = 'Added note to issue'
            AttachmentId = 
                ATTACHMENT_TYPE_ID = 2 (Attachment.COMMENT__PK)
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'All of the note details'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = null
                CREATED_BY = SET to creator
                MODIFIED_DATE = null
                CREATED_DATE = SET to cre date
                DELETED = 0

User assignment:

    Create:

        One ActivitySet 
            TYPE_ID = 2
            AttachmentId = comment if provided otherwise null
                ATTACHMENT_TYPE_ID = 4
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'reason for the assignment.'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = NULL
                CREATED_BY = user doing assignment 
                MODIFIED_DATE = NULL
                CREATED_DATE = SET to cre date
                DELETED = 0

        SCARAB_ISSUE_ATTRIBUTE_VALUE (is one entry for each user assigned):
            IssueId = SCB1 (100)
            AttributeId = Assigned to (102) *VARIES depending on popup menu*
            NUMERIC_VALUE = 0
            OPTION_ID = NULL
            USER_ID = the user's id
            VALUE = the user's login_name
            DELETED = 0

        Activity N 
            IssueId = SCB1 (100)
            AttributeId = Assigned to (102) *VARIES depending on popup menu*
            TransactionId = ActivitySetId
            OLD_USER_ID = NULL
            NEW_USER_ID = userid
            DESCRIPTION = 'Assigned to set to 'derekewla''
            AttachmentId = NULL 
            END_DATE = (LOGIC: if multiple user attributes, the last end date is null)
            FIXME:  END_DATE should be null for all currently assigned users.


    Update (change of attribute for user...ie: Assigned to: -> Assigned cc:):

        One ActivitySet
            TYPE_ID = 2
            AttachmentId = comment if provided otherwise null
                ATTACHMENT_TYPE_ID = 4
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'reason for the modification'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = SET to mod by
                CREATED_BY = set to user doing update
                MODIFIED_DATE = SET to mod date
                CREATED_DATE = set to now
                DELETED = 0

        SCARAB_ISSUE_ATTRIBUTE_VALUE (uses existing data in db):
            IssueId = SCB1 (100)
            AttributeId = Assigned cc (100) *VARIES depending on popup menu*
            NUMERIC_VALUE = 0
            OPTION_ID = NULL
            USER_ID = the user's id
            VALUE = the user's login_name
            DELETED = 0

        Activity N (one activity for each user updated)
            IssueId = SCB1 (100)
            AttributeId = Assigned cc (100) *VARIES depending on popup menu*
            TransactionId = ActivitySetId
            OLD_USER_ID = NULL
            NEW_USER_ID = userid
            DESCRIPTION = 'Assigned cc set to 'derekewla''
            AttachmentId = NULL 
            END_DATE = (LOGIC: if multiple user attributes, the last end date is null)
            FIXME:  END_DATE should be null for all currently assigned users. In
            the case of switching a user from one attribute to another, it would
            be a deletion of the user from one attribute and adding to the
            other.  Since deletion is an activity as well, two activities need
            to be recorded.

    Delete:

        One ActivitySet 
            TYPE_ID = 2
            AttachmentId = comment if provided otherwise null
                ATTACHMENT_TYPE_ID = 4
                ATTACHMENT_NAME = comment (this column can't be null)
                ATTACHMENT_DATA = 'reason for the modification'
                ATTACHMENT_FILE_PATH = null
                ATTACHMENT_MIME_TYPE = text/plain
                MODIFIED_BY = NULL
                CREATED_BY = user doing assignment 
                MODIFIED_DATE = set to created date
                CREATED_DATE = SET to cre date
                DELETED = 0

        SCARAB_ISSUE_ATTRIBUTE_VALUE (uses existing data in db):
            IssueId = SCB1 (100)
            AttributeId = Assigned to (102) *VARIES depending on popup menu*
            NUMERIC_VALUE = 0
            OPTION_ID = NULL
            USER_ID = the user's id
            VALUE = the user's login_name
            DELETED = 1

        Activity N (one activity for each user removed and goes into one
                activityset for all)
            IssueId = SCB1 (100)
            AttributeId = Assigned to (102) *VARIES depending on popup menu*
            TransactionId = ActivitySetId
            OLD_USER_ID = userid
            NEW_USER_ID = NULL
            DESCRIPTION = 'User turbine@tigris.org deleted user ddd from Assigned to'
            AttachmentId = NULL 
            END_DATE = (LOGIC: if multiple user attributes, the last end date is null)

            FIXME: A deletion does not need to maintain a time range, so 
            END_DATE could remain null for such activities, though that usually
            indicates something that is still active, so setting the END_DATE to
            the CREATED_DATE for the ActivitySet is better.  This should be for
            all users deleted.
            Previous activities with same issue_id, attribute_id, and 
            new_user_id=userid should also have  END_DATE to
            the CREATED_DATE for the ActivitySet.

File attachments:

    Create:

        One ActivitySet
            TYPE_ID = 2 (or 1 depending on if this is an attachment during issue create/1 or issue edit/2)
            AttachmentId = null (FIXME: Should be set to optional attachment comment on creation. ui needs to be added for this.)

        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            empty for other columns
            DESCRIPTION = 'added file 'scarab-issues-export.xml' at mod100/0/SCB1_120_scarab-issues-export.xml'
            AttachmentId = 
                ATTACHMENT_TYPE_ID = 1
                ATTACHMENT_NAME = data from description field
                ATTACHMENT_DATA = NULL
                ATTACHMENT_FILE_PATH = Value.patch
                ATTACHMENT_MIME_TYPE = text/plain (mime type of file uploaded)
                MODIFIED_BY = NULL
                CREATED_BY = user doing upload
                MODIFIED_DATE = NULL
                CREATED_DATE = SET to cre date
                DELETED = 0

    Update:
        FIXME - needs to be implemented
                   
    Delete:
    
        One ActivitySet
            TYPE_ID = 2
            AttachmentId = null (FIXME: allow reason for deletion of file)

        Activity 1
            IssueId = SCB1 (100)
            AttributeId = 0
            TransactionId = ActivitySetId
            empty for other columns

            DESCRIPTION = 'deleted attachment for file 'scarab-issues-export.xml'; path=mod100/0/SCB1_120_scarab-issues-export.xml'
            AttachmentId = 
                ATTACHMENT_TYPE_ID = 1
                ATTACHMENT_NAME = data from description field
                ATTACHMENT_DATA = NULL
                ATTACHMENT_FILE_PATH = Value.patch
                ATTACHMENT_MIME_TYPE = text/plain (mime type of file uploaded)
                MODIFIED_BY = SET to mod user
                CREATED_BY = DO NOT CHANGE
                MODIFIED_DATE = SET to mod date
                CREATED_DATE = DO NOT CHANGE
                DELETED = 1
    
