#set ($user = $data.User)
#set ($mitList = $user.CurrentMITList)
<div class="app" id="xmodulelist">

<div class="tabs">
  <table cellpadding="3" cellspacing="0" border="0">
    <tr>
   #if ($link.setPage("home,ModuleQuery.vm").setAction("SetHomePage").isAllowed())
    <td><a href="$link">Module query</a></td>
   #end
   #if ($link.setPage("home,EnterNew.vm").setAction("SetHomePage").isAllowed())
      <td><a href="$link">Enter new...</a></td>
   #end
	<th>Build cross module query</th>
	</tr>
  </table>
</div>

<form method="post" action="$link.setPage("home,XModuleList.vm")">
<input type="hidden" name="action" value="DefineXModuleList" />
<input type="hidden" name="queryString" value="$!queryString" />

#if (!$mitList || $mitList.isEmpty())
 <p>Please choose a predefined list or build a custom list</p>
 <h3>Predefined static cross module lists</h3>

 #set($manager = $scarabG.MITListManager)
 #set($key = "pd_list_id")
 #set($list2 = $manager.AllModulesCurrentIssueTypeList)
 #set($checked2 = $list.QueryKey == $data.Parameters.getString($key, ""))
 #set($list = $manager.AllModulesAllIssueTypesList)
 #set($checked = !$checked2 || $list.QueryKey == $data.Parameters.getString($key, ""))
 <div><input type="radio" name="$key" value="$list.QueryKey"
     #if($checked) checked="checked"#end />$list.Name</div>
 <div><input type="radio" name="$key" value="$list2.QueryKey"
     #if($checked2) checked="checked"#end />$list2.Name</div>

 <div class="functnbar2">
  <input type="submit" name="eventSubmit_doGotoquerywithinternallist" value="Go to define query" />
 </div>
#end


		
<h3>Build list of issue types for this query</h3>

#if ($mitList && !$mitList.isEmpty())
<div class="functnbar">
 <input type="submit" name="eventSubmit_doGotoquery" value="Go to define query" />
</div>
#end

<div class="colbar">
  <select name="list_id">
    <option value="">Select a saved cross module query...</option>
  #foreach ($list in $user.MITLists)
    <option value="$list.QueryKey"#if($list.QueryKey == $data.Parameters.getString("list_id", "")) selected="selected"#end>$list.Name</option>
  #end
  </select>&nbsp;
  <input type="submit" name="eventSubmit_doChooselist" value="Select list" />
</div>
#if (!$mitList || $mitList.isEmpty())
<p class="alert">
No issue types have been selected.  Please select from the list below.
</p>
#else
<table width="100%" border="1" cellspacing="2" cellpadding="3">
  <tr>
    <th nowrap="nowrap">Select</th>
    <th>Module</th>
    <th>Issue type</th>
    <th>Number of issues</th>
    <th>Description</th>
  </tr>
 #foreach ($item in $mitList.MITListItems)
  #indexedRows($velocityCount)
    <td>
    <input type="checkbox" name="mitlistitem" value="$item.QueryKey" />
    </td>
    <td>$item.Module.Name</td>
    <td>$item.IssueType.Name</td>
    <td>$item.IssueCount</td>
    <td>$item.IssueType.Description</td>
  </tr>        
 #end
</table>  
#end

#if ($mitList && !$mitList.isEmpty())
 <div class="functnbar3">
  <input type="submit" name="eventSubmit_doStartover" 
     value="Start over / reset" />&nbsp;
  <input type="submit" name="eventSubmit_doRemoveitemsfromlist" 
     value="Remove from list" />&nbsp;
  <input type="submit" name="eventSubmit_doGotosavelist" value="Save this list" />
 </div>

 <div class="functnbar2">
  <input type="submit" name="eventSubmit_doGotoquery" value="Go to define query" />
 </div>
#end

<a name="add"></a>

<h3>Modules / issues in this domain</h3>

#set ($searchField = $data.Parameters.getString("searchField", ""))
#set ($searchString = $data.Parameters.getString("searchString", ""))
#set ($sortColumn = $data.Parameters.getString("sortColumn", "module"))
#set ($sortPolarity = $data.Parameters.getString("sortPolarity", "asc"))

## FILTERING
<div class="axial">
<table border="0" cellspacing="2" cellpadding="3">
  <tr>
   <th>$l10n.FilterString</th>
   <td><input type="text" name="searchString" value="$searchString"/>&nbsp;
     <select name="searchField" size="">
       <option value="module" #if($searchField.equals("module")) selected="selected"#end>Module</option>
       <option value="issuetype" #if($searchField.equals("issuetype")) selected="selected"#end>Issue type</option>
     </select>&nbsp;
     <input type="submit" name="eventSubmit_doRefresh" 
       value="$l10n.Filter" />
   </td>
  </tr>
 <tr>
</table>
</div>

#set ($searchableRMITs = $user.getSearchableRMITs($searchField, $searchString, $sortColumn, $sortPolarity))
#if ($searchableRMITs.isEmpty() && $searchField.length() != 0 && $searchString.length() != 0)
 ## try one more time with no search criteria
 #set ($searchableRMITs = $user.getSearchableRMITs("", "", $sortColumn, $sortPolarity))
 #if (!$searchResults.isEmpty())
   <p class="alert">Filtering produced no results; showing all issue types.</p>
 #end
#end

#if ($searchableRMITs.isEmpty())
<p class="alert">
There are no more issue types to select.
</p>
#else

## PAGINATION
## if results exceed limit, get subset list
#set ($resultsPerPage = $data.Parameters.getInt("resultsPerPage", 25))
#set ($pageNum = $data.Parameters.getInt("pageNum", 1))

#macro (prepRMITPageLink)
 #set ($dummy = $link.setPage("home,XModuleList.vm").setPathInfo("resultsPerPage", $resultsPerPage.toString()).setPathInfo("searchString", $searchString).setPathInfo("searchField", $searchField).setPathInfo("sortColumn", "$sortColumn").setPathInfo("sortPolarity", "$sortPolarity"))
#end

#macro (paginateXModuleList)
<div class="colbar">
 <p class="paginate">

 #if($scarabR.PrevPage != 0)
  #prepRMITPageLink()
  #set ($prevLink = $link.setPathInfo("pageNum", "$scarabR.PrevPage"))
  <a href="$prevLink">&laquo; previous</a> |
 #end

 $pageNum of $scarabR.NbrPages

 #if ($scarabR.NextPage != 0)
  #prepRMITPageLink()
  #set ($nextLink = $link.setPathInfo("pageNum", "$scarabR.NextPage"))
  | <a href="$nextLink">next &raquo;</a>
 #end
 </p>
</div> 
#end

#set ($isAddPagination = $searchableRMITs.size() > $resultsPerPage)
#if ($isAddPagination)
  #set ($searchableRMITs = $scarabR.getPaginatedList($searchableRMITs, $pageNum.toString(), $resultsPerPage.toString()))
  #paginateXModuleList()
#end

<div class="directory">
  <table width="100%" border="1" cellspacing="2" cellpadding="3">
	<tr>
	  <th nowrap="nowrap">Select</th>

#macro (prepRMITLink $sortKey)
 #set ($dummy = $link.setPage("home,XModuleList.vm").setPathInfo("pageNum",$pageNum.toString()).setPathInfo("resultsPerPage", $resultsPerPage.toString()).setPathInfo("searchString", $searchString).setPathInfo("searchField", $searchField).setPathInfo("sortColumn", "$sortKey"))
#end

#macro (rmitSort $shortName $longName)
  #if ($sortColumn.equals($shortName))
    #if ($sortPolarity.equals("desc"))
      #prepRMITLink($shortName)
      #set ($arrowLink = $link.setPathInfo("sortPolarity", "asc"))
      <a href="$arrowLink"><img src="$staticLink.setPath("/images/icon_downarrow_on.gif")" width="13" height="8" alt="sort descending" title="sort descending" border="0" /></a>&#160;
    #else
      #prepRMITLink($shortName)
      #set ($arrowLink = $link.setPathInfo("sortPolarity", "desc"))
      <a href="$arrowLink"><img src="$staticLink.setPath("/images/icon_uparrow_on.gif")" width="13" height="8" alt="sort ascending" title="sort ascending" border="0" /></a>&#160;
    #end $longName
  #else
    #prepRMITLink($shortName)
    #set ($sortLink = $link.setPathInfo("sortPolarity", "$sortPolarity"))
    <a href="$sortLink">$longName</a>
  #end
#end

	  <th>#rmitSort("module" "Module")</th>
	  <th>#rmitSort("issuetype" "Issue type")</th>
	  <th>Description</th>
    </tr>

#foreach ($rmit in $searchableRMITs)
  #indexedRows($velocityCount)
    <td>
    <input type="checkbox" name="rmitid" value="$rmit.QueryKey" />
    </td>
    <td>$rmit.Module.Name</td>
    <td>$rmit.IssueType.Name</td>
    <td>$rmit.IssueType.Description</td>
  </tr>
#end
</table>  
</div>
#end      

#if ($isAddPagination)
  #paginateXModuleList()
#end

#if (!$searchableRMITs.isEmpty())
<div class="functnbar3">
 <input type="submit"  name="eventSubmit_doAddselectedrmits" 
     value="Add selected to cross module query list" />
</div>
#end

<div class="axial">
  <table cellpadding="3" cellspacing="2" border="0">
     <tr>
       <th>Max items per page</th>
       <td><input type="radio" name="resultsPerPage" value="25" #if ($resultsPerPage.toString().equals("25")) checked="checked" #end /> 25
         <input type="radio" name="resultsPerPage" value="50" #if ($resultsPerPage.toString().equals("50")) checked="checked" #end /> 50
         <input type="radio" name="resultsPerPage" value="75" #if ($resultsPerPage.toString().equals("75")) checked="checked" #end /> 75
         <input type="radio" name="resultsPerPage" value="100" #if ($resultsPerPage.toString().equals("100")) checked="checked" #end /> 100
        &#160;<input type="submit" value="$l10n.Refresh" /></p>
       </td>
     </tr>
  </table>
</div>

## keep track of state of the list, resultsPerPage should come after the
## chance to change it, because we will use the first value
<input type="hidden" name="sortColumn" value="$sortColumn" />
<input type="hidden" name="sortPolarity" value="$sortPolarity" />
<input type="hidden" name="pageNum" value="$pageNum" />
<input type="hidden" name="resultsPerPage" value="$resultsPerPage" />

$intake.declareGroups()
</form>
</div>
