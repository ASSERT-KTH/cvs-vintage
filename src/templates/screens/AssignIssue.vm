<div class="app" id="viewissue">

#set ($searchString = $data.Parameters.getString("searchString" , ""))
#set ($searchField = $data.Parameters.getString("searchField" , ""))
#set ($assoUsers =  $data.User.AssociatedUsersMap)
#set ($issueList = $scarabR.AssignIssuesList)
#set ($issueListSize = $issueList.size())
#set ($modules = $scarabG.getModulesFromIssueList($issueList)) 
#set ($userAttrs = $scarabR.getUserAttributes($issueList)) 
#set ($reason = $data.Parameters.getString("reason" , ""))

#if ($userAttrs.isEmpty())
 <p class="alert">$l10n.NoAssignableUserAttributes</p>
#elseif ($issueListSize == 0)
 <p class="alert">$l10n.AssociateUsersAndIssues</p>
#else

#printCollisionInfo()

#if (!$actionLink)
  #set ($actionLink = $link.setPage("AssignIssue.vm").toString())
#end

<form action="$actionLink" method="post">
<input type="hidden" name="action" value="AssignIssue" />
  
<div class="functnbar">
<input type="submit" value="$l10n.Done" name="eventSubmit_doDone" />
</div>



##ASSIGNEE LIST
## Determine if there are any users to show up in the added/assigned list
#foreach ($issue in $issueList)
 #if ($issue)

<h3>$l10n.format("PersonnelAssociatedWithIssue", "$issue.UniqueId")</h3>

<p>$l10n.format("ClickHereToSelectUsers", $issueListSize)</p>

<div class="colbar">
<ul>
<li>$l10n.ChangesSavedOnDone</li>
</ul>
</div>

#set ($pair = $assoUsers.get($issue.IssueId))
    #if ($pair.size() == 0)
     <p class="alert">$l10n.NoneAssigned.</p>
    #else
		
		<table width="100%" border="1" cellspacing="2" cellpadding="3">
		<tr>
		<th nowrap="nowrap">$l10n.Select</th>
		<th>$l10n.Username</th>
		<th>$l10n.FullName</th>
		<th>$l10n.Association</th>
		</tr>
#foreach ($item in $pair)
  #set ($attr = $item.get(0))
  #set ($user = $item.get(1))
  #set ($userId = $user.UserId)
    <tr class="a">
    <td><input type="checkbox" name="remove_user_$user.UserId" value="$attr.AttributeId" />
    <td><a href="mailto:$user.Email">$user.UserName</a></td>
    <td><strong>$!user.Name</strong></td>
    <td><select name="asso_user_{$userId}_issue_{$issue.IssueId}">
     #foreach ($selectUserAttr in $userAttrs)
      #if ($user.hasPermission($selectUserAttr.Permission, $modules))
        #set ($selected = false)
        #if ($attr.AttributeId.toString().equals($selectUserAttr.AttributeId.toString())) 
            #set ($selected = true)
        #end
        <option value="$selectUserAttr.AttributeId" #selected($selected)>$selectUserAttr.Name</option>
      #end
     #end
       </select></td>
    </tr>
#end

   </table>  

<div class="functnbar3">
 <input type="submit" name="eventSubmit_doRemove_$issue.IssueId" value="$l10n.RemoveSelected" />
 <input type="submit" name="eventSubmit_doUpdate_$issue.IssueId" value="$l10n.UpdateSelected" />
</div>
  #end


#else
 <p class="alert"> $l10n.format("IssueIdNotValid", "$issue.IssueId")</p>
#end
#end

<div class="axial">
 <table cellpadding="3" cellspacing="2" border="0">
    
 <tr>
   <th>$l10n.Comment</th>
   <td>$l10n.EnterReason   
         <p><textarea rows="4" cols="60" name ="reason">$!reason</textarea></p>
   </td>
 </tr>
   
 </table>
</div>
<div class="functnbar2">
 <input type="submit" value="$l10n.Done" name="eventSubmit_doDone" />
</div>

## SORTING
#set ($sortColumn = $data.Parameters.getString("sortColumn","username"))
#set ($sortPolarity = $data.Parameters.getString("sortPolarity","asc"))
#set ($allAttributes = $scarabG.getAllAttributes($sortColumn, $sortPolarity))


## PAGINATION
## if results exceed limit, get subset list
#set ($resultsPerPage = $data.Parameters.getInt("resultsPerPage", 25))
#set ($pageNum = $data.Parameters.getInt("pageNum", 1))

## USER SEARCH

<a name="add"><h3>$l10n.Users</h3></a> 
<div class="axial">
<table border="0" cellspacing="2" cellpadding="3">
  <tr>
   <th>$l10n.FilterString</th>
   <td><input type="text" name="searchString" value="$searchString" />&nbsp;
     <select name="searchField">
      <option value="First Name" #if($searchField.equals("First Name")) selected="selected"#end>$l10n.FirstName</option>
      <option value="Last Name" #if($searchField.equals("Last Name")) selected="selected"#end>$l10n.LastName</option>
      <option value="Username" #if($searchField.equals("Username")) selected="selected"#end>$l10n.Username</option>
     </select>&nbsp;<input type="submit" name="eventSubmit_doRefresh" value="$l10n.Filter" /></td>
  </tr>
</table>
</div>

#if ($searchString && $searchString.length() > 0)
   #set ($searchResults = $scarabR.UserSearchResults) 
   #if ( $searchResults.isEmpty())
      <p class="alert">$l10n.NoUsersMatch</p>
      #set ($searchResults = $scarabR.Users)
   #end
#else
      #set ($searchResults = $scarabR.Users)
#end

#if ($resultsPerPage > 0 && $searchResults.size() > $resultsPerPage)
  #set ($pagList = $scarabR.getPaginatedList($searchResults, $pageNum, $resultsPerPage))
  #set ($paginated = "true")
  #paginateWithSearch ($resultsPerPage $pageNum $sortColumn $sortPolarity $searchString $searchField)
#end

#if ($paginated)
 #if ($pagList)
   #set ($searchResults = $pagList)
 #end
#end

  <table width="100%" border="1" cellspacing="2" cellpadding="3">
	<tr>
	<th nowrap="nowrap">$l10n.Select</th>
	<th>#userSort ("username" "$l10n.Username" "AssignIssue.vm")</th>
    <th>#userSort ("name" "$l10n.FullName" "AssignIssue.vm")</th>
	<th>$l10n.Association</th>
	</tr>
   #foreach ($user in $searchResults)
    #indexedRows($velocityCount)
    <td><input type="checkbox" name="add_user_$user.UserId" value="$user.UserId" /></td>
    <td><a href="mailTo:$user.Email">$user.UserName</a></td>
    <td><strong>$user.Name</strong></td>
    <td><select name="user_attr_$user.UserId">
     #foreach ($userAttr in $userAttrs)
      #if ($user.hasPermission($userAttr.Permission, $modules))
       <option value="$userAttr.AttributeId">$userAttr.Name</option>
      #end
     #end
    </select></td>
    </tr>
   #end
   </table>

#if ($paginated)
  #paginate ($resultsPerPage $pageNum $sortColumn $sortPolarity)

<div class="axial">
  <table cellpadding="3" cellspacing="2" border="0">
     <tr>
       <th>$l10n.MaxPerPage</th>
       <td>
           #resultsPerPageRadioSelect($resultsPerPage)
           &#160;<input type="submit" value="$l10n.Refresh" />
       </td>
     </tr>
  </table>
</div>
#end

<div class="functnbar3">
 <input type="submit" name="eventSubmit_doAdd" value="$l10n.AddAssignee" />
</div>


## keep track of state of the list, resultsPerPage should come after the
## chance to change it, because we will use the first value
<input type="hidden" name="sortColumn" value="$sortColumn" />
<input type="hidden" name="sortPolarity" value="$sortPolarity" />
<input type="hidden" name="pageNum" value="$pageNum" />
<input type="hidden" name="resultsPerPage" value="$resultsPerPage" />

$intake.declareGroups()

#end
</div>
</form>
