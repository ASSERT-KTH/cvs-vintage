<div class="app" id="moveissue">

#set ($user = $data.User)
#set ($issueId = $data.Parameters.getString("id"))
#set ($issue = $scarabR.getIssue($issueId))
#set ($copyToModules = $user.getCopyToModules($scarabR.CurrentModule))
#if (!$issueId || $issueId.length() == 0 || !$issue)

  <p><strong class="alert">Sorry, the requested issue could not be found.</strong></p>

#elseif ($copyToModules.isEmpty())
  <p><strong class="alert">Sorry, there are no modules available as destination modules for this issue.</strong></p>

#else

#set ($moveIssueGroup = $intake.MoveIssue.Default)
#set ($attrValues = $issue.AllAttributeValuesMap)
#set ($attrInput = $intake.AttributeValue.mapTo($attVal))
<form method="post" action="$link.setPage("MoveIssue.vm").setAction("MoveIssue")">
<input type="hidden" name="$moveIssueGroup.IssueId.key" value="$issue.UniqueId" />
## need to also pass id so that if we re-display this page, the right value is kept around
<input type="hidden" name="id" value="$issueId" />
<input type="hidden" name="$scarabG.Constant.NEXT_TEMPLATE" value="MoveIssue2.vm" />

<h3>Issue to be copied/moved</h3>
<table width="100%" border="1" cellspacing="2" cellpadding="3">
 <tr>
#if ($issue.DefaultTextAttributeValue)
   #set ($attVal = $issue.DefaultTextAttributeValue)
#end
#if ($attVal)
  <th>$attVal.RModuleAttribute.DisplayValue</th>
#end
  <th>Date committed</th>
  <th>Committed by</th>
 </tr>
 <tr class="a">
#if ($attVal)
  <td>
   $attVal.Value
  </td>
#end
  <td>$format.getDate($scarabR.DateFormat, $issue.CreatedDate)</td>
  <td>
   #set ($createdUser = $issue.CreatedBy)
   <a href="mailTo:$createdUser.Email">$!createdUser.Name</a>
  </td>
 </tr>
</table>

<h4>Copy / move information</h4>
<div class="axial"> <table border="1" cellspacing="2" cellpadding="3">
<tr>
<th width="120">Destination module</th>
<td>
#fieldErrorMsg($moveIssueGroup.ModuleId "")
<select name="$moveIssueGroup.ModuleId.Key">
 <option>Select module...</option>
 #foreach ($module in $copyToModules)
  #if ($module.ModuleId.equals($scarabR.CurrentModule.ModuleId))
    <option selected="selected" value="$module.ModuleId">$module.Name</option>
  #else
    <option value="$module.ModuleId">$module.Name</option>
  #end
 #end
</select>
</td>
</tr>
<tr>
<th>Action</th>
#set ($userAction = $moveIssueGroup.Action)
#if (!$userAction || $userAction.toString().length() == 0)
   #set ($userAction = 'copy')
#end
<td> <select name="$moveIssueGroup.Action.Key" >
<option value="copy"
     #if ($userAction.toString().equals("copy")) selected="selected" #end >Copy</option>
#if ($user.hasPermission($scarabG.Permission.MODULE__EDIT, $scarabR.CurrentModule))
<option value="move" 
     #if ($userAction.toString().equals("move")) selected="selected" #end >Move</option>
#end
</select>

</td>
</tr>
</table>
</div>

<div class="functnbar2">
  <input type="submit" value="Next" name="eventSubmit_doValidate" />
</div>

$intake.declareGroups()
</form>

#end
</div>
