<div class="app" id="querylist">

<h2>$page.Title</h2>

#set ($module = $scarabR.CurrentModule)
#set ($issueType = $scarabR.CurrentIssueType)
#set ($user = $data.User)

#if ($module.getAllUserQueries($user, $issueType).isEmpty())
 <h3>Saved queries</h3>
 <p><strong class="alert">There are no saved queries.
 Please go to $link.setPage("AdvancedQuery.vm").setLabel("Advanced query")
 to create a new saved query.</strong></p>

#else

<form method="post" action="$link.setPage("QueryList.vm").setAction("QueryList")">
<input type="hidden" name="$scarabG.Constant.NEXT_TEMPLATE" value="QueryList.vm" />


<p>Click query name to edit. Click on location to execute.</p>

<div class="functnbar">        
<input type="submit" value="Done"  name="eventSubmit_doSave" />&#160;
<input type="submit" value="Cancel"  name="eventSubmit_doCancel" />&#160;
</div>
 
## SORTING
#set ($sortColumn = $data.Parameters.getString("sortColumn",""))
#set ($sortPolarity = $data.Parameters.getString("sortPolarity",""))
#if (!$sortColumn || $sortColumn.length() == 0)
   #set ($sortColumn = "name")
#end
#if (!$sortPolarity || $sortPolarity.length() == 0)
   #set ($sortPolarity = "asc")
#end
#set ($allQueries = $scarabR.Queries)

## PAGINATION
## if results exceed limit, get subset list
#set ($resultsPerPage = $data.Parameters.getInt("resultsPerPage",0))
#set ($pageNum = $data.Parameters.getInt("pageNum",0))
#if ($resultsPerPage == 0)
  #set ($resultsPerPage = 25)
#end
#if ($pageNum == 0)
  #set ($pageNum = 1)
#end
#if ($allQueries.size() > $resultsPerPage)
 #set ($paginated = "true")
 #set ($pagList = $scarabR.getPaginatedList($allQueries, $pageNum.toString(),$resultsPerPage.toString()))
 #if ($pagList)
   #set ($allQueries = $pagList)
 #end
#end

#if ($paginated)
  #paginate ($resultsPerPage $pageNum $sortColumn $sortPolarity)
#end

<h3>Saved queries</h3>

<table width="100%" border="1" cellspacing="2" cellpadding="3">
 <tr>
  <th nowrap="nowrap">Select</th>
  <th>Subscribe</th>
  <th>Subscribe frequency</th>
  <th>#sort ("name" "Query name")
  <th>#sort ("desc" "Query description")</th>
  <th>Default</th>
  <th>#sort ("avail" "Availability")</th>
  <th>#sort ("user" "Initiated by")</th>
 </tr>
 
 #foreach ($query in $allQueries)
  #set ($rqu = $query.getRQueryUser($user))
  #set ($rquGroup = $intake.RQueryUser.mapTo($rqu))
  #indexedRows($velocityCount)
  <td><input type="checkbox" name="action_$query.QueryId" /></td>
  <td>#booleanCheckbox($rquGroup.Subscribed) </td>
  <td>#fieldErrorMsg ($rquGroup.Frequency "<br>")
    <select name="$rquGroup.Frequency.Key">
        #frequencySelectBox ($rqu.SubscriptionFrequency)
    </select>
  </td>
  <td><a href="$query.getEditLink($link.setPage("EditQuery.vm").toString())">$query.Name</a></td>
  <td>#if($query.Description)  $query.Description #else &#160; #end</td>
  <td><input type="radio" name="default" value="$query.QueryId" 
          #if ($rqu.Isdefault) checked="checked" #end /></td>
  <td><a href="$query.getExecuteLink($link.setPage("IssueList.vm").toString())">$query.Scope.Name</a>
  #if (!$query.Approved)
   (until approved)
  #end
  </td>
  #set ($createdUser = $scarabR.getUser($query.UserId.toString()))
  <td><a href="mailTo:$createdUser.Email">$!createdUser.FirstName $!createdUser.LastName</a></td>
  </tr>
 #end
</table>

<div class="functnbar3">
<input type="submit" value="Save" name="eventSubmit_doSave" />&#160;
<input type="submit" value="Copy selected" name="eventSubmit_doCopyquery" />
  #if ($scarabR.hasPermission($scarabG.Permission.ITEM__DELETE) || !$module.getPrivateQueries($user).isEmpty())
   &#160;<input type="submit" value="Delete selected" name="eventSubmit_doDeletequeries" />
  #end
   &#160;<input type="submit" value="Create new query" name="eventSubmit_doNewquery" />
</div>

##    <p>&#171; previous | 1 of 1 | next &#187; </p>

#end

<div class="functnbar2">        
<input type="submit" value="Done"  name="eventSubmit_doSave" />&#160;
<input type="submit" value="Cancel"  name="eventSubmit_doCancel" />
</div>

$intake.declareGroups()
</form>
</div>
