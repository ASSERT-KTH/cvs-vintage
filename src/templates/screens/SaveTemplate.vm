#set ($module = $scarabR.CurrentModule)
#set ($issueType = $scarabR.CurrentIssueType)
#set ($templateId = $data.Parameters.getString("templateId"))
#set ($currentTemplate = $scarabR.getIssueTemplate())
#set ($templateInfo = $scarabR.IssueTemplateInfo)
#set ($templateGroup = $intake.IssueTemplateInfo.mapTo($templateInfo))
#set ($issueGroup = $intake.Issue.mapTo($currentTemplate ))

#macro (SaveTemplateBar $var)
<div class="functnbar$var">
<input type="submit" value="Save" name="eventSubmit_doSavetemplate" />
#if ($currentTemplate.getIssueId())
  <input type="submit" value="Use template" name="eventSubmit_doUsetemplate" />&#160;
#end
<input type="submit" value="Cancel" name="eventSubmit_doCancel"  />&#160;
<input type="submit" value="Reset" name="eventSubmit_doReset"  />
</div>
#end

<div class="app" id="savetemplate">

<h2>$page.Title</h2>

<form method="post" action="$link.setPage("SaveTemplate.vm").setAction("TemplateList")">
<input type="hidden" name="$scarabG.Constant.OTHER_TEMPLATE" value="entry,Wizard1.vm" />

#if ($templateId)
  <input type="hidden" name="templateId" value="$templateId" />
#end

#SaveTemplateBar("")

<h3>Template details</h3>

<div class="axial">
<table border="0" cellspacing="2" cellpadding="3">
<tr>
  <th>Template name</th>
  <td>
  <input type="text" size="25" value="$!templateGroup.Name" name="$templateGroup.Name.Key" />
  #fieldErrorMsg($templateGroup.Name "")
  </td>
</tr>
<tr>
  <th>Template description</th>
  <td>
  #textAreaMedium("$templateGroup.Description.Key" $templateGroup.Description)
  </td>
</tr>
<tr>
  <th width="120">Availability</th>
  <td>#templateTypeSelectBox ($templateInfo)</td>
</tr>
#if ($templateId)
<tr>
  <th>Created by</th>
  #set ($createdUser = $currentTemplate.CreatedBy)
  <td>
  #if ($createdUser)
  <a href="mailTo:$createdUser.Email">$!createdUser.FirstName $!createdUser.LastName</a>
  #else
  &#160;
  #end
  </td>
</tr>
#end
</table>
</div>

<h3>Template Attributes</h3>

<div class="axial">
#set ($attrValues = $currentTemplate.ModuleAttributeValuesMap)
#foreach ($attrgroup in $module.getAttributeGroups($issueType))
  #if (!$attrgroup.Attributes.isEmpty())
    <table cellpadding="3" cellspacing="2" border="0">
    <h4>$attrgroup.Name</h4>
  #foreach ($att in $attrgroup.Attributes)
    #set ($rma = $module.getRModuleAttribute($att, $issueType))
    #if ($rma.Active)
      #set ($attVal = $attrValues.get($att.getName().toUpperCase()))
 <tr>
 <th>
  #if ($attVal.Attribute.AttributeType.ValidationKey)
    #set ($field = $attVal.Attribute.AttributeType.ValidationKey)
  #elseif ($attVal.Attribute.AttributeType.Name == "combo-box")
    #set ($field = "OptionId")
  #elseif ($attVal.Attribute.AttributeType.Name == "string")
    #set ($field = "Value")
  #end
  $attVal.RModuleAttribute.DisplayValue
 </th>
 <td>
    #if ($attVal.Attribute.isOptionAttribute())
      #attrValueLeafSelect ($attVal $field "" false)
   #else
     #attrValueErrorMsg($attVal "Value")
     #if ($attVal.Attribute.AttributeType.Name == "long-string")
        #textAreaMedium("$attrInput.Value.Key" $attrInput.Value)
     #else
        <input name= "$attrInput.Value.Key"
            value="$!attrInput.Value" size="45" type="text" />
     #end
   #end
 </td>
 </tr>
      #end
    #end
</table>
  #end
#end
</div>


<div class="functnbar3">
</div>

#SaveTemplateBar("2")

$intake.declareGroups()

</form>
</div>
