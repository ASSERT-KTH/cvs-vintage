#set ($createNew = $data.Parameters.New)
#set ($canEdit = "false")

#set ($moduleId = $data.Parameters.getString("moduleid"))
#if (!$moduleId || $moduleId.length() == 0)
   #set ($createNew = "true")
#end

#if ($createNew && $createNew.equals("true"))
  $page.setTitle("New Module") 
#else
  $page.setTitle("Modify Module") 
  #set ($editModule = $scarabR.getModule($moduleId))
  #set ($canEdit = $scarabR.hasPermission($scarabG.Permission.MODULE__EDIT, $editModule))
#end

#macro (ModifyModuleBar $var)
<div class="functnbar$var">
#if ($createNew && $createNew.equals("true"))
   <input type="submit" name="eventSubmit_doCreate" value="Create" /> 
#else
   <input type="submit" name="eventSubmit_doUpdate" value="Save" /> 
#end
   <input type="submit" name="eventSubmit_doCancel" value="Cancel" />
</div>
#end

<div id="module" class="app">
<h2>$page.Title</h2>

<h3>Module Details</h3>

<form action="$link.setPage("admin,ModifyModule.vm")" method="post">
<input type="hidden" name="action" value="ModifyModule" /> 
<input type="hidden" name="$scarabG.Constant.CANCEL_TEMPLATE" value="admin,ModifyModule.vm" /> 
<input type="hidden" name="$scarabG.Constant.NEXT_TEMPLATE" value="admin,ManageModules.vm" /> 
<input type="hidden" name="$scarabG.Constant.OTHER_TEMPLATE" value="admin,ManageModules.vm" /> 

#set ($moduleGroup = $intake.Module.Default)
#if ($createNew && $createNew.equals("true"))
<input type="hidden" name="new" value="true" /> 
#else
<input type="hidden" name="new" value="false" /> 
<input type="hidden" name="$moduleGroup.Id.Key" value="$moduleId" /> 
<input type="hidden" name="moduleid" value="$moduleId" /> 
#end

#set ($moduleGroup = $intake.Module.mapTo($editModule))
#if ( !$moduleGroup.get("Id").isValid())
<p><strong class="alert">$moduleGroup.get("Id").Message</strong></p>
#end

<div class="axial">
 <table cellpadding="3" cellspacing="2" border="1">
  <tr>
   <th>* Module name</th>
   <td>
    <input name="$moduleGroup.RealName.Key" value="$moduleGroup.RealName" type="text" size="25" />
    #fieldErrorMsg($moduleGroup.RealName "")
   </td>
  </tr>
  <tr>
   <th>* Description</th>
   <td>
     #textAreaMedium ("$moduleGroup.Description.Key" $moduleGroup.Description)
    #fieldErrorMsg($moduleGroup.Description "")
   </td>
  </tr>
  <tr>
   <th>* Code</th>
   <td>
    <input name="$moduleGroup.Code.Key" value="$moduleGroup.Code" type="text" size="10" maxlength="4" />
    #fieldErrorMsg($moduleGroup.Code "")
   </td>
  </tr>
  <tr>
   <th>* URL</th>
   <td>
    <input name="$moduleGroup.Url.Key" value="$moduleGroup.Url" type="text" size="25" />
    #fieldErrorMsg($moduleGroup.Url "")
   </td>
  </tr>
#if (($createNew == "true") || ($moduleId != "0"))
  <tr>
   <th>* Parent module</th>
   <td> 
     #set ($userModules = $data.User.EditableModules)

#* Debugging
     #foreach ($userModule in $userModules)
     [userModule.RealName: $userModule.RealName]<br />
     [userModule.Parent.RealName: $userModule.Parent.RealName]<br />
     [moduleId.toString(): $moduleId.toString()]<br />
     [userModule.ModuleId.toString(): $userModule.ModuleId.toString()]<br />
     [editModule.Parent.ModuleId: $editModule.Parent.ModuleId] <br />
     #end
*#
    <select name="$moduleGroup.ParentId.Key">
    #if ($editModule && $editModule.Parent.ModuleId.toString() == "0")
      <option value="0" selected="selected">Global</option>    
    #else
      <option value="0">Global</option>
    #end
     #foreach ($userModule in $userModules)
       ## we can't assign ourselves as the parent
       #if (!$moduleId.toString().equals($userModule.ModuleId.toString()))
         ## if we are editing an existing module, select the right one in the popup
         #if ($editModule && ($editModule.Parent.ModuleId.toString().equals($userModule.ModuleId.toString()) || $editModule.Parent.ModuleId.toString().equals($userModule.Parent.ModuleId.toString())))
           <option selected="selected" value="$userModule.ModuleId">[$userModule.Name] $userModule.RealName</option>
           <option selected="selected" value="$userModule.Parent.ModuleId">[$userModule.Parent.Name] $userModule.Parent.RealName</option>
         #else
           <option value="$userModule.ModuleId">[$userModule.Name] $userModule.RealName</option>
           ## we already show the global module above, so don't show it again.
           #if ($userModule.Parent.ModuleId.toString() != "0")
           <option value="$userModule.Parent.ModuleId">[$userModule.Parent.Name] $userModule.Parent.RealName</option>
           #end
         #end
       #end
     #end
    </select>
    #fieldErrorMsg($moduleGroup.ParentId "")
   </td>
  </tr>
#end  
 </table>
</div>

#ModifyModuleBar("2")

$intake.declareGroups()
</form>

</div>
