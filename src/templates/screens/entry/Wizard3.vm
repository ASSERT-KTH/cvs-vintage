$page.setTitle("Enter issue")
#set ($issue = $scarabR.ReportingIssue)
#set ($attrValues = $issue.ModuleAttributeValuesMap)
#set ($module = $scarabR.CurrentModule)
#set ($issueType = $scarabR.CurrentIssueType)
#set ($user = $data.User)
#if ($data.Parameters.getString("templateId"))
  #set ($templateId = $data.Parameters.getString("templateId"))
#end
#if ($templateId && $templateId.trim().length() > 0)
  #set ($templ = $scarabR.getIssueTemplate($templateId))
#end

<div class="app" id="div2-1-0">

<h2>$page.Title</h2>

## Only show templates if user has not come through the wizard.
#if (!$data.Parameters.getString("oldscreen"))
<form method="post" action="$link.setPage("entry,Wizard3.vm")">
<input type="hidden" name="action" value="ReportIssue" />

#set ($privateTemplateList = $module.getPrivateTemplates($user,$issueType))
#set ($globalTemplateList = $module.getGlobalTemplates($issueType))
#if ($privateTemplateList.size() > 0 || $globalTemplateList.size() > 0)
 <h3>Apply issue entry template</h3>
 <div class="axial">
         <table width="100%" cellpadding="3" cellspacing="2" border="1">
      <tr>
      <th width="120">Templates</th>
      <td>
      <select name="templateId">
 #foreach ($template in $privateTemplateList)
 <option value="$template.IssueId">$template.TemplateInfo.Name</option>
 #end
 #foreach ($template in $globalTemplateList)
 <option value="$template.IssueId">$template.TemplateInfo.Name</option>
 #end
      </select> 
      &#160;<input type="submit" value="Select" name="eventSubmit_doUsetemplates" /> 
      &#160;$link.setPage("TemplateList.vm").setLabel("template list")
      </td>
      </tr>
      </table>
 </div>
#end
</form>
#end

<form method="post" enctype="multipart/form-data" action="$link.setPage("entry,Wizard3.vm")"> 
<input type="hidden" name="action" value="ReportIssue" />

<p class="functnbar">
<input type="submit" value="Submit issue"  name="eventSubmit_doEnterissue" />&#160;
<input type="reset" value="Reset" />&#160;
<input type="reset" value="Cancel" />
</p>
    
<div class="axial">
#foreach ($group in $issueType.getAttributeGroups($module))
  #if (!$group.Attributes.isEmpty())
    <h3>$group.Name</h3>
    <table cellpadding="3" cellspacing="2" border="0">
  #foreach ($att in $group.Attributes)
    #set ($rma = $module.getRModuleAttribute($att, $issueType))
      #if ($rma.Active)
        #set ($attVal = $scarabR.getNewAttributeValue($att, $issue))
        #set ($templAttVal = $templ.getAttributeValue($att))
        #set ($templAttrInput = $intake.AttributeValue.mapTo($templAttVal))
        #if ($attVal.Attribute.AttributeType.ValidationKey)
           #set ($field = $attVal.Attribute.AttributeType.ValidationKey)
        #elseif ($attVal.Attribute.AttributeType.Name == "combo-box")
           #set ($field = "OptionId")
        #else
          #set ($field = "Value")
        #end
        #if (!$attVal.Attribute.isUserAttribute())
          <tr>
            <th> #if ($attVal.isRequired())*#end 
                 $attVal.RModuleAttribute.DisplayValue: 
            </th>
            <td>
              #if ($attVal.Attribute.isUserAttribute())
                 #userSelectBox ($attVal "3" "true") 
              #elseif ($attVal.Attribute.isOptionAttribute())
                 #if ($templ)
                   #templateAttrValueLeafSelect ($attVal $templAttVal $field "" false )
                 #else
                   #attrValueLeafSelect ($attVal $field "" false)
                 #end
              #else
               #if ($templ)
                 #templateAttrValueText ( $attVal "50" $templAttrInput.Value)
               #else
                 #attrValueText ( $attVal "50" )
               #end
              #end
              #attrValueErrorMsg ($attVal $field)
            </td>
          </tr>
        #end
      #end
    #end
</table>
 #end
 #end
</div>

## ATTACHMENT
<h4>Add Attachment</h4>
<div>
  <table cellpadding="3" cellspacing="2" border="0">
    #set ($atch = $scarabR.Attachment)
    #set ($intakeAttachment = $intake.Attachment.mapTo($atch))
    #set ($reportingIssue = $scarabR.ReportingIssue)
    #set ($attachments = $reportingIssue.Attachments)
    #if ($attachments.size()>0)
       <tr>
        <th> &nbsp; </th>
        <th>File Name</th>
        <th>File Description</th>
       </tr>
       #foreach ($file in $reportingIssue.Attachments)
           #indexedRows($velocityCount)
           #if ($file.TypeId.toString().equals("1"))
             <tr>
             <td>
                <input type="checkbox" name="file_delete_$velocityCount" />
             </td>
             <td><a href="$file.File.FileName" 
                onClick="fileWindow=window.open('','filewindow',
                'resizable=yes, menubar=yes,scrollbars=yes,height=450,width=700')" 
                target="filewindow">$file.File.FileName</a> 
             </td>
             <td>$file.Name</td>
            </tr>
           #end
       #end
    #end
    <tr>
      <th>Attachment path</th>
      <td>
       <input type="file" name="$intakeAttachment.File.Key" size="45"
            value="$!intakeAttachment.File.Value.FileName" />
       <p>Click Browse and select a file. If you do not see a Browse
       button, your browser does not support file uploads. Windows
       users, set Files of Type: to be All Files (*.*) to get a
       complete file listing. The File field cannot be used to
       rename files.</p>
      </td>
    </tr>
    <tr>
      <th>Attachment description</th>
      <td>
       #textAreaMedium("$intakeAttachment.Name.Key" "")
       #fieldErrorMsg($intakeAttachment.Name "")
      </td>
    </tr>    
  </table>
</div>
<div class="functnbar3">
    <input type="submit" value="Add file" name="eventSubmit_doAddfile"  />&#160;
    <input type="submit" value="Delete file" name="eventSubmit_doRemovefile"  />&#160;
</div>


<div class="axial">
<table width="100%" cellpadding="3" cellspacing="2" border="1">
 <tr>
   <th>Comment</th>
   <td>
   <p>
#if ($issue.DefaultTextAttributeValue)
    Any information that did not fit within one of the attributes shown
    above can be added here.
#else
    <strong>Required</strong>Please supply a short description which will be
    useful for users receiving the new issue email.  Also any information that
    did not fit within one of the attributes shown above can be added here.
#end 
   </p>

#set ($intakeAttachment = $intake.Attachment.setKey("_1"))
#textAreaMedium("$intakeAttachment.DataAsString.Key" $intakeAttachment.DataAsString)
   </td>
 </tr>

<tr>
<th width="120">After submit </th>
<td><select name="$scarabG.Constant.NEXT_TEMPLATE">
<option value="$data.Parameters.getString($scarabG.Constant.HISTORY_SCREEN, "entry,Wizard3.vm")">Enter new issue </option>
<option value="AssignIssue.vm"> Assign issue </option>         
<option value="ViewIssue.vm"> View this issue </option>         
<option value="Index.vm"> Go to Start page </option>            
</select></td>
</tr>
</table>
</div>  


<p class="functnbar2">
<input type="submit" value="Submit issue"  name="eventSubmit_doEnterissue" />&#160;
<input type="reset" value="Reset" />&#160;
<input type="reset" value="Cancel" />
</p>

$intake.declareGroups()
</form>
</div>

