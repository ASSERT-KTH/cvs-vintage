$page.setTitle("Enter issue")

#set ($issue = $scarabR.ReportingIssue)
#set ($attrValues = $issue.ModuleAttributeValuesMap)
#set ($module = $scarabR.CurrentModule)
#set ($issueType = $scarabR.CurrentIssueType)
#set ($user = $data.User)
#set ($templateId = $data.Parameters.getString("templateId"))
#if ($templateId && $templateId.trim().length() > 0)
  #set ($templ = $scarabR.getIssueTemplate($templateId))
  #set ($templAttrValues = $templ.ModuleAttributeValuesMap)
#end

<div class="app" id="div2-1-0">

<h2>Enter issue</h2>

<div class="tabs">
  <table cellpadding="3" cellspacing="0" border="0">
  <tr>
  <td>1: Summary info</td>
  <td>2: Duplicate check</td>
  <th>3: Verbose info</th>
  </tr>
  </table>
</div>

## Only show templates if user has not come through the wizard.
#if (!$data.Parameters.getString("oldscreen"))
<form method="get" action="$link.setPage("entry,Wizard3.vm")">
<input type="hidden" name="action" value="ReportIssue" />

#set ($privateTemplateList = $module.getPrivateTemplates($user,$issueType))
#set ($globalTemplateList = $module.getGlobalTemplates($issueType))
#if ($privateTemplateList.size() > 0 || $globalTemplateList.size() > 0)
 <h3>Apply issue entry template</h3>
 <div class="axial">
         <table width="100%" cellpadding="3" cellspacing="2" border="1">
      <tr>
      <th width="120">Templates</th>
      <td>
      <select name="templateId">
 #foreach ($template in $privateTemplateList)
 <option value="$template.IssueId">$template.TemplateInfo.Name</option>
 #end
 #foreach ($template in $globalTemplateList)
 <option value="$template.IssueId">$template.TemplateInfo.Name</option>
 #end
      </select> 
      &#160;<input type="submit" value="Select" name="eventSubmit_doUsetemplates" /> 
      &#160;<a href="$link.setPage("TemplateList.vm")">template list</a>
      </td>
      </tr>
      </table>
 </div>
#end
</form>
#end

<form method="get" action="$link.setPage("entry,Wizard3.vm")">
<input type="hidden" name="action" value="ReportIssue" />

<div class="functnbar">
<table cellpadding="4" cellspacing="0" border="1">
 <tr>
  <td class="firstchild">
  <input type="submit" name="eventSubmit_doEnterissue" value="Save" />
  </td>
 </tr>
</table>
</div>

<div class="axial">
<h3>Input your issue</h3>
    <table cellpadding="3" cellspacing="2" border="0">
#foreach ($attKey in $attrValues.sequence())
  #set ($attVal = $attrValues.get($attKey))
 ## we are handling the assigned_to attribute specially.  This needs to be
 ## generalized and I am not sure why we can't just add users on this page
 ##if (!$attVal.AttributeId.equals($scarabG.Constant.ASSIGNED_TO__PK))
  #set ($attrInput = $intake.AttributeValue.mapTo($attVal))
  #set ($templAttVal = $templAttrValues.get($attKey))
  #set ($templAttrInput = $intake.AttributeValue.mapTo($templAttVal))
  #if ($attVal.Attribute.AttributeType.ValidationKey)
        #set ($field = $attVal.Attribute.AttributeType.ValidationKey)
  #elseif ($attVal.Attribute.AttributeType.Name == "combo-box")
        #set ($field = "OptionId")
  #else
        #set ($field = "Value")
  #end
  ##if (!$attVal.isSet())
        <tr>
            <th>
    #if ($attVal.isRequired())*#end
    $attVal.RModuleAttribute.DisplayValue:
            </th>
            <td>
    #if ($attVal.Attribute.isUserAttribute())
          #userSelectBox ($attVal "3" "true") 
    #elseif ($attVal.Attribute.isOptionAttribute())
        #if ($templateId)
          #templateAttrValueLeafSelect ($attVal $templAttVal $field "")
        #else
          #attrValueLeafSelect ($attVal $field "")
        #end
    #else
#set ($currentValue = "")
        #if ($attrInput.Value.toString().length() > 0)
             #set ($currentValue = $attrInput.Value)
        #elseif ($templAttrInput.Value.toString().length() > 0)
             #set ($currentValue = $templAttrInput.Value)
        #end
        #if ($attVal.Attribute.AttributeType.Name == "long-string")
            <textarea name= "$attrInput.Value.Key" cols="40"
               rows="4">$!currentValue</textarea>
        #else
           <input name= "$attrInput.Value.Key"
                value="$!currentValue" size="45" type="text" />
        #end
    #end
    #attrValueErrorMsg ($attVal $field)
            </td>
        </tr>
  ##end
 ##end
#end
        </table>
</div>
<h3>Add Attachment</h3>
<div class="axial">
    <table cellpadding="3" cellspacing="2" border="0">
     <tr>
      <th>Attachment description</th>
#set ($atch = $scarabR.Attachment)
#set ($intakeAttachment = $intake.Attachment.mapTo($atch))
      <td>
       <textarea name="$intakeAttachment.Name.Key" cols="45" rows="2"
           >$!intakeAttachment.Name</textarea>
        <p>
          Please provide a short (less than 250 characters) description
          of the attachment
        </p>
      </td>
     </tr>
     <tr>
      <th>File path</th>
      <td>
       <input type="file" name="$intakeAttachment.File.Key" size="45"
            value="$!intakeAttachment.File.Value.FileName" />
       <p>Click Browse and select a file. If you do not see a Browse
       button, your browser does not support file uploads. Windows
       users, set Files of Type: to be All Files (*.*) to get a
       complete file listing. The File field cannot be used to
       rename files.</p>
      </td>
     </tr>
    </table>
</div>

<div class="axial stb">
    <table cellpadding="3" cellspacing="2" border="0">
     <tr>
     <th>
      Workflow options</th>
     <td>
    go to 
   <input type="radio" checked="checked" name="$scarabG.Constant.NEXT_TEMPLATE"
      value="$data.Parameters.getString($scarabG.Constant.HISTORY_SCREEN, "entry,Wizard3.vm")" />
      Enter New Issue |
  <input type="radio" name="$scarabG.Constant.NEXT_TEMPLATE" value="Index.vm" />
      Start Page |
  <input type="radio" name="$scarabG.Constant.NEXT_TEMPLATE" value="AssignIssue.vm" />
      Assign Issue |
  <input type="radio" name="$scarabG.Constant.NEXT_TEMPLATE" value="ViewIssue.vm" />
      View This New Issue
      </td>
      </tr>
    </table>
</div>

<div class="functnbar2">
<table cellpadding="4" cellspacing="0" border="1">
 <tr>
  <td class="firstchild">
  <input type="submit" name="eventSubmit_doEnterissue" value="Save" />
  </td>
 </tr>
</table>
</div>

$intake.declareGroups()
</form>
</div>
