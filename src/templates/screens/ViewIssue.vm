#set ( $action = $link.setPage("ViewIssue.vm").setAction("ModifyIssue").addPathInfo("nextTemplate", "ViewIssue.vm") )
#set ( $currentIssueId = $data.Parameters.getString("id") )
#set ( $currentIssue = $scarabR.getIssue($currentIssueId) )
#if ($currentIssue)
    #set ($attrValues = $currentIssue.ModuleAttributeValuesMap)


<form name="IssueForm" method="post" action="$action" >
<input type="hidden" name="id" value="$currentIssue.IssueId">
#set($attVal =  $attrValues.get("DESCRIPTION"))
#set ( $attrInput = $intake.AttributeValue.mapTo($attVal) ) 
 
#set($attVal =  $attrValues.get("OPERATING SYSTEM"))
#set ( $attrInput = $intake.AttributeValue.mapTo($attVal) ) 


      <div class="functnbar">
       <table width="100%" cellpadding="3" cellspacing="2" border="1">
        <tr>
         <td><input type="submit" value="previous" class="buttonfunc" />&#160;<input type="submit" value="next" class="buttonfunc" />&#160;issues | 3 of 5</td>
        </tr>
       </table>
      </div>

      <div class="grouper">
       <div class="datatitle">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <td>Issue ID #$currentIssue.UniqueId</td>
         </tr>
        </table>
       </div>

       <div class="listtable">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <td width="120" class="a"><strong>issue id #:</strong></td>

          <td class="b">#$currentIssue.UniqueId</td>
         </tr>
#foreach ( $attKey in $attrValues.sequence() )
  #set ( $attVal = $attrValues.get($attKey))
  #set ( $attrInput = $intake.AttributeValue.mapTo($attVal) ) 


  #if ( $attVal.Attribute.AttributeType.ValidationKey )
        #set ( $field = $attVal.Attribute.AttributeType.ValidationKey )
  #elseif ($attVal.Attribute.AttributeType.Name == "combo-box" )
        #set ( $field = "OptionId" )
  #else
        #set ( $field = "Value" )  
  #end

  #if ($attVal.Value )
         <tr>
          <td width="120" class="a">
             <strong>$attVal.Attribute.Name:</strong>
          </td> 
          <td class="b">

    #if ($attVal.Attribute.AttributeType.AttributeClass.Name == "user")
          #attrValueErrorMsg ( $attVal $field )
       #userSelectBox ($attVal "")
    #elseif ($attVal.Attribute.AttributeType.Name == "combo-box" )
          #attrValueLeafSelect ($attVal $field "")
          #attrValueErrorMsg ( $attVal $field )
    #else
         #attrValueErrorMsg( $attVal "Value" )
        #if ($attVal.Attribute.AttributeType.Name == "long-string" )        

            <textarea name="$attrInput.Value.Key" cols="40" 
               rows="5">$!attrInput.Value</textarea>
        #else

           <input name= "$attrInput.Value.Key"
                value="$!attrInput.Value" size="20" type="text">

        #end
    #end
          </td>
         </tr>
  #end
#end

         <tr>
           <td colspan="2">Please add a comment to explain your change(s):
           <BR>
        #set( $attCommentGroup = $intake.Attachment.setKey("attCommentKey") )
         #fieldErrorMsg($attCommentGroup.DataAsString "<br>")
           <textarea rows="4" cols="35" class="text" name ="$attCommentGroup.DataAsString.Key"></textarea>
           <input type="hidden" name="$attCommentGroup.Name.Key" value="comment">
           </td>
        </tr>
        <tr>
           <td><input type="submit" value="edit attributes" name="eventSubmit_doSubmitattributes" class="button" /></td>
           <td></td>
         </tr>
        </table>
       </div>
      </div>


## URLS
      <div class="grouper">
       <div class="datatitle">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <td>Related Links</td>
         </tr>
        </table>
       </div>

       <div class="datatable">
        <table width="100%" border="1" cellspacing="2" cellpadding="3">
         <tr>
          <th><a href="#"><img src="./images/icon_uparrow.gif" width="13" height="8" alt="sort" border="0" /></a><a href="#"><img src="./images/icon_downarrow.gif" width="13" height="8" alt="sort" border="0" /></a></th>

          <th><a href="#">URL:</a></th>

          <th><a href="#">description:</a></th>
         </tr>

    #foreach($url in $currentIssue.Urls)
         #if( $velocityCount % 2 > 0 )
            <tr class="a">
         #else 
            <tr class="b">
         #end
          <td><input type="checkbox" name="url_delete_$url.AttachmentId"/></td>

          <td><input type="text" size="25" class="text" value="$url.DataAsString" /> </td>

          <td><input type="text" size="25" class="text" value="$url.Name" /></td>
         </tr>
    #end
         <tr>
          <td><strong>add url:</strong></td>

#set( $urlGroup = $intake.Attachment.setKey("urlKey") )
          <td>
         #fieldErrorMsg($urlGroup.Name "<br>")
         <input type="text" size="25" class="text" name="$urlGroup.Name.Key" value="$!urlGroup.Name" />
         </td>

          <td>
         #fieldErrorMsg($urlGroup.DataAsString "<br>")
         <input type="text" size="25" class="text" name="$urlGroup.DataAsString.Key" value="$!urlGroup.DataAsString"/>
          </td>

         </tr>

        </table>
       </div>
           <p><input type="submit" value="add url" name="eventSubmit_doSubmiturl"  class="button" />&#160;<input type="submit" value="delete url"  name="eventSubmit_doDeleteurl" class="button" /></p>


## ADD DEPENDENCY
<div class="grouper">
<div class="datatitle">
<table width="100%" cellpadding="3" cellspacing="2" border="1">
 <tr>
  <td>Add Dependency</td>
 </tr>
</table>
</div>

<div class="datatable">
<table width="100%" border="1" cellspacing="2" cellpadding="3">
 <tr>
  <td>Add dependency on issue #</td>
  <td><input type="text" size="3" class="text" name="parent_id"></td>
  <td>
  <select name="add_depend_type_id" class="select">
    <option value="0">Choose dependency type</option>
    #foreach ($dependType in $currentIssue.getAllDependencyTypes())
      <option value="$dependType.DependTypeId">
          $dependType.Name</option>
    #end
    </td>
 </tr>
</table>
       <p><input type="submit" value="add dependency"  name="eventSubmit_doAdddependency" class="button" />
</div>


## PARENT ISSUES
#if (!$currentIssue.Parents.isEmpty() )

      <div class="grouper">
       <div class="datatitle">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <td>Parent Issues</td>
         </tr>
        </table>
       </div>

       <div class="datatable">
        <table width="100%" border="1" cellspacing="2" cellpadding="3">
         <tr>

          <th width="20%"><a href="#">issue id#:</a></th>

          <th width="40%"><a href="#">issue summary:</a></th>

          <th><a href="#">dependency type:</a></th>
         </tr>

       #foreach( $parent in $currentIssue.Parents )
         #if( $velocityCount % 2 > 0 )
            <tr class="a">
         #else 
            <tr class="b">
         #end
          <td><a href="IssueView.vm?id=$parent.IssueId">$parent.IssueId</a></td>

          <td><a href="IssueView.vm?id=$parent.IssueId">
             #set ($parentAttrValues = $parent.AllAttributeValuesMap)
             #set($attVal =  $parentAttrValues.get("SUMMARY"))
             #set ( $attrInput = $intake.AttributeValue.mapTo($attVal) )
           $attVal.Value</a></td>

          <td>
        <select name="parent_depend_type_id_$parent.IssueId" class="select">
            #foreach ($dependType in $currentIssue.getAllDependencyTypes())
              #set ( $selected = "" )
              #if ( $parent.getDependency($currentIssue).TypeId.toString().equals($dependType.DependTypeId.toString()))
                #set ( $selected = " selected" )
              #end
              <option$selected value="$dependType.DependTypeId">
                  $dependType.Name</option>
            #end
              <option value="none">remove dependency </option>
        </select>
          </td>
         </tr>
       #end

        </table>

       <p><input type="submit"  name="eventSubmit_doUpdateparent" value="update parent issue" class="button" />
       </div>
      </div>
#end


## CHILD ISSUES
#if (!$currentIssue.Children.isEmpty() )
      <div class="grouper">
       <div class="datatitle">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <td>Child Issues</td>
         </tr>
        </table>
       </div>

       <div class="datatable">
        <table width="100%" border="1" cellspacing="2" cellpadding="3">
         <tr>

          <th width="20%"><a href="#">issue id#:</a></th>

          <th width="40%"><a href="#" width="40%">issue summary:</a></th>

          <th><a href="#">dependency type:</a></th>
         </tr>

       #foreach( $child in $currentIssue.Children )
         #if( $velocityCount % 2 > 0 )
            <tr class="a">
         #else 
            <tr class="b">
         #end

          <td><a href="IssueView.vm?id=$child.IssueId">$child.IssueId</a></td>

          <td><a href="IssueView.vm?id=$child.IssueId">
             #set ($childAttrValues = $child.AllAttributeValuesMap)
             #set($attVal =  $childAttrValues.get("SUMMARY"))
             #set ( $attrInput = $intake.AttributeValue.mapTo($attVal) )
           $attVal.Value</a></td>

           <td>
            <select name="child_depend_type_id_$child.IssueId" class="select">
            <option>Choose dependency type</option>
            #foreach ($dependType in $currentIssue.getAllDependencyTypes())
              #set ( $selected = "" )
              #if ( $currentIssue.getDependency($child).TypeId.toString().equals($dependType.DependTypeId.toString()) )
                #set ( $selected = " selected" )
              #end
              <option$selected value="$dependType.DependTypeId">
                  $dependType.Name</option>
            #end
            <option value="none">remove dependency </option>
        </select>
          </td>
         </tr>
       #end

        </table>

       <p><input type="submit" value="update child issue"  name="eventSubmit_doUpdatechild" class="button" />
       </div>
      </div>
#end


## COMMENTS
      <div class="grouper">
       <div class="datatitle">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <td>Comments <a href="#">hide section</a></td>
         </tr>
        </table>
       </div>
       <div class="listtable">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
    #foreach($comment in $currentIssue.Comments)
         <tr>
          <td width="120" class="a">
           #if( $comment.ModifiedBy && $commentModifiedDate)
            #set ( $email = $comment.ScarabUserRelatedByModifiedBy.Email )
            <strong>$comment.ModifiedDate <a href="mailto:$email">$email</a></strong></td>
           #end
          </td>

          <td class="b"><textarea rows="2" cols="35" class="text">$comment.DataAsString</textarea></td>
         </tr>
    #end

         <tr>
          <td width="120" class="a"><strong>add comment:</strong></td>
          <td class="b">
        #set( $commentGroup = $intake.Attachment.setKey("commentKey") )
        #fieldErrorMsg($commentGroup.DataAsString "<br>")
           <textarea rows="2" cols="35" class="text" name ="$commentGroup.DataAsString.Key"></textarea>
           <input type="hidden" name="$commentGroup.Name.Key" value="comment">
           <p><input type="submit" value="add comment" name="eventSubmit_doSubmitcomment"  class="button" /></p>
          </td>
         </tr>
        </table>
       </div>
      </div>


## ISSUE HISTORY
      <div class="grouper">
       <div class="datatitle">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <td>Issue History (up to first ten)</td>
         </tr>
        </table>
       </div>

       <div class="datatable">
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <th width="120"><strong>date stamp:</strong></th>

          <th><strong>action:</strong></th>

          <th><strong>note:</strong></th>
         </tr>

       #foreach( $activity in $currentIssue.Activity )
         #if( $velocityCount % 2 > 0 )
            <tr class="a">
         #else 
            <tr class="b">
         #end
          <td width="120">
            #if( $activity.Transaction)
              $activity.Transaction.CreatedDate
            #end
          </td>
      #if ($activity.Attribute.AttributeType.Name == "long-string" )
          <td width="120">changed $activity.Attribute.Name</td>
      #else
          <td width="120">changed $activity.Attribute.Name from $activity.OldAttributeOption.Name to $activity.NewAttributeOption.Name</td>
      #end

          <td>$activity.Attachment.DataAsString</td>
         </tr>
       #end

        </table>
       </div>
      </div>

      <p><a href="#">view complete history</a></p>

      <p><input type="submit" value="submit append" class="button" />&#160;<input type="submit" value="cancel" class="button" />&#160;<input type="reset" value="reset" class="button" /></p>

      <div class="grouper">
        <div class="functnbar">
           <table width="100%" cellpadding="3" cellspacing="2" border="1">
            <tr>
             <td><input type="submit" value="previous" class="buttonfunc" />&#160;<input type="submit" value="next" class="buttonfunc" />&#160;issues | 3 of 5</td>
            </tr>
           </table>
       </div>
      </div>
$intake.declareGroups()
</form>

#else     ## issue id was not valid

    #if ($currentIssueId)

        The issue id, $currentIssueId, is not valid.

    #else
    
        You need to enter an issue id.

    #end

#end
