<div class="app" id="moveissue2">

#set ($moveIssueGroup = $intake.MoveIssue.Default)
#set ($issueList = $data.Parameters.getStrings("issue_ids"))

#if (!$issueList || $issueList.length() == 0)

<p class="warningmark"><strong>$l10n.CouldNotFindIssue</strong></p>

#else

#set ($selectAction = $moveIssueGroup.Action.Value)
#set ($newModuleId = $moveIssueGroup.ModuleId.Value)
#set ($newIssueTypeId = $moveIssueGroup.IssueTypeId.Value)
#set ($newModule = $scarabR.getModule("$newModuleId"))
#set ($newIssueType = $scarabR.getIssueType("$newIssueTypeId"))
#set ($module = $scarabR.CurrentModule)
#set ($issueType = $scarabR.CurrentIssueType)
#set ($isMultiple =$scarabG.sizeOfArray($issueList) > 1)

#if (!$isMultiple)
  #foreach ($issueId in $issueList)
    #set ($issue = $scarabR.getIssue($issueId))
  #end
  ## For single issue move, display attribute values for this issue
  #set ($matchingAttributes = $issue.getMatchingAttributeValuesList($newModule, $newIssueType))
  #set ($orphanAttributes = $issue.getOrphanAttributeValuesList($newModule, $newIssueType))
#else
  ## For multiple issue move, cannot display attribute values, only attributes.
  #set ($matchingAttributes = $issueType.getMatchingAttributeValuesList($module, $newModule, $newIssueType))
  #set ($orphanAttributes = $issueType.getOrphanAttributeValuesList($module, $newModule, $newIssueType))
#end

#if ($selectAction.toString().equals("move"))
 #set ($actionText = "move")
 #set ($booleanAction = true)
#else
 #set ($actionText = "copy")
 #set ($booleanAction = false)
#end

<form method="post" action="$link.setPage("MoveIssue2.vm")">
<input type="hidden" name="action" value="MoveIssue" />
<input type="hidden" name="$scarabG.Constant.NEXT_TEMPLATE" value="ViewIssue.vm" />
<input type="hidden" name="$scarabG.Constant.CANCEL_TEMPLATE" value="MoveIssue.vm" />
#foreach ($issueId in $issueList)
<input type="hidden" name="issue_ids" value="$issueId" />
#end
<input type="hidden" name="$moveIssueGroup.ModuleId.key" value="$newModuleId" />
<input type="hidden" name="$moveIssueGroup.IssueTypeId.key" value="$newIssueTypeId" />
<input type="hidden" name="$moveIssueGroup.Action.key" value="$selectAction" />

<div class="functnbar">
#if ($booleanAction)
  <input type="submit" value="$l10n.MoveIssue" name="eventSubmit_doSaveissue" />&#160;
#else
  <input type="submit" value="$l10n.CopyIssue" name="eventSubmit_doSaveissue" />&#160;
#end
  <input type="submit" value="$l10n.Cancel" name="eventSubmit_doBacktoone" />
</div>

#set ($attrValues = $issue.AllAttributeValuesMap)
#set ($attrInput = $intake.AttributeValue.mapTo($attVal))

<h3>$l10n.Destination</h3>
<div class="axial">
<table border="1" cellspacing="2" cellpadding="3">
<tr>
<th>$l10n.DestinationModule</th>
<td> $newModule.Name / $newModule.getRModuleIssueType($newIssueType).DisplayName </td>
</tr>
</table>
</div>

#if (!$matchingAttributes.isEmpty())
<h3>$l10n.AttributesToBeCopied</h3>
<table width="100%" border="1" cellspacing="2" cellpadding="3">
<tr>
<th>$l10n.Attribute</th>
<th>$l10n.InputType</th>
#if (!$isMultiple)
<th>$l10n.Value</th>
#end
</tr>
#foreach ($attr in $matchingAttributes)
  #if (!$isMultiple)
     #set ($attVal=$attr)
     #set ($attr = $attVal.Attribute)
  #end
  #indexedRows($velocityCount)
  #set ($displayValue = $module.getRModuleAttribute($attr, $issueType).getDisplayValue())
  <td>
    #if ($displayValue)
     $attr.Name
     #if (!$attr.Attribute.Name.equals($displayValue))
      ($displayValue)
     #end
    #else
     $l10n.format("IssueAttributeValueActive", $attr.Name)
    #end
    </td>
<td>$attr.AttributeType.Name</td>
#if (!$isMultiple)
<td>$attVal.Value</td>
#end
</tr>
#end
</table>
#end

#if (!$orphanAttributes.isEmpty())
<h3>$l10n.AttributesThatDoNotExist</h3>
<div class="colbar">$l10n.IncludedAsComment</div>
<table width="100%" border="1" cellspacing="2" cellpadding="3">
<tr>
<th>$l10n.Select</th>
<th>$l10n.Attribute</th>
<th>$l10n.InputType</th>
#if (!$isMultiple)
<th>$l10n.Value</th>
#end
</tr>
#foreach($attr in $orphanAttributes)
  #if (!$isMultiple)
     #set ($attVal=$attr)
     #set ($attr = $attVal.Attribute)
  #end
#indexedRows($velocityCount)
<td><input type="checkbox" name="comment_attr_ids_$attr.AttributeId" checked="checked" /></td>
    <td>$attr.Name 
     #set ($displayValue = $module.getRModuleAttribute($attr, $issueType).getDisplayValue())
     #if (!$attr.Name.equals($displayValue))
      ($displayValue)
     #end
    </td>
<td>$attr.AttributeType.Name</td>
#if (!$isMultiple)
<td>$attVal.Value</td>
#end
</tr>
#end
</table>
#end

<div class="axial">
<table cellpadding="3" cellspacing="2" border="0">
<tr>
<th>*$l10n.ReasonForChange</th>
<td>$l10n.CopyChangeHistory 
     <p><textarea rows="4" cols="60" name ="reason"></textarea></p>
</td>
</tr>
</table>
</div>

<div class="functnbar2">
#if ($booleanAction)
  <input type="submit" value="$l10n.MoveIssue" name="eventSubmit_doSaveissue" />&#160;
#else
  <input type="submit" value="$l10n.CopyIssue" name="eventSubmit_doSaveissue" />&#160;
#end
  <input type="submit" value="$l10n.Cancel" name="eventSubmit_doBacktoone" />
</div>

$intake.declareGroups()
</form>

#end

</div>
