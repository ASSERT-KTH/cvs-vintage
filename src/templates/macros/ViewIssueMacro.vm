
#macro (viewIssue $currentIssue )
    #set ($module = $scarabR.CurrentModule)
    #set ( $canEdit = $security.hasPermission("Issue | Edit", $module) )
    #set ($attrValues = $currentIssue.ModuleAttributeValuesMap)
       #datatitle ("Issue ID #$currentIssue.UniqueId")
      <div class="axial">
       <table cellpadding="3" cellspacing="2" border="0">
        <tr>
         <th width="120">Issue ID #</th>
         <td>#$currentIssue.UniqueId</td>
        </tr>
#foreach ( $attKey in $attrValues.sequence() )
  #set ( $attVal = $attrValues.get($attKey))
  #set ( $attrInput = $intake.AttributeValue.mapTo($attVal) )
  #if ( $attVal.Attribute.AttributeType.ValidationKey )
        #set ( $field = $attVal.Attribute.AttributeType.ValidationKey )
  #elseif ($attVal.Attribute.AttributeType.Name == "combo-box" )
        #set ( $field = "OptionId" )
  #else
        #set ( $field = "Value" )
  #end
  #if( $canEdit )
         <tr>
          <th width="120">$attVal.Attribute.Name</th>
          <td>
    #if ($attVal.Attribute.AttributeType.Name == "combo-box" )
        #attrValueLeafSelect ($attVal $field "")
        #attrValueErrorMsg ( $attVal $field )
    #else
        #attrValueErrorMsg( $attVal "Value" )
        #if ($attVal.Attribute.AttributeType.Name == "long-string" )
            <textarea name="$attrInput.Value.Key" cols="40"
               rows="5">$!attrInput.Value</textarea>
        #else
           <input name= "$attrInput.Value.Key"
                value="$!attrInput.Value" size="20" type="text" />
        #end
    #end
          </td>
         </tr>
  #else
    #if ($attVal.isSet())
         <tr>
          <th width="120">$attVal.Attribute.Name</th>
          <td>
       #set ( $attrInput = $intake.AttributeValue.mapTo($attVal) )
       #if ($attVal.Attribute.AttributeType.Name == "combo-box" )
          $!attVal.AttributeOption.Name
       #else
          $!attrInput.Value
       #end
    #end
          </td>
         </tr>
  #end
#end
#if ( $canEdit )
         <tr>
           <th>Comment</th>
           <td>
        #set( $attCommentGroup = $intake.Attachment.setKey("attCommentKey") )
         #fieldErrorMsg($attCommentGroup.DataAsString "<br />")
           <textarea rows="4" cols="35" name ="$attCommentGroup.DataAsString.Key">$!attCommentGroup.DataAsString.Value</textarea>
           <input type="hidden" name="$attCommentGroup.Name.Key" value="comment" />
           <p>
Please add a comment to explain your change(s)
</p>
</td>
        </tr>
        <tr>
           <td>&nbsp;</td> <td><input type="submit" value="edit attributes" name="eventSubmit_doSubmitattributes" /></td>
         </tr>
#end
        </table>
       </div>
### ASSIGNEES
      <h3>Personnel</h3>
      <div class="axial">
       <table cellpadding="3" cellspacing="2" border="0">
        <tr>
         <th width="120">Committed by</th>
        #set ($createdUser = $currentIssue.CreatedBy)
         <td><a href="mailTo:$createdUser.Email">$createdUser.UserName</a></td>
        </tr>
        <tr>
         <th width="120">Assignee(s)</th>
         <td>
   #if ( $currentIssue.AssigneeAttributeValues.isEmpty() )
         None assigned.
   #else
        #foreach ($assignee in $currentIssue.AssigneeAttributeValues)
          #if( $velocityCount == $currentIssue.AssigneeAttributeValues.size() )
              #set( $comma = "")
          #else
              #set( $comma = ",")
          #end
          #set ($assignedUser = $scarabR.getUser($assignee.UserId) )
          #<a href="mailto:$assignedUser.Email">$assignedUser.UserName</a>$comma
        #end
    #end
         </td>
        </tr>
        #if ($canEdit)
        <tr>
        <td>&nbsp;</td>
          <td>
            <input type="submit" value="edit assignees" name="eventSubmit_doEditassignees" />
          </td>
        </tr>
        #end
       </table>
      </div>
## URLS
#if (!$currentIssue.Urls.isEmpty() || $canEdit)
       #datatitle ("Related Links")
        <table width="100%" border="1" cellspacing="2" cellpadding="3">
         <tr>
          <th><img src="/scarab/images/icon_uparrow.gif" width="13" height="8" alt="sort ascending" title="sort ascending" border="0" />
              <img src="/scarab/images/icon_downarrow.gif" width="13" height="8" alt="sort descending" title="sort descending" border="0" />
          </th>
          <th>URL</th>
          <th>Description</th>
         </tr>
    #foreach($url in $currentIssue.Urls)
         #if( $velocityCount % 2 > 0 )
            <tr class="a">
         #else
            <tr class="b">
         #end
          <td>
          #if ($canEdit)
            <input type="checkbox" name="url_delete_$url.AttachmentId" />
          #else
            &nbsp;
          #end
          </td>
          <td><input type="text" size="25" value="$url.Name" /> </td>
          <td><input type="text" size="25" value="$url.DataAsString" /></td>
         </tr>
    #end
    #if ($canEdit)
         <tr>
          <td><strong>Add url:</strong></td>
#set( $urlGroup = $intake.Attachment.setKey("urlKey") )
          <td>
         #fieldErrorMsg($urlGroup.Name "<br />")
         <input type="text" size="25" name="$urlGroup.Name.Key" value="$!urlGroup.Name" />
         </td>
          <td>
         #fieldErrorMsg($urlGroup.DataAsString "<br />")
         <input type="text" size="25" name="$urlGroup.DataAsString.Key" value="$!urlGroup.DataAsString" />
          </td>
         </tr>
    #end
        </table>
    #if ($canEdit)
           <p><input type="submit" value="Add url" name="eventSubmit_doSubmiturl"  />&#160;<input type="submit" value="Delete url"  name="eventSubmit_doDeleteurl" /></p>
    #end
#end
## ADD DEPENDENCY
#if ($canEdit)
#set( $dependGroup = $intake.Depend.setKey("dependKey") )
<input type="hidden" name="$dependGroup.ObserverId.Key" value="$currentIssue.IssueId" />
#datatitle ("Add Dependency")
 #if (!$dependGroup.ObservedId.Message.equals(""))
 <p><strong class="alert">$dependGroup.ObservedId.Message</strong></p>
 #end
 #if (!$dependGroup.TypeId.Message.equals(""))
 <p><strong class="alert">$dependGroup.TypeId.Message</strong></p>
 #end
<div class="axial">
 <table cellspacing="2" cellpadding="3" border="0">
<tr>
  <th>Add dependency on issue #</th>
  <td><input type="text" size="3" name="$dependGroup.ObservedId.Key" value = "$!dependGroup.ObservedId" />
<p><select name="$dependGroup.TypeId.Key" class="select">
    <option value="0">Choose dependency type</option>
    #foreach ($dependType in $currentIssue.getAllDependencyTypes())
      <option value="$dependType.DependTypeId">
          $dependType.Name</option>
    #end
  </select></p>
    </td>
 </tr>
<tr><td>&nbsp;</td><td><input type="submit" value="Add dependency"  name="eventSubmit_doAdddependency" /></td></tr>
</table>
</div>
#end
</div>
## PARENT ISSUES
#if (!$currentIssue.Parents.isEmpty() )
      #datatitle ("Parent Issues")
        <table width="100%" border="1" cellspacing="2" cellpadding="3">
         <tr>
          <th width="20%">issue id#</th>
          <th width="40%">issue summary</th>
          <th>dependency type</th>
         </tr>
       #foreach( $parent in $currentIssue.Parents )
         #if( $velocityCount % 2 > 0 )
            <tr class="a">
         #else
            <tr class="b">
         #end
          <td><a href="$link.setPage("ViewIssue.vm").addPathInfo("id", $parent.IssueId)">$parent.UniqueId</a></td>
             #set ($parentAttrValues = $parent.AllAttributeValuesMap)
             #set ($attVal = $parentAttrValues.get("SUMMARY"))
          <td>
            <a href="$link.setPage("ViewIssue.vm").addPathInfo("id", $parent.IssueId)">$attVal.Value</a>
          </td>
          <td>
   #if ($canEdit)
        <select name="parent_depend_type_id_$parent.IssueId" class="select">
            #foreach ($dependType in $currentIssue.getAllDependencyTypes())
              #set ( $selected = "" )
              #if ( $parent.getDependency($currentIssue).TypeId.equals($dependType.DependTypeId))
                #set ( $selected = " selected" )
              #end
              <option$selected value="$dependType.DependTypeId">
                  $dependType.Name</option>
            #end
              <option value="none">remove dependency </option>
        </select>
   #else
         $parent.getDependency($currentIssue).DependType.Name
   #end
          </td>
         </tr>
       #end
        </table>
#if ($canEdit)
       <p><input type="submit"  name="eventSubmit_doUpdateparent" value="update parent issue" /></p>
#end
#end
## CHILD ISSUES
#if (!$currentIssue.Children.isEmpty() )
       #datatitle ("Child Issues")
        <table width="100%" border="1" cellspacing="2" cellpadding="3">
         <tr>
          <th width="20%">issue id#</th>
          <th width="40%">issue summary</th>
          <th>dependency type</th>
         </tr>
       #foreach( $child in $currentIssue.Children )
         #if( $velocityCount % 2 > 0 )
            <tr class="a">
         #else
            <tr class="b">
         #end
          <td><a href="$link.setPage("ViewIssue.vm").addPathInfo("id", $child.IssueId)">$child.UniqueId</a></td>
          #set ($childAttrValues = $child.AllAttributeValuesMap)
          #set($attVal =  $childAttrValues.get("SUMMARY"))
          <td>
            <a href="$link.setPage("ViewIssue.vm").addPathInfo("id", $child.IssueId)">$attVal.Value</a>
          </td>
           <td>
    #if ($canEdit)
            <select name="child_depend_type_id_$child.IssueId" class="select">
            <option>Choose dependency type</option>
            #foreach ($dependType in $currentIssue.getAllDependencyTypes())
              #set ( $selected = "" )
              #if ( $currentIssue.getDependency($child).TypeId.equals($dependType.DependTypeId) )
                #set ( $selected = " selected" )
              #end
              <option$selected value="$dependType.DependTypeId">
                  $dependType.Name</option>
            #end
            <option value="none">remove dependency </option>
   #else
         $currentIssue.getDependency($child).DependType.Name
   #end
        </select>
          </td>
         </tr>
       #end
        </table>
    #if ( $canEdit )
       <p><input type="submit" value="update child issue"  name="eventSubmit_doUpdatechild" />
    #end
#end
#if (!$currentIssue.Comments.isEmpty() || $canEdit)
## COMMENTS
<h3>Comments</h3>
      <div class="axial">
       <table cellpadding="3" cellspacing="2" border="0">
    #foreach($comment in $currentIssue.Comments)
        <tr>
         <th width="60">$format.getDate($scarabG.DateFormat, $comment.CreatedDate)
       #set ( $commentUser = $scarabR.getUser($comment.CreatedBy) )
         <a href="mailto:$commentUser.Email">$commentUser.FirstName $commentUser.LastName</a>
         </th>
         <td>
         #if ($security.hasPermission("Module | Edit"))
           <textarea rows="2" cols="35" name="edit_comment_$comment.AttachmentId">$comment.DataAsString</textarea>
         #else
           $comment.DataAsString
         #end</td>
        </tr>
    #end
    #if ( $canEdit )
         <tr>
          <th>Add comment</td>
          <td>
        #set( $commentGroup = $intake.Attachment.setKey("commentKey") )
        #fieldErrorMsg($commentGroup.DataAsString "<br />")
           <textarea rows="2" cols="35" name ="$commentGroup.DataAsString.Key"></textarea>
           <input type="hidden" name="$commentGroup.Name.Key" value="comment" />
          </td>
         </tr>
         <tr>
         <td>&nbsp;</td>
         <td>
           <input type="submit" value="Add comment" name="eventSubmit_doSubmitcomment" />&#160;
         #if ($security.hasPermission("Module | Edit"))
           <input type="submit" value="edit comment(s)" name="eventSubmit_doEditcomment" />
         #end
         </td>
    #end
        </table>
       </div>
#end
#if ($fullHistory.equals("true"))
  #set( $activity = $currentIssue.getActivity(true) )
#else
  #set( $activity = $currentIssue.getActivity(false) )
#end
#if (!$activity.isEmpty() )
## ISSUE HISTORY
       #datatitle ("Issue History (up to first ten)")
        <table width="100%" cellpadding="3" cellspacing="2" border="1">
         <tr>
          <th width="120">date stamp</th>
          <th>action</th>
          <th>note</th>
         </tr>
       #foreach( $act in $activity )
         #if( $velocityCount % 2 > 0 )
            <tr class="a">
         #else
            <tr class="b">
         #end
          <td width="120">
            #if( $act.Transaction)
              $format.getDate($scarabG.DateFormat, $act.Transaction.CreatedDate)
            #end
          </td>
          <td width="120">$act.Description
#*
             #if (!$act.OldValue.equals(""))
                  from '$act.OldValue'
             #end
             #if (!$act.NewValue.equals(""))
                  to '$act.NewValue'
             #end
*#
          </td>
          <td>
             #if ($act.Transaction.Attachment)
             $act.Transaction.Attachment.DataAsString
             #else &nbsp; #end
          </td>
         </tr>
       #end
        </table>
#if ($currentIssue.isHistoryLong())
   #if ($fullHistory.equals("true"))
        #set ( $historyLink = $link.setPage("ViewIssue.vm").addPathInfo("id", $currentIssueId).addPathInfo("fullhistory", "false") )
        <p><a href="$historyLink">hide complete history</a></p>
   #else
        #set ( $historyLink = $link.setPage("ViewIssue.vm").addPathInfo("id", $currentIssueId).addPathInfo("fullhistory", "true") )
        <p><a href="$historyLink">show complete history</a></p>
   #end
#end
#end
#end
