#macro (XMLExportIssuesRender $foo)$foo#end
#if($renderedFromScreen)#XMLExportIssues($issueIdList)#end

#macro (XMLExportIssues $issueIdList)
#set ($module = $scarabR.CurrentModule)
<?xml version="1.0" standalone="no"?>
<!DOCTYPE scarab SYSTEM "$staticLink.setPath("/dtd/scarab-issues.dtd")">
<scarab-issues>
  <module>
    <id>$module.ModuleId</id>
    <parent-id>$module.ParentId</parent-id>
    <name>$module.RealName</name>
    <owner-id>$scarabR.getUser($module.OwnerId).UserName</owner-id>
    <description>$module.Description</description>
    <url>$module.Url</url>
    <domain>$!module.Domain</domain>
    <code>$module.Code</code>
#foreach ($issueId in $issueIdList)
  #set ($issue = $scarabR.getIssue($issueId))
  #if ($issue)
  <issues>
    <issue>
      <id>$issue.IdCount</id>
      <artifact-type>$issue.IssueType.Name</artifact-type>
        <transactions>
        #foreach ($transaction in $issue.Transactions)

          <transaction>
            <id>$transaction.TransactionId</id>
            <type>$transaction.TransactionType.Name</type>
            <committed-by>$scarabR.getUser($transaction.CreatedBy).UserName</committed-by>
            <created-date>
              <format>$sdf.toPattern()</format>
              <timestamp>$sdf.format($transaction.CreatedDate)</timestamp>
            </created-date>
            <activities>
            #foreach ($activity in $transaction.ActivityList)

              <activity>
                <attribute>$scarabR.getAttribute($activity.AttributeId).Name</attribute>
                <old-numeric-value>$activity.OldNumericValue</old-numeric-value>
                <new-numeric-value>$activity.NewNumericValue</new-numeric-value>
                #if ($activity.OldUserId)

                <old-user>$!scarabR.getUser($activity.OldUserId).UserName</old-user>
                #end
                #if ($activity.NewUserId)

                <new-user>$!scarabR.getUser($activity.NewUserId).UserName</new-user>
                #end
                #if ($activity.OldOptionId)

                <old-option>$!scarabR.getAttributeOption($activity.OldOptionId).Name</old-option>
                #end
                #if ($activity.NewOptionId)

                <new-option>$!scarabR.getAttributeOption($activity.NewOptionId).Name</new-option>
                #end
                #if ($activity.OldValue && $activity.OldValue.length() > 0)

                <old-value>$!activity.OldValue</old-value>
                #end
                #if ($activity.NewValue && $activity.NewValue.length() > 0)

                <new-value>$!activity.NewValue</new-value>
                #end

                <description>$activity.Description</description>
              </activity>
            #end

            </activities>
            #set ($attachment = $transaction.Attachment)
            ## this is a hack because we are in a loop and transaction.Attachment returns
            ## null if there is no attachment...so the set statement fails
            #if ($attachment && $attachment.Class.Name != "java.lang.String")

            <attachment>
              <name>$attachment.Name</name>
              <type>$attachment.AttachmentType.Name</type>
              #set ($filePath = $attachment.RelativePath)
              #if ($filePath && $filePath.length() > 0)

              <path>$filePath</path>
              #set ($filePath = "")
            #else
            #set ($fileData = $attachment.DataAsString)
              #if ($fileData && $fileData.length() > 0)

              <data>$fileData</data>
              #set ($fileData = "")
              #end
            #end
        
              <mimetype>$attachment.MimeType</mimetype>
              <created-date>
                <format>$sdf.toPattern()</format>
                <timestamp>$sdf.format($attachment.CreatedDate)</timestamp>
              </created-date>
              <modified-date>
                <format>$sdf.toPattern()</format>
                <timestamp>$sdf.format($attachment.ModifiedDate)</timestamp>
              </modified-date>
              <created-by>$scarabR.getUser($attachment.CreatedBy).UserName</created-by>
              #if ($attachment.ModifiedBy)

              <modified-by>$!scarabR.getUser($attachment.ModifiedBy).UserName</modified-by>
              #end

            </attachment>
              #set ($attachment = "")
            #end

          </transaction>
        #end

        </transactions>

        <dependencies>
        #foreach ($depend in $issue.DependsRelatedByObserverId)

          <dependency>
            <type>$depend.DependType.Name</type>
            <parent>$depend.IssueRelatedByObservedId.FederatedId</parent>
          </dependency>
        #end
        #foreach ($depend in $issue.DependsRelatedByObservedId)

          <dependency>
            <type>$depend.DependType.Name</type>
            <child>$depend.IssueRelatedByObserverId.FederatedId</child>
          </dependency>
        #end

        </dependencies>
    </issue>
  #end

  </issues>
#end

  </module>
</scarab-issues>
#end
