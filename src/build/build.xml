<?xml version="1.0"?>

<!-- ======================================================================= -->
<!-- jBoss build file                                                       -->
<!-- ======================================================================= -->

<project name="jBoss" default="main" basedir="../.." verbose="true">
  <target name="init">
    <taskdef name="xmlbean" classname="com.dreambean.xmlbeans.ant.XMLBeans"/>

    <property name="Name" value="jBoss"/>
    <property name="name" value="jboss"/>
    <property name="version" value="2.0"/>

    <property name="bin.dir" value="${basedir}/bin"/>
    <property name="src.bin.dir" value="${basedir}/src/bin"/>
    <property name="src.dir" value="${basedir}/src/main"/>
    <property name="src.client.dir" value="${basedir}/src/client"/>
    <property name="src.resources" value="${basedir}/src/resources"/>
    <property name="src.deploy.dir" value="${basedir}/src/deploy"/>
    <property name="db.dir" value="${basedir}/db"/>
    <property name="lib.dir" value="${basedir}/lib"/>
    <property name="lib.ext.dir" value="${lib.dir}/ext"/>
    <property name="etc.dir" value="${basedir}/src/etc"/>
    <property name="src.lib.dir" value="${basedir}/src/lib"/>
    <property name="docs.dir" value="${basedir}/src/docs"/>
    <property name="build.dir" value="${basedir}/build"/>
    <property name="build.bin.dir" value="${build.dir}/bin"/>
    <property name="build.lib.dir" value="${build.dir}/lib"/>
    <property name="build.classes.dir" value="${build.dir}/classes"/>
    <property name="build.javadocs.dir" value="${build.dir}/docs/api"/>
    <property name="dist.dir" value="dist"/>

    <property name="classpath" value="${lib.dir}/jmxri.jar;${build.classes.dir};${src.lib.dir}/awt.jar;${lib.dir}/xml.jar;${src.lib.dir}/ejb.jar;${src.lib.dir}/ejxeditor.jar;${src.lib.dir}/jndi.jar;${src.lib.dir}/ejxejb.jar;${src.lib.dir}/jta-spec1_0_1.jar;${src.lib.dir}/jnpserver.jar;${src.lib.dir}/dynaserver.jar;${src.lib.dir}/hsql.jar;${src.lib.dir}/webserver.jar;${src.lib.dir}/idb.jar;${src.lib.dir}/jdbc2_0-stdext.jar;${src.lib.dir}/jpl-util-0_5b.jar"/>
    <property name="packages" value="org.jboss,org.jboss.ejb,org.jboss.util,org.jboss.tm,org.jboss.logging,org.jboss.jdbc,org.jboss.naming,org.jboss.web"/>

    <property name="build.compiler" value="classic"/>
  </target>

  <!-- =================================================================== -->
  <!-- Prepares the build directory                                        -->
  <!-- =================================================================== -->
  <target name="prepare" depends="init">
    <mkdir dir="${build.dir}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Compiles the source code                                            -->
  <!-- =================================================================== -->
  <target name="compile" depends="prepare">
    <mkdir dir="${build.classes.dir}"/>
    <javac srcdir="${src.dir}"
           destdir="${build.classes.dir}"
           classpath="${classpath}"
           debug="on"
           deprecation="off"
           optimize="off"
       includes="org/**"
           excludes="**/activation/**, **/*BeanInfo.java"
    />

    <rmic base="${build.classes.dir}"
          classname="org.jboss.jmx.server.JMXAdaptorImpl"
          stubVersion="1.2"
          classpath="${classpath}"/>

    <rmic base="${build.classes.dir}"
          classname="org.jboss.ejb.plugins.jrmp.server.JRMPContainerInvoker"
          stubVersion="1.2"
          classpath="${classpath}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Create the EJX plugin BeanInfo classes                              -->
  <!-- =================================================================== -->
  <target name="xmlbeans" depends="compile">
    <xmlbean destdir="${build.classes.dir}"
             srcdir="${etc.dir}/beaninfo"
             includes="**"
    />
    <javac srcdir="${build.classes.dir}"
           destdir="${build.classes.dir}"
           classpath="${classpath}"
           debug="on"
           deprecation="off"
           optimize="off"
           includes="**/*BeanInfo.java"
    />
  </target>

  <!-- =================================================================== -->
  <!-- Creates the jar archives                                            -->
  <!-- =================================================================== -->
  <target name="jar" depends="xmlbeans">
    <copydir src="${src.resources}" dest="${build.classes.dir}"/>

    <mkdir dir="${build.bin.dir}"/>
    <jar jarfile="${build.bin.dir}/run.jar"
         basedir="${build.classes.dir}"
         manifest="${etc.dir}/run.mf"
         includes="org/jboss/Main*.*,org/jboss/system/**"
    />

    <mkdir dir="${build.lib.dir}/ext"/>
    <jar jarfile="${build.lib.dir}/ext/jboss.jar"
         basedir="${build.classes.dir}"
         manifest="${etc.dir}/jboss.mf"
         includes="org/jboss/**"
         excludes="org/jboss/Main*,org/jboss/ejb/deployment/**,org/jboss/system/**,org/jboss/ejb/plugins/jaws/deployment/**"
    />

    <mkdir dir="${build.dir}/client"/>
    <jar jarfile="${build.dir}/client/jboss-client.jar"
         basedir="${build.classes.dir}"
         manifest="${etc.dir}/jboss-client.mf"
         includes="org/jboss/ejb/DeploymentException.class,org/jboss/proxy/**,org/jboss/ejb/plugins/jrmp/server/*Stub.class,org/jboss/ejb/plugins/jrmp/interfaces/**,org/jboss/ejb/plugins/jrmp12/interfaces/**,org/jboss/ejb/plugins/jrmp13/interfaces/**,org/jboss/util/SerializableEnumeration.class,org/jboss/util/FastKey.class,org/jboss/system/SecurityAssociation.class,org/jboss/system/SimplePrincipal.class"
    />

    <jar jarfile="${build.dir}/client/deploy.jar"
         basedir="${build.classes.dir}"
         manifest="${etc.dir}/deploy.mf"
         includes="org/jboss/jmx/interfaces/JMXAdaptor.class,org/jboss/jmx/client/Deployer.class,org/jboss/jmx/server/JMXAdaptorImpl_Stub.class"
    />

    <jar jarfile="${build.dir}/client//stop.jar"
         basedir="${build.classes.dir}"
         manifest="${etc.dir}/stop.mf"
         includes="org/jboss/jmx/interfaces/JMXAdaptor.class,org/jboss/jmx/client/Stop.class,org/jboss/jmx/server/JMXAdaptorImpl_Stub.class"
    />
  </target>

  <!-- =================================================================== -->
  <!-- Create the EJX plugin                                               -->
  <!-- =================================================================== -->
  <target name="ejx" depends="xmlbeans">
    <jar jarfile="${build.lib.dir}/ext/ejxjboss.jar"
         basedir="${build.classes.dir}"
         manifest="${etc.dir}/ejxjboss.mf"
         includes="org/jboss/ejb/deployment/**"
    />

    <jar jarfile="${build.lib.dir}/ext/ejxjaws.jar"
         basedir="${build.classes.dir}"
         manifest="${etc.dir}/ejxjaws.mf"
         includes="org/jboss/ejb/plugins/jaws/deployment/**"
    />
  </target>

  <!-- =================================================================== -->
  <!-- Creates the binary structure                                        -->
  <!-- =================================================================== -->
  <target name="main" depends="jar,ejx">
     <mkdir dir="${dist.dir}"/>
     <mkdir dir="${dist.dir}/bin"/>
     <mkdir dir="${dist.dir}/lib/ext"/>
     <mkdir dir="${dist.dir}/db"/>
     <mkdir dir="${dist.dir}/deploy"/>
     <mkdir dir="${dist.dir}/log"/>
     <mkdir dir="${dist.dir}/db"/>
     <mkdir dir="${dist.dir}/conf"/>
     <mkdir dir="${dist.dir}/client"/>

     <copyfile src="${lib.dir}/jmxri.jar" dest="${dist.dir}/lib/jmxri.jar"/>
     <copyfile src="${etc.dir}/jboss.conf" dest="${dist.dir}/conf/jboss.conf"/>
     <copyfile src="${etc.dir}/jboss.jcml" dest="${dist.dir}/conf/jboss.jcml"/>
     <copyfile src="${etc.dir}/log.properties" dest="${dist.dir}/log/log.properties"/>
     <copyfile src="${etc.dir}/db.properties" dest="${dist.dir}/db/db.properties"/>

     <copydir src="${etc.dir}/conf" dest="${dist.dir}/conf"/>
     <copydir src="${src.bin.dir}" dest="${dist.dir}/bin"/>
     <copydir src="${src.lib.dir}" dest="${dist.dir}/lib/ext"/>
     <copydir src="${build.bin.dir}" dest="${dist.dir}/bin"/>
     <copydir src="${build.lib.dir}/ext" dest="${dist.dir}/lib/ext"/>
     <copydir src="${build.dir}/client" dest="${dist.dir}/client"/>
     <copydir src="${src.client.dir}" dest="${dist.dir}/client"/>
     <copydir src="${src.deploy.dir}" dest="${dist.dir}/deploy"/>

     <chmod src="${dist.dir}/bin/run.sh" perm="u+x" />
     <chmod src="${dist.dir}/bin/TestBeanClient.sh" perm="u+x" />
  </target>

  <!-- =================================================================== -->
  <!-- Creates the API documentation                                       -->
  <!-- =================================================================== -->
  <target name="javadocs" depends="prepare">
    <mkdir dir="${build.javadocs.dir}"/>
    <javadoc packagenames="${packages}"
             sourcepath="${src.dir}"
             destdir="${build.javadocs.dir}"
             author="true"
             version="true"
             windowtitle="${Name} API"
             doctitle="${Name}"
             extdirs="${src.lib.dir}"
             bottom="Copyright &#169; 2000 The jBoss Organization. All Rights Reserved."
    />
  </target>

  <!-- =================================================================== -->
  <!-- Creates the distribution                                            -->
  <!-- =================================================================== -->
  <target name="dist" depends="main,jar,javadocs">
     <mkdir dir="${dist.dir}/docs"/>
     <mkdir dir="${dist.dir}/docs/api"/>
     <copydir src="${docs.dir}" dest="${dist.dir}/docs"/>
     <copydir src="${build.javadocs.dir}" dest="${dist.dir}/docs/api"/>

     <mkdir dir="${dist.dir}/src"/>
     <copydir src="${src.dir}" dest="${dist.dir}/src"/>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the distribution with ZIP                                  -->
  <!-- =================================================================== -->
  <target name="dist-zip" depends="dist">
    <zip zipfile="${Name}-${version}.zip" basedir="${dist.dir}" includes="**"/>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the distribution with TAR-GZIP                             -->
  <!-- =================================================================== -->
  <target name="dist-tgz" depends="dist">
    <tar tarfile="${Name}-${version}.tar" basedir="${dist.dir}" includes="**"/>
    <gzip zipfile="${Name}-${version}.tar.gz" src="${Name}-${version}.tar"/>
  </target>

  <!-- =================================================================== -->
  <!-- Cleans up generated stuff                                           -->
  <!-- =================================================================== -->
  <target name="clean" depends="init">
    <deltree dir="${build.dir}"/>
    <deltree dir="${dist.dir}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Total cleanup                                                       -->
  <!-- =================================================================== -->
  <target name="total-clean" depends="clean">
    <delete file="${Name}-${version}.zip"/>
    <delete file="${Name}-${version}.tar"/>
    <delete file="${Name}-${version}.tar.gz"/>
  </target>
</project>
