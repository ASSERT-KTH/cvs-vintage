<project name="source-snapshots" default="tomcat" basedir=".">
   <!-- ******************** Initialization ******************** -->
  <target name="init">
    <tstamp />
    <property name="ws.dir" value="${user.home}/ws" />
    <!-- keep it in sync with jakarta-apache.xml -->
    <property name="nightly.url" value="http://jakarta.apache.org/builds/tomcat/nightly" />
    <property name="dist.dir" value="${user.home}/opt" />
    <property name="tomcat.home" value="${dist.dir}/tomcat" />
    <property name="package.dir" value="${user.home}/public_html" />
    <!-- Allow user to override any of the hardcoded directories -->
    <property file="${user.home}/.ant.properties" />
   </target>

  <target name="clean.zip" depends="init">
     <deltree dir="${ws.dir}/jakarta-tomcat.src.zip" />
     <deltree dir="${ws.dir}/jakarta-tools.src.zip" />
     <deltree dir="${ws.dir}/jakarta-watchdog.src.zip" />
  </target>

  <target name="clean.src" depends="clean.zip">
     <deltree dir="${ws.dir}/jakarta-tomcat" />
     <deltree dir="${ws.dir}/jakarta-watchdog" />
     <deltree dir="${ws.dir}/jakarta-tools" />
  </target>

  <target name="clean" depends="init">
     <deltree dir="${ws.dir}/build" />
     <deltree dir="${ws.dir}/dist" />
     <deltree dir="${dist.dir}/ant" />
     <deltree dir="${dist.dir}/tomcat" />
  </target>

   <!-- ******************** Getting sources ******************** -->
  <target name="tomcat.get" depends="init">
    <get src="${nightly.url}/src/jakarta-tomcat.src.zip" dest="${ws.dir}/jakarta-tomcat.src.zip" />
    <deltree dir="${ws.dir}/jakarta-tomcat" />
    <expand src="${ws.dir}/jakarta-tomcat.src.zip" dest="${ws.dir}" />
  </target>
  
  <target name="tools.get" depends="init">
    <get src="${nightly.url}/src/jakarta-tools.src.zip" dest="${ws.dir}/jakarta-tools.src.zip" />
    <deltree dir="${ws.dir}/jakarta-tools" />
    <expand src="${ws.dir}/jakarta-tools.src.zip" dest="${ws.dir}" />
  </target>

  <target name="watchdog.get" depends="init">
    <get src="${nightly.url}/src/jakarta-watchdog.src.zip" dest="${ws.dir}/jakarta-watchdog.src.zip" />
    <deltree dir="${ws.dir}/jakarta-watchdog" />
    <expand src="${ws.dir}/jakarta-watchdog.src.zip" dest="${ws.dir}" />
  </target>

   <!-- ******************** Building  ******************** -->
  <target name="tomcat" depends="init">
     <ant dir="${ws.dir}/jakarta-tomcat" antfile="${ws.dir}/jakarta-tomcat/build.xml" target="dist" />
     <mkdir dir="${package.dir}/tomcat"/>
     <zip zipfile="${package.dir}/tomcat/tomcat.zip" basedir="${tomcat.home}/.." 
          items="tomcat" />
     <copyfile src="${package.dir}/tomcat/tomcat.zip" dest="${package.dir}/tomcat/tomcat-${os.name}-${DSTAMP}.zip" />
     <copyfile src="${package.dir}/tomcat/tomcat.zip" dest="${package.dir}/tomcat/tomcat-${DSTAMP}.zip" />
  </target>

  <target name="ant" depends="init">
     <ant dir="${ws.dir}/jakarta-tools/ant" antfile="${ws.dir}/jakarta-tools/ant/build.xml" target="dist" /> 
     <mkdir dir="${package.dir}/ant"/>
     <zip zipfile="${package.dir}/ant/ant.zip" basedir="${dist.dir}" items="ant"/>
     <copyfile src="${package.dir}/ant/ant.zip" dest="${package.dir}/ant/ant-${os.name}-${DSTAMP}.zip" />
     <copyfile src="${package.dir}/ant/ant.zip" dest="${package.dir}/ant/ant-${DSTAMP}.zip" />
   </target>

  <target name="moo" depends="init">
     <ant dir="${ws.dir}/jakarta-tools/moo" antfile="${ws.dir}/jakarta-tools/moo/build.xml" target="dist" /> 
   </target>

   <target name="test-build" depends="init">
     <ant dir="${ws.dir}/jakarta-tomcat" antfile="${ws.dir}/jakarta-tomcat/build.xml" target="test" />
   </target>

   <target name="watchdog" depends="init">
     <ant dir="${ws.dir}/jakarta-watchdog" antfile="${ws.dir}/jakarta-watchdog/build.xml" target="dist" />
   </target>

   <!-- ******************** Testing  ******************** -->
   <target name="tomcat-test" depends="init">
     <exec dir="${ws.dir}/build/tomcat/test" command="runtest" output="${package.dir}/tomcat/tomcat-test.log" />
   </target>

   <target name="watchdog-test" depends="init">
     <exec dir="${ws.dir}/build/watchdog" command="runtest" output="${package.dir}/tomcat/watchdog-test.log" />
   </target>

   <target name="test-apache" depends="init">
     <exec dir="${ws.dir}" command="/usr/local/apache/bin/apachectl start" />
     <exec dir="${ws.dir}/build/tomcat/test" command="runtest" output="${package.dir}/tomcat/tomcat-test.log" />
     <exec dir="${ws.dir}/build/watchdog" command="runtest" output="${package.dir}/tomcat/watchdog-test.log" />
     <exec dir="${ws.dir}" command="/usr/local/apache/bin/apachectl stop" />
   </target>


   <!-- ******************** Platform specific packages  ******************** -->
   <target name="pkg" depends="init"> 
     <deltree dir="${ws.dir}/build/ASFtomcat" />
     <exec os="SunOS" dir="${ws.dir}/jakarta-tomcat/src/etc" command="pkgmk -o -f prototype -d ${ws.dir}/build  -r / " />
     <exec os="SunOS" dir="${ws.dir}/build" command="tar cf ASFtomcat.tar ASFtomcat " />
     <exec os="SunOS" dir="${ws.dir}/build" command="compress ASFtomcat.tar " />
     <copyfile src="${ws.dir}/build/ASFtomcat.tar.Z" dest="${package.dir}/tomcat/ASFtomcat.pkg.tar.Z" />

     <deltree dir="${ws.dir}/build/ASFant" />
     <exec os="SunOS" dir="${ws.dir}/jakarta-tools/ant/src/etc" command="pkgmk -o -f prototype -d ${ws.dir}/build  -r / " />
     <exec os="SunOS" dir="${ws.dir}/build" command="tar cf ASFant.tar ASFant " />
     <exec os="SunOS" dir="${ws.dir}/build" command="compress ASFant.tar " />
     <copyfile src="${ws.dir}/build/ASFant.tar.Z" dest="${package.dir}/ant/ASFant.pkg.tar.Z" />

  </target>


  <target name="tomcat.rpm" depends="init"> 
    <copyfile src="${ws.dir}/jakarta-tomcat.src.zip" dest="/usr/src/redhat/SOURCES/jakarta-tomcat.src.zip" />
    <copyfile src="${ws.dir}/jakarta-tools.src.zip" dest="/usr/src/redhat/SOURCES/jakarta-tools.src.zip" />
    <exec os="Linux" dir="${ws.dir}" command="rpm -ba --target noarch ${ws.dir}/jakarta-tomcat/src/etc/tomcat.spec " />
    <copyfile src="/usr/src/redhat/RPMS/noarch/tomcat-3.0-0.noarch.rpm" dest="${package.dir}/tomcat/tomcat-3.0-0.noarch.rpm" />
    <copyfile src="/usr/src/redhat/SRPMS/tomcat-3.0-0.src.rpm" dest="${package.dir}/tomcat/tomcat-3.0-0.src.rpm" />
  </target>

  <target name="ant.rpm" depends="init"> 
    <copyfile src="${ws.dir}/jakarta-tools.src.zip" dest="/usr/src/redhat/SOURCES/jakarta-tools.src.zip" />
    <exec os="Linux" dir="${ws.dir}" command="rpm -ba --target noarch ${ws.dir}/jakarta-tools/ant/src/etc/ant.spec " />
    <copyfile src="/usr/src/redhat/RPMS/noarch/ant-1.0-0.noarch.rpm" dest="${package.dir}/ant/ant-1.0-0.noarch.rpm" />
    <copyfile src="/usr/src/redhat/SRPMS/ant-1.0-0.src.rpm" dest="${package.dir}/ant/ant-1.0-0.src.rpm" />
  </target>

  <target name="rpm"  depends="init,tomcat.rpm,ant.rpm"> 
  </target>

   <!-- ******************** Agregate targets  ******************** -->
  <target name="get.all" depends="init,clean.zip,tomcat.get,tools.get,watchdog.get">
  </target>

  <target name="build" depends="init,ant,moo,tomcat,test-build,watchdog">
  </target>

  <target name="all" depends="init,clean,get.all,build">
  </target>

  <target name="test" depends="init,tomcat-test,watchdog-test">
  </target>
  
</project>

