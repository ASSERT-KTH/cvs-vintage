<?xml version="1.0"?>

<!-- Build file for Scarab -->

<project name="Scarab" default="compile" basedir=".">

    <!-- Give user a chance to override without editing this file
        (and without typing -D each time it compiles it -->
    <property file="${user.home}/.ant.properties" />
    <property file=".ant.properties" />

    <property name="Name" value="Scarab"/>
    <property name="version" value="1.0-dev"/>
    <property name="project" value="scarab"/>
    <property name="final.name" value="${project}-${version}"/>
    <property name="final.dir" value="${basedir}/../${final.name}/"/>

    <property name="build.compiler" value="classic"/>
    <property name="debug" value="on"/>
    <property name="optimize" value="off"/>
    <property name="deprecation" value="off"/>

    <property name="ant.home" value="."/>
    <property name="year" value="2000-2001"/>

    <property name="build.dir.default" value="${basedir}/../target"/>

    <property name="turbine.dir" value="${basedir}/../../jakarta-turbine"/>
    <property name="turbine.latest.jar" 
            value="turbine-2.1-dev-unreleased.jar"/>
    <property name="torque.zip" value="torque.zip"/>
    <property name="src.dir" value="${basedir}/../src"/>
    <property name="src.conf.dir" value="${src.dir}/conf"/>
    <property name="src.html.dir" value="${src.dir}/html"/>
    <property name="src.images.dir" value="${src.dir}/images"/>
    <property name="src.java.dir" value="${src.dir}/java"/>
    <property name="src.lib.dir" value="${basedir}/../lib"/>
    <property name="src.sql.dir" value="${src.dir}/sql"/>
    <property name="src.templates.dir" value="${src.dir}/templates"/>
    <property name="tomcat.dist.dir" value="${src.dir}/tomcat-4.0"/>


    <!-- Build classpath -->
    <path id="classpath">
        <fileset dir="${src.lib.dir}">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <!-- ================================================================== -->
    <!-- Prepares the Build directory properties                            -->
    <!-- ================================================================== -->
    <target name="pre-prepare-build.dir" unless="build.dir">
        <property name="build.dir" value="${build.dir.default}"/>
        <property name="prepare-tomcat-true" value="yes"/>
    </target>
    <target name="prepare-build.dir" depends="pre-prepare-build.dir">
        <property name="build.webapps" value="${build.dir}/webapps"/>
        <property name="build.project" value="${build.webapps}/${project}"/>
        <property name="build.project.webinf" value="${build.project}/WEB-INF"/>
        <property name="build.src.scarab" value="${build.project.webinf}/src"/>
        <property name="build.dest.scarab"
                 value="${build.project.webinf}/classes"/>
        <property name="javadoc.destdir" value="${build.project}/docs"/>
    </target>


    <!-- ================================================================== -->
    <!-- Prepares the Tomcat directory                                      -->
    <!-- ================================================================== -->
    <target name="prepare-tomcat" if="prepare-tomcat-true" 
         depends="prepare-build.dir">

        <echo message="Build Dir: ${build.dir}"/>
        <mkdir dir="${build.dir}"/>

        <!-- copy over tomcat -->
        <copy todir="${build.dir}" filtering="no">
            <fileset dir="${tomcat.dist.dir}/"/>
        </copy>

        <chmod dir="${build.dir}/bin" perm="ug+rx" includes="**/*.sh" />

        <mkdir dir="${build.dir}/logs"/>
        <mkdir dir="${build.dir}/work"/>
        <mkdir dir="${build.dir}/webapps"/>
    </target>

    <!-- ================================================================== -->
    <!-- Prepares the build directory                                       -->
    <!-- ================================================================== -->
    <target name="prepare" depends="prepare-tomcat, prepare-build.dir">

        <!-- things to go into the project directory -->
        <copy todir="${build.project}" filtering="no">
            <fileset dir="${src.html.dir}">
                <include name="**/*.html"/>
                <include name="**/*.css"/>
            </fileset>
        </copy>
        <copy todir="${build.project}/images" filtering="no">
            <fileset dir="${src.images.dir}"/>
        </copy>
        <copy todir="${build.project}/templates" filtering="no">
            <fileset dir="${src.templates.dir}"/>
        </copy>
        <copy todir="${build.project.webinf}" filtering="no">
            <fileset dir="${src.conf.dir}/">
                <include name="web.xml"/>
            </fileset>
        </copy>

        <!-- things to go into the web-inf directory -->
        <copy todir="${build.project.webinf}/conf" filtering="no">
            <fileset dir="${src.conf.dir}/">
                <include name="*.properties"/>
            </fileset>
        </copy>
        <copy todir="${build.project.webinf}/lib" filtering="no">
            <fileset dir="${src.lib.dir}/">
                <exclude name="**/servlet*.jar"/>
                <exclude name="**/stylebook*.jar"/>
                <exclude name="**/torque.zip"/>
                <include name="**/*.jar"/>
            </fileset>
        </copy>

        <!-- the source code directory -->
        <copy todir="${build.src.scarab}/org" filtering="yes">
            <fileset dir="${src.java.dir}/org">
                <include name="**/*.java"/>
                <include name="**/*.properties"/>
                <include name="**/package.html"/>
            </fileset>
        </copy>
        
        <mkdir dir="${build.project}/logs"/>
    </target>


    <!-- ================================================================== -->
    <!-- Build Turbine and Torque if CVS is available                       -->
    <!-- ================================================================== -->
    <target name="check-for-turbine">
        <available property="turbine.cvs.available" 
            file="${turbine.dir}/build/build-turbine.xml"/>
    </target>

    <target name="prepare-turbine" depends="check-for-turbine,prepare" 
            if="turbine.cvs.available">

        <echo message="checking: ${src.lib.dir}/${turbine.latest.jar}"/>
        <uptodate property="turbine.jar.uptodate"
            targetfile="${src.lib.dir}/${turbine.latest.jar}">
            <srcfiles dir="${turbine.dir}/src/java" includes="**/*.java"/>
        </uptodate>

        <echo message="checking: ${src.lib.dir}/${torque.zip}"/>
        <uptodate property="torque.uptodate"
            targetfile="${src.lib.dir}/${torque.zip}">
            <srcfiles dir="${turbine.dir}/conf/torque" includes="**/*"/>
            <srcfiles dir="${turbine.dir}/src/java" includes="**/*.java"/>
        </uptodate>
    </target>

    <target name="skip-turbine" depends="check-for-turbine,prepare" 
            unless="turbine.cvs.available">
        <property name="turbine.jar.uptodate" value="true"/>
        <property name="torque.uptodate" value="true"/>
    </target>

    <target name="build-turbine" depends="skip-turbine"
            unless="turbine.jar.uptodate">
        <echo message="+------------------------------------------+"/>
        <echo message="|                                          |"/>
        <echo message="|           Rebuilding Turbine             |"/>
        <echo message="|                                          |"/>
        <echo message="+------------------------------------------+"/>
        <ant antfile="build-turbine.xml" 
                dir="${turbine.dir}/build" target="jar">
            <property name="build.dir" value="../bin"/>
            <property name="version" value="2.1-dev-unreleased"/>
            <property name="project" value="turbine"/>
            <property name="final.name" value="turbine-2.1-dev-unreleased"/>
            <property name="src.java.dir" value="../src/java"/>
        </ant>
        <copy file="${turbine.dir}/bin/${turbine.latest.jar}" overwrite="true"
            todir="${src.lib.dir}"/>
    </target>

    <target name="build-torque"  depends="prepare-turbine,skip-turbine"
            unless="torque.uptodate">
        <echo message="+------------------------------------------+"/>
        <echo message="|                                          |"/>
        <echo message="|           Rebuilding Torque              |"/>
        <echo message="|                                          |"/>
        <echo message="+------------------------------------------+"/>
        <ant antfile="build-torque.xml" 
                dir="${turbine.dir}/build" target="main">
            <property name="build.dir" value="../bin"/>
            <property name="build.dest" value="../bin/classes"/>
        </ant>
        <copy file="${turbine.dir}/bin/torque.zip" todir="${src.lib.dir}"/>
    </target>

    <target name="torque-init" depends="build-torque">
        <copy file="${src.lib.dir}/torque.zip" todir="${build.src.scarab}"/>
        <unzip src="${build.src.scarab}/torque.zip" 
                dest="${build.src.scarab}" />
        <property name="torque.dir" value="${build.src.scarab}/torque"/>
    </target>

    <!-- ================================================================== -->
    <!-- Generate SQL from Torque                                           -->
    <!-- ================================================================== -->
    <target name="schema-check">
        <echo message="checking: ${src.sql.dir}/scarab-schema.sql"/>
        <uptodate property="schema.uptodate"
            targetfile="${src.sql.dir}/scarab-schema.sql">
            <srcfiles dir="${src.sql.dir}" includes="scarab-schema.xml"/>
        </uptodate>
    </target>

    <target name="sql" depends="schema-check,torque-init" 
            unless="schema.uptodate">
        <ant antfile="torque.xml" 
                dir="${torque.dir}" target="project-sql">
            <property name="project" value="scarab"/>
            <property name="xmlFile" value="${src.sql.dir}/scarab-schema.xml"/>
            <property name="outputDirectory" value="${torque.dir}/output"/>
            <property name="templatePath" value="${torque.dir}/templates"/>
            <property name="database" value="mysql"/>
        </ant>
        <copy file="${torque.dir}/output/${project}-schema.sql" 
              overwrite="true" todir="${src.sql.dir}"/>
    </target>

    <!-- ================================================================== -->
    <!-- Generate OM/Peer classes from Torque                               -->
    <!-- ================================================================== -->
    <target name="generated-check" depends="sql">
        <echo message="checking: ${build.src.scarab}/torque/output/report.scarab.om.generation"/>
        <available property="gen.uptodate"
            file="${build.src.scarab}/torque/output/report.scarab.om.generation"/>
    </target>
<!-- would like to regenerate if schema is updated but will just have to 
     remove target dir on schema update for now
    <target name="generated-check" depends="pre-generated-check"
            unless="gen.uptodate">
        <echo message="checking if schema is up to date"/>
        <property name="gen.uptodate" value="${schema.uptodate}"/>
    </target>
-->
    <target name="om-peer" depends="generated-check" 
            unless="gen.uptodate">

        <echo message="+------------------------------------------+"/>
        <echo message="|                                          |"/>
        <echo message="|        Building OM/Peer classes          |"/>
        <echo message="|                                          |"/>
        <echo message="+------------------------------------------+"/>
        <ant antfile="torque.xml" dir="${torque.dir}" target="project-om">
            <property name="project" value="scarab"/>
            <property name="outputDirectory" value="${torque.dir}/output"/>
            <property name="templatePath" value="${torque.dir}/templates"/>
            <property name="xmlFile" value="${src.sql.dir}/scarab-schema.xml"/>
            <property name="targetPackage" value="org.tigris.scarab"/>
            <property name="basePrefix" value="ZZBase"/>
            <property name="addSaveMethod" value="true"/>
            <property name="addGetByNameMethod" value="true"/>
            <property name="objectModelType" value="complex"/>
        </ant>

        <copy todir="${build.src.scarab}/org" filtering="yes">
            <fileset dir="${torque.dir}/output/org">
                <include name="**/ZZBase*.java"/>
                <include name="**/*.properties"/>
                <include name="**/package.html"/>
            </fileset>
        </copy>

        <antcall target="sql"/>

    </target>


    <!-- ================================================================== -->
    <!-- Compiles the source directory                                      -->
    <!-- ================================================================== -->
    <target name="compile" depends="build-turbine,prepare,om-peer">
        <mkdir dir="${build.dest.scarab}"/>
        <javac srcdir="${build.src.scarab}"
            destdir="${build.dest.scarab}"
            excludes="**/package.html,torque/**"
            debug="${debug}"
            deprecation="${deprecation}"
            optimize="${optimize}">

            <classpath refid="classpath"/>
        </javac>
    </target>

    <!-- ================================================================== -->
    <!-- jars the source directory                                          -->
    <!-- ================================================================== -->
    <target name="jarsrc" depends="prepare">
        <jar jarfile="${build.dir}/${final.name}.src.jar"
            basedir="${build.src.scarab}"
            excludes="**/package.html"/>
    </target>

    <!-- ================================================================== -->
    <!-- Creates the API documentation                                      -->
    <!-- ================================================================== -->
    <target name="javadocs" depends="prepare">
        <mkdir dir="${javadoc.destdir}"/>
        <javadoc
            sourcepath="${build.src.scarab}"
            packagenames="org.tigris.scarab.*"
            destdir="${javadoc.destdir}"
            author="true"
            private="true"
            version="true"
            use="true"
            windowtitle="${Name} ${version} API"
            doctitle="${Name} ${version} API"
            bottom="Copyright &amp;copy; ${year} CollabNet. All Rights Reserved."
        >
            <classpath refid="classpath"/>
    </javadoc>
    </target>

    <!-- ================================================================== -->
    <!-- Package                                                            -->
    <!-- ================================================================== -->
    <!--
    <target name="package" depends="javadocs">
        <mkdir dir="${final.dir}"/>
        <mkdir dir="${final.dir}/src/java"/>

        <copy todir="${final.dir}/src/java">
            <fileset dir="${build.dir}/src"/>
        </copy>

        <copy todir="${final.dir}/build">
            <fileset dir="../build"/>
        </copy>

        <copy todir="${final.dir}/lib">
            <fileset dir="../lib"/>
        </copy>

        <copy file="${build.dir}/${final.name}.jar" 
            tofile="${final.dir}/${final.name}.jar"/>
    </target>
    -->

    <!-- ================================================================== -->
    <!-- Packages the distribution with ZIP                                 -->
    <!-- ================================================================== -->
    <!--
    <target name="package-zip" depends="package">
        <delete file="../${Name}-${version}.zip"/>
        <zip zipfile="../${Name}-${version}.zip" 
             basedir="../" includes="**/${final.name}/**"/>
    </target>
    -->

    <!-- ================================================================== -->
    <!-- Packages the distribution with TAR-GZIP                            -->
    <!-- ================================================================== -->
    <!--
    <target name="package-tgz" depends="package">
        <delete file="../${Name}-${version}.tar"/>
        <delete file="../${Name}-${version}.tar.gz"/>
        <tar tarfile="../${Name}-${version}.tar" 
             basedir="../" includes="**/${final.name}/**"/>
        <gzip zipfile="../${Name}-${version}.tar.gz" 
                  src="../${Name}-${version}.tar"/>
    </target>
    -->

    <!-- ================================================================== -->
    <!-- Packages the distribution with ZIP and TAG-GZIP                    -->
    <!-- ================================================================== -->
    <!--
    <target name="package-all" depends="package-zip, package-tgz">
    </target>
    -->

    <!-- ================================================================== -->
    <!-- Same as package-all. It is just here for compatibility.            -->
    <!-- ================================================================== -->
    <!--
    <target name="dist" depends="package-all">
    </target>
    -->
    
    <!-- ================================================================== -->
    <!-- Cleans up the build directory                                      -->
    <!-- ================================================================== -->
    <target name="clean" depends="prepare-build.dir">
        <delete dir="${build.project}"/>
    </target>
    <target name="clean-all" depends="prepare-build.dir">
        <delete dir="${build.dir}"/>
    </target>

</project>



