<?xml version="1.0"?>

<!-- Build file for Scarab -->

<project name="Scarab" default="compile" basedir=".">

    <!-- Allow the user to have multiple configuration files and
         specify them using -Dconfiguration.file=filename 
    	 By default we load build.properties.     
    -->         
    <property name="configuration.file" value="build.properties"/> 
    <property file="${basedir}/${configuration.file}" />    

    <!-- Give user a chance to override without editing this file
         (and without using -D arguments each time they build) -->
    <property file="${user.home}/scarab.build.properties" /> 
    <property file="${user.home}/build.properties" />

    <property file="${basedir}/default.properties" />
    <property file="${basedir}/default.${scarab.database.type}.properties" />

    <property name="ant.home" value=".."/>

    <property name="final.name" value="${project}-${version}"/>
    <property name="final.dir" value="${basedir}/../${final.name}/"/>

    <property name="src.conf.dir" value="${src.dir}/conf"/>    
    <property name="src.java.dir.scarab" value="${src.dir}/java"/>
    <property name="src.sql.dir" value="${src.dir}/sql"/>
    <property name="src.templates.dir" value="${src.dir}/templates"/>
    <property name="src.test.dir" value="${src.dir}/test"/>
    
    <property name="torque.dir.scarab" value="${basedir}/../target/torque"/>
    <property name="torque.java.dir" value="${build.src.scarab}/torque"/>
    
    <property name="torquedoc.destdir" value="${basedir}/target/torquedoc"/>
    <property name="scarab.war.file.dir" value="${build.webapps}"/>
    <property name="scarab.war.file.name" value="scarab.war"/>
    <property name="scarab.war.file" value="${scarab.war.file.dir}/${scarab.war.file.name}"/>

    <property name="extensions.lib.dir" value="${extensions.dir}/usermods/lib"/>
    <property name="extensions.templates.dir" value="${extensions.dir}/usermods/templates"/>
    <property name="extensions.conf.dir" value="${extensions.dir}/usermods/conf"/>

    <!-- Build classpath -->
    <path id="classpath">
        <fileset dir="${lib.dir}">
            <include name="**/*.jar"/>
            <exclude name="**/xalan*.jar"/>
        </fileset>
        <fileset dir="${ant.home}/lib">
            <include name="**/ant*.jar"/>
        </fileset>
        <fileset dir="${basedir}/../www/repository">
            <include name="**/**.jar"/>
        </fileset>
    </path>

    <!-- ================================================================== -->
    <!-- Prepares the Build directory                                       -->
    <!-- ================================================================== -->
    <target name="prepare-build-dir">

        <echo message="Build Dir: ${build.dir}"/>
        <mkdir dir="${build.dir}"/>
        <tstamp/>
    <echo>
  _________                         ___.    
 /   _____/ ____ _____ ____________ \_ |__  
 \_____  \_/ ___\\__  \\_  __ \__  \ | __ \ 
 /        \  \___ / __ \|  | \// __ \| \_\ \
/_______  /\___  >____  /__|  (____  /___  /
        \/     \/     \/           \/    \/ 

        [${version}-${DSTAMP}${TSTAMP}]
    </echo>


    </target>


    <!-- ================================================================== -->
    <!-- Prepares the build directory                                       -->
    <!-- ================================================================== -->
    <target name="prepare">

        <!-- things to go into the project directory -->
        
        <copy todir="${build.project}" filtering="yes">
            <fileset dir="${src.dir}/webapp">
                <include name="**/*.*"/>
            </fileset>
        </copy>
        
        <copy todir="${build.project.webinf}/conf" filtering="yes">
            <fileset dir="${src.dir}/conf/conf">
                <include name="**/*.*"/>
            </fileset>
        </copy>        

        <!-- Conditionally copy templates -->
        <antcall target="copy-templates" />
   

        <!-- Conditionally copy extension conf -->
        <available property="extensions.conf.exist" 
            file="${extensions.conf.dir}"/>
        <antcall target="copy-conf-extensions"/>
<!--
        <condition property="template.path" value="/WEB-INF">
            <equals arg1="${scarab.copy.templates}" arg2="true"/>
        </condition>
        <condition property="template.path" value="file://${src.dir}">
            <not>
                <equals arg1="${scarab.copy.templates}" arg2="true"/>
            </not>
        </condition>
-->
        <!-- add custom template folders -->
<!--        
        <available property="template.path" 
                      value="file://${scarab.template.path},${template.path}"
                       type="dir" file="${scarab.template.path}" />
-->
        <!-- things to go into the web-inf directory -->
        <filter token="VERSION" value="${version}"/>
        <tstamp/>
        <filter token="BUILD_DATE" value="${DSTAMP}${TSTAMP}"/>
       

        <filter token="DATABASE_TYPE" value="${scarab.database.type}"/>
        <filter token="DATABASE_DRIVER" value="${scarab.database.jdbc.driver}"/>
        <filter token="DATABASE_URL" value="${scarab.database.url}"/>
        <filter token="DATABASE_HOST" value="${scarab.database.host}"/>
        <filter token="DATABASE_PORT" value="${scarab.database.port}"/>
        <filter token="DATABASE_USERNAME" value="${scarab.database.username}"/>
        <filter token="DATABASE_PASSWORD" value="${scarab.database.password}"/>


        <copy todir="${build.project.webinf}/lib" filtering="no" flatten="true">
            <fileset dir="${lib.dir}/">
                <exclude name="**/servlet*.jar"/>
                <exclude name="**/xalan*.jar"/>  
                <include name="**/*.jar"/>
            </fileset>
            <fileset dir="${basedir}/../www/repository">
            	<include name="**/**.jar"/>
	        </fileset>
        </copy>

        <!-- Conditionally copy extension libraries -->
        <available property="extensions.lib.exist" 
            file="${extensions.lib.dir}"/>
        <antcall target="copy-lib-extensions"/>

        <echo>Using ${scarab.database.type} JDBC driver from:
    ${lib.dir}/${scarab.jdbc.driver.jar}
        </echo>
        <copy todir="${build.project.webinf}/lib" filtering="no"
              preservelastmodified="yes">
            <fileset dir="${lib.dir}/">
                <include name="**/${scarab.jdbc.driver.jar}"/>
            </fileset>
        </copy>

        <!-- clean out any accidentally left over generated .sql 
             files which should not be in the src.sql.dir -->
        <delete file="${src.sql.dir}/${project}-schema.sql" quiet="true" />
        <delete file="${src.sql.dir}/turbine-schema.sql" quiet="true" />
        <delete file="${src.sql.dir}/scheduler-schema.sql" quiet="true" />
        <delete file="${src.sql.dir}/id-table-schema.sql" quiet="true" />

        <!-- the SQL data population scripts directory -->
        <copy todir="${build.sql.scarab}" filtering="yes">
            <fileset dir="${src.sql.dir}">
                <include name="**/*.sql"/>
                <include name="**/*.sh"/>
                <include name="**/*.lst"/>
                <include name="**/dbsettings.props"/>
            </fileset>
        </copy>
        <chmod perm="+x">
            <fileset dir="${src.sql.dir}" includes="**/*.sh"/>
            <fileset dir="${build.sql.scarab}" includes="**/*.sh"/>
        </chmod>

        <!-- express the type of database we are generating -->
        <touch>
          	<fileset dir="${build.sql.scarab}/${scarab.database.type}">
                <include name="**/*.*"/>
            </fileset>  
        </touch>

    </target>

    <!-- conditional file copy used in prepare target-->
    <target name="copy-conf-extensions" if="extensions.conf.exist">
        <copy todir="${build.project.webinf}" filtering="yes"
              overwrite="true"
              verbose="true">
            <fileset dir="${extensions.conf.dir}/">
                <include name="web.xml"/>
                <include name="server-config.wsdd"/>
            </fileset>
        </copy>
    </target>
    <target name="copy-lib-extensions" if="extensions.lib.exist">
        <copy todir="${build.project.webinf}/lib" filtering="no"
              overwrite="true"
              verbose="true">
            <fileset dir="${extensions.lib.dir}/">
                <include name="**/*.jar"/>
            </fileset>
        </copy>
    </target>

    <!-- ================================================================== -->
    <!-- Copies templates to WEB-INF directory, if specified                -->
    <!-- ================================================================== -->
    <target name="copy-templates" if="scarab.copy.templates">
        <copy todir="${build.project.webinf}/templates" filtering="no">
            <fileset dir="${src.templates.dir}"/>
        </copy>
        <available property="extension.templates.exist" 
            file="${extensions.templates.dir}"/>
        <antcall target="copy-template-extensions"/>
    </target>

    <target name="copy-template-extensions" if="extension.templates.exist">
        <copy todir="${build.project.webinf}/templates" filtering="no"
              overwrite="true"
              verbose="true">
            <fileset dir="${extensions.templates.dir}"/>
        </copy>
    </target>

    <!-- ================================================================== -->
    <!-- Copy all of the xml schema files into the torque directory         -->
    <!-- ================================================================== -->
    <target name="torque-copy-all-schema"
            unless="schema.uptodate">
        <!-- copy the schema's to the torque directory -->
        <copy file="${src.sql.dir}/${project}-schema.xml" 
              todir="${torque.dir.scarab}/schema"
              filtering="true" overwrite="true"/>
        <copy file="${src.sql.dir}/id-table-schema.xml" 
              todir="${torque.dir.scarab}/schema"
              filtering="true" overwrite="true"/>
        <copy file="${src.sql.dir}/turbine-schema.xml" 
              todir="${torque.dir.scarab}/schema"
              filtering="true" overwrite="true"/>
        <copy file="${src.sql.dir}/scheduler-schema.xml" 
              todir="${torque.dir.scarab}/schema"
              filtering="true" overwrite="true"/>
    </target>

    <!-- ================================================================== -->
    <!-- Check to see if SQL related stuff is up to date                    -->
    <!-- ================================================================== -->
    <target name="schema-check">
        <echo message="checking: ${build.sql.scarab}/${project}.sql"/>
        <uptodate property="schema.uptodate"
            targetfile="${build.sql.scarab}/mysql/${project}.sql">
            <srcfiles dir="${src.sql.dir}" includes="turbine-schema.xml"/>
            <srcfiles dir="${src.sql.dir}" includes="id-table-schema.xml"/>
            <srcfiles dir="${src.sql.dir}" includes="scheduler-schema.xml"/>
            <srcfiles dir="${src.sql.dir}" includes="${project}-schema.xml"/>
            <srcfiles dir="${user.home}" includes="scarab.build.properties"/>
            <srcfiles dir="${user.home}" includes="build.properties"/>
            <srcfiles dir="${basedir}" includes="${configuration.file}"/>
        </uptodate>
    </target>

    <!-- ================================================================== -->
    <!-- Generate SQL from Torque                                           -->
    <!-- ================================================================== -->
    <!-- Temporarily replaced by sql-specific-db -->
    <target name="sql-OFF" depends="prepare-build-dir,schema-check,torque-copy-all-schema" 
            unless="schema.uptodate">

        <filter token="DATABASE_TYPE" value="${scarab.database.type}"/>
        <filter token="DATABASE_URL" value="${scarab.database.url}"/>
        <filter token="DATABASE_ADMIN_URL" 
                value="${scarab.database.admin.url}"/>
        <filter token="DATABASE_DRIVER" value="${scarab.database.jdbc.driver}"/>
        <filter token="DATABASE_PASSWORD" value="${scarab.database.password}"/>
        <!-- copy the scarab specific build.properties over -->
        <copy file="${src.conf.dir}/torque.props" 
              tofile="${torque.dir.scarab}/build.properties"
              filtering="true" overwrite="true"/>

        <!-- move the generated .sql files into the target directory -->
        <ant antfile="build-torque.xml"
             target="sql"
             inheritAll="false">
            <!-- See the Torque tasks' build.properties for options -->
            <property name="torque.home" value="${torque.dir.scarab}"/>
            <property name="lib.dir" value="${lib.dir}"/>
            <property name="torque.output.dir" value="${src.dir}"/>
            <property name="build.properties"
                      value="${torque.dir.scarab}/build.properties"/>
            <property name="idTableXMLFile" value=""/>
        </ant>

        <move file="${src.sql.dir}/${project}-schema.sql"
            tofile="${build.sql.scarab}/${project}.sql"/>
        <move file="${src.sql.dir}/turbine-schema.sql"
            tofile="${build.sql.scarab}/turbine.sql"/>
        <move file="${src.sql.dir}/scheduler-schema.sql"
            tofile="${build.sql.scarab}/scheduler.sql"/>
        <move file="${src.sql.dir}/id-table-schema.sql"
            tofile="${build.sql.scarab}/id-table.sql"/>
    </target>

    <!-- ================================================================== -->
    <!-- Generate OM/Peer classes from Torque                               -->
    <!-- ================================================================== -->
    <target name="generated-check" depends="prepare">
        <echo message="checking: ${src.java.dir.scarab}/report.scarab.om.generation"/>
        <uptodate property="gen.uptodate"
            targetfile="${src.java.dir.scarab}/report.scarab.om.generation">
            <srcfiles dir="${src.sql.dir}"
                      includes="${scarab.torque.schemas}"/>
        </uptodate>
    </target>

    <target name="om-peer-generate" depends="generated-check,sql-all" 
            unless="gen.uptodate">

        <!-- we don't want to generate the OM objects for Turbine 
             tables because they already exists in the fulcrum.jar -->
        <delete file="${torque.dir.scarab}/schema/turbine-schema.xml"/>
        <delete file="${torque.dir.scarab}/schema/scheduler-schema.xml"/>

        <ant antfile="build-torque.xml"
                target="om" inheritAll="false">
            <property name="torque.home" value="${torque.dir.scarab}"/>
            <property name="lib.dir" value="${build.project.webinf.lib}"/>
            <property name="build.properties" value="${torque.dir.scarab}/build.properties"/>
        </ant>

    </target>

    <target name="om-peer" depends="om-peer-generate" 
            unless="gen.uptodate">
    </target>


    <!-- ================================================================== -->
    <!-- Check for databases that could require alternate or more complex   -->
    <!-- methods for schema creation                                        -->
    <!-- ================================================================== -->
    <target name="db-type-check">
        <condition property="auto.create.db">
        <not>
            <or>
                <equals arg1="${scarab.database.type}" arg2="oracle"/>
                <equals arg1="${scarab.database.type}" arg2="db2"/>
                <equals arg1="${scarab.database.type}" arg2="mssql"/>
                <equals arg1="${scarab.database.type}" arg2="hypersonic"/>
            </or>
        </not>
        </condition>
    </target>

    <!-- ================================================================== -->
    <!-- Test to make sure the database connection works                    -->
    <!-- ================================================================== -->
    <target name="test-db-connection" depends="sql-all">
        <echo message="Connecting to ${scarab.database.type} at ${scarab.database.url}"/>
        <sql
            driver="${scarab.database.jdbc.driver}"
            url="${scarab.database.url}"
            userid="${scarab.database.username}"
            password="${scarab.database.password}">
            <classpath refid="classpath"/>
        CREATE TABLE scarab_test (
          scarab_test integer
        );
        drop table scarab_test;
        </sql>
    </target>

    <!-- ================================================================== -->
    <!-- Create database if not bypassed in "db-type-check"                 -->
    <!-- ================================================================== -->
    <target name="create-db-schema" depends="db-type-check,sql-all,prepare" 
            if="auto.create.db">

        <copy file="${src.sql.dir}/create-${scarab.database.type}-db.sql" 
              todir="${build.src.scarab}"
              filtering="true" overwrite="true"/>
        <echo message="Connecting to ${scarab.database.type} at ${scarab.database.admin.url}"/>
        <sql
            driver="${scarab.database.jdbc.driver}"
            url="${scarab.database.admin.url}"
            userid="${scarab.database.admin.username}"
            password="${scarab.database.admin.password}">
            <classpath refid="classpath"/>
            <transaction 
                src="${build.src.scarab}/create-${scarab.database.type}-db.sql"/>
        </sql>

    </target>

    <!-- ================================================================== -->
    <!-- Load default data                                                  -->
    <!-- ================================================================== -->
    <target name="load-default-data" depends="create-db-schema">

        <property name="file.prefix" value="${build.sql.scarab}/"/>

        <!-- Oracle does not have any type of conditional execution    -->
        <!-- of "drop table".  So when running the table creation,     -->
        <!-- it fails when dropping a table.  Rather than setting the  -->
        <!-- onerror of the actual creation class to "continue", this  -->
        <!-- pre-creates dummy tables (ignoring any errors if the      -->
        <!-- tables already exist) so that they can be dropped.        -->
        <sql
            rdbms="oracle"
            onerror="continue"
            driver="${scarab.database.jdbc.driver}"
            url="${scarab.database.url}"
            userid="${scarab.database.admin.username}"
            password="${scarab.database.admin.password}">
            <classpath refid="classpath"/>
            <transaction 
                src="${file.prefix}prepare-dummy-tables.sql"/>
        </sql>


        <echo message=
            "Connecting to ${scarab.database.type} at ${scarab.database.url}"/>
        <sql
            driver="${scarab.database.jdbc.driver}"
            url="${scarab.database.url}"
            userid="${scarab.database.admin.username}"
            password="${scarab.database.admin.password}">
            <classpath refid="classpath"/>
            <transaction src="${file.prefix}standard-${scarab.database.type}-init.sql"/>

            <transaction src="${file.prefix}${scarab.database.type}/turbine.sql"/>
            <transaction src="${file.prefix}${scarab.database.type}/${project}.sql"/>
            <transaction src="${file.prefix}${scarab.database.type}/scheduler.sql"/>
            <transaction src="${file.prefix}${scarab.database.type}/id-table.sql"/>
            <transaction src="${file.prefix}turbine-id-table-init.sql"/>
            <transaction src="${file.prefix}${project}-id-table-init.sql"/>
            <transaction src="${file.prefix}${project}-required-data.sql"/>
            <transaction src="${file.prefix}${project}-default-data.sql"/>
            <transaction src="${file.prefix}${project}-security.sql"/>
        </sql>
    </target>

    <!-- ================================================================== -->
    <!-- Load seed data unless bypassed by setting "skip.seed.data"         -->
    <!-- to any value in "build.properties"                                 -->
    <!-- ================================================================== -->
    <target name="load-seed-data" depends="load-default-data"
            unless="skip.seed.data">
        <!-- ============================================================== -->
        <!-- Alternate initial data file may be specified                   -->
        <!-- in "build.properties" by setting "seed.data.sql"               -->
        <!-- to an alternate file.                                          -->
        <!-- ============================================================== -->
        <property name="file.prefix" value="${build.sql.scarab}/"/>
        <property name="seed.data.sql"
            value="${file.prefix}${project}-sample-data.sql"/>
        <sql
            driver="${scarab.database.jdbc.driver}"
            url="${scarab.database.url}"
            userid="${scarab.database.admin.username}"
            password="${scarab.database.admin.password}">
            <classpath refid="classpath"/>
            <transaction src="${file.prefix}standard-${scarab.database.type}-init.sql"/>
            <transaction src="${seed.data.sql}"/>
        </sql>
    </target>

    <!-- ================================================================== -->
    <!-- Create DB from Torque                                              -->
    <!-- ================================================================== -->
    <target name="create-db" depends="load-seed-data"/>

    <!-- ================================================================== -->
    <!-- Generate Data DTD from Torque                                      -->
    <!-- ================================================================== -->
    <target name="datadtd-check">
        <echo message="checking: ${src.sql.dir}/${project}-data.dtd"/>
        <uptodate property="datadtd.uptodate"
            targetfile="${src.sql.dir}/${project}-data.dtd">
            <srcfiles dir="${src.sql.dir}" includes="scarab-schema.xml"/>
        </uptodate>
    </target>

    <target name="datadtd" depends="datadtd-check,compile"
            unless="datadtd.uptodate">
        <copy file="${src.sql.dir}/${project}-schema.xml"
              todir="${torque.dir.scarab}/schema"/>
        <copy file="${src.conf.dir}/torque.props"
              overwrite="true" tofile="${torque.dir.scarab}/build.properties"/>
        <ant antfile="build-torque.xml"
             target="datadtd" inheritAll="false">
            <property name="torque.home" value="${torque.dir.scarab}"/>
            <property name="databaseName" value="default"/>
            <property name="lib.dir" value="${build.project.webinf.lib}"/>
            <property name="build.properties" value="${torque.dir.scarab}/build.properties"/>
        </ant>

        <echo message="${src.java.dir.scarab}/${project}-data.dtd"/>
        <echo message="${src.sql.dir}/${project}-data.dtd"/>

        <copy file="${src.dir}/conf/classes/org/tigris/scarab/scarab.dtd"
            tofile="${src.sql.dir}/${project}-data.dtd"/>
    </target>

    <!-- ================================================================== -->
    <!-- Generate SQL from data XML                                         -->
    <!-- ================================================================== -->
    <target name="datasql" depends="prepare,datadtd,compile">
        <copy file="${src.sql.dir}/${project}-schema.xml"
            todir="${torque.dir.scarab}/schema"/>
        <copy file="${src.sql.dir}/${project}-data.xml"
            todir="${torque.dir.scarab}/schema"/>
        <copy file="${src.sql.dir}/${project}-data.dtd"
            todir="${torque.dir.scarab}/schema"/>
        <copy file="${src.conf.dir}/torque.props" overwrite="true"
            tofile="${torque.dir.scarab}/build.properties"
      filtering="true"/>
        <ant antfile="build-torque.xml"
            target="datasql" inheritAll="false">
            <property name="torque.home" value="${torque.dir.scarab}"/>
            <property name="lib.dir" value="${build.project.webinf.lib}"/>
            <property name="build.properties" value="${torque.dir.scarab}/build.properties"/>
        </ant>
        <move file="${src.java.dir.scarab}/${project}-data.sql"
            tofile="${src.sql.dir}/${project}-data.sql"/>
    </target>

    <!-- ================================================================== -->
    <!-- Compiles the source directory                                      -->
    <!-- ================================================================== -->
    <target name="compile" depends="om-peer,prepare">
        <mkdir dir="${build.dest.scarab}"/>

        <javac srcdir="${src.java.dir.scarab}"
            destdir="${build.dest.scarab}"
            debug="on"
            deprecation="off"
            optimize="off">
      <classpath refid="classpath"/>
            <classpath>
                <fileset dir="${build.project.webinf.lib}">
                    <include name="**/torque*.jar"/>
                </fileset>
            </classpath>
      <exclude name="**/package.html"/>
      <exclude name="torque/**"/>
        </javac>

      
    </target>

    
    <!-- ================================================================== -->
    <!-- Cleans up the build directory                                      -->
    <!-- ================================================================== -->
    <target name="clean" depends="prepare-build-dir, remove-generation">
        <delete dir="${build.dir}" quiet="true"/>
    </target>

    <target name="clean-all" depends="prepare-build-dir, remove-generation,clean">
        <delete file="${src.sql.dir}/${project}-data.dtd"/>
        <delete file="${scarab.log.file.scarab}" quiet="true"/>
        <delete file="${scarab.log.file.turbine}" quiet="true"/>
        <delete file="${scarab.log.file.torque}" quiet="true"/>
        <delete file="${scarab.log.file.fulcrum}" quiet="true"/>
        <delete file="${scarab.log.file.stratum}" quiet="true"/>
        <delete file="${scarab.log.file.velocity}" quiet="true"/>
        <delete file="${scarab.log.file.jcs}" quiet="true"/>
        <delete dir="${build.dir}" quiet="true"/>
        <delete quiet="true">
            <fileset dir="..">
                <include name="${final.name}*"/>
            </fileset>
        </delete>
        <delete>
            <fileset dir="../tomcat/logs">
                <include name="*log*.txt"/>
            </fileset>
        </delete>
    </target>

    <!-- ================================================================== -->
    <!-- Package (creates a .zip and .tar.gz)                               -->
    <!-- ================================================================== -->
    <target name="package" depends="package-zip,package-tgz">
    </target>

    <!-- ================================================================== -->
    <!-- Packages the distribution with ZIP                                 -->
    <!-- ================================================================== -->
    <target name="package-zip" depends="dist">
        <delete file="../${final.name}.zip" quiet="true" />
        <zip zipfile="../${final.name}.zip" 
             basedir="../" includes="**/${final.name}/**"/>
    </target>

    <!-- ================================================================== -->
    <!-- Packages the distribution with TAR-GZIP                            -->
    <!-- ================================================================== -->
    <target name="package-tgz" depends="dist">
        <delete file="../${final.name}.tar" quiet="true"/>
        <delete file="../${final.name}.tar.gz" quiet="true" />
        <tar longfile="gnu" tarfile="../${final.name}.tar" 
             basedir="../" includes="**/${final.name}/**"/>
        <gzip zipfile="../${final.name}.tar.gz" 
                  src="../${final.name}.tar"/>
        <delete file="../${final.name}.tar"/>
    </target>

    <!-- ================================================================== -->
    <!-- Creates the Binary distribution directory                          -->
    <!-- ================================================================== -->
    <target name="dist">
        <delete dir="${final.dir}" quiet="true" />
        <mkdir dir="${final.dir}"/>

        <copy todir="${final.dir}" preservelastmodified="true"
              includeEmptyDirs="false">
            <fileset dir="../">
                <exclude name="**/build/nightly.sh"/>
                <exclude name="**/build/run-tests*"/>
                <exclude name="**/build/velocity.log*"/>
                <exclude name="**/lib/jakarta-turbine-*.gz"/>
                <exclude name="**/src/sql/${scarab.database.type}-scarab.sql"/>
                <exclude name="**/src/sql/report.scarab.sql.generation"/>
                <exclude name="**/src/sql/project-schema.sql"/>
                <exclude name="**/src/sql/sqldb.map"/>
                <exclude name="**/src/sql/id-table-schema.sql"/>
                <exclude name="**/src/sql/*.DM1"/>
                <exclude name="**/src/sql/*.jpg"/>
                <exclude name="**/src/sql/schema-design-notes.txt"/>
                <exclude name="**/src/sql/sql_questions.txt"/>
                <exclude name="**/src/test/**"/>
                <exclude name="**/target/**"/>
                <exclude name="**/www/**"/>
            </fileset>
        </copy>     

    </target>

   

    <!-- ================================================================== -->
    <!-- Create a war file                                                  -->
    <!-- ================================================================== -->
    <target name="war" depends="compile">

        <war warfile="${scarab.war.file}"
              webxml="${build.project.webinf}/web.xml">

          <fileset dir="${build.project}">
            <exclude name="WEB-INF/web.xml"/>
            <exclude name="logs/**"/>
          </fileset>
        </war>
    </target>

  

  

<!-- ============================================================= -->
<!-- Targets beyond this point are currently considered broken or  -->
<!-- experimental - User Beware!                                  -->
<!-- ============================================================= -->

  

    <!-- ================================================================== -->
    <!-- Creates the Torque documentation                                   -->
    <!-- ================================================================== -->
    <target name="datadoc" depends="torque-copy-all-schema,sql-all">
        <mkdir dir="${torquedoc.destdir}"/>
        <ant antfile="build-torque.xml"
           target="doc">
            <property name="torque.home" value="${torque.dir.scarab}"/>
            <property name="lib.dir" value="${build.project.webinf}/lib"/>
            <property name="build.properties"
                      value="${torque.dir.scarab}/build.properties"/> 
            <property name="torque.doc.dir"
                      value="${torquedoc.destdir}"/> 
        </ant>
    </target>
    

    <!-- ================================================================== -->
    <!-- Dump data from DB into xml                                         -->
    <!-- ================================================================== -->
    <target name="datadump" depends="sql-all,compile">
        <ant antfile="build-torque.xml"
            target="datadump">
            <property name="torque.home" value="${torque.dir.scarab}"/>
            <property name="lib.dir" value="${build.project.webinf}/lib"/>
            <property name="build.properties"
                      value="${torque.dir.scarab}/build.properties"/> 
            <property name="torque.output.dir" value="${src.sql.dir}"/> 
            <property name="torque.database.driver"
                value="${scarab.database.jdbc.driver}"/>
            <property name="torque.database.url"
                value="${scarab.database.url}"/>
            <property name="torque.database.user"
                value="${scarab.database.username}"/>
            <property name="torque.database.password"
                value="${scarab.database.password}"/>
        </ant>
    </target>

    <!-- ================================================================== -->
    <!-- Generates an Html description of the DB schema                     -->
    <!-- This should be integrated with torque, so effort to integrate      -->
    <!-- into the build has not been done                                   -->
    <!-- ================================================================== -->
    <target name="html-schema">
        <echo message="This task expects you to have xalan-j_2_3_1 binary
                       distribution located at ${lib.repo}/xalan-j_2_3_1"/>
        <java classname="org.apache.xalan.xslt.Process" fork="yes"
              args="-XSL ${src.dir}/dtd/XMLSchemaToHTML.xsl 
                    -IN  ${src.sql.dir}/scarab-schema.xml 
                    -OUT ${src.sql.dir}/scarab-schema.html">
           <!-- it seems ant is treating these as jvmarg ??
           <arg value="-XSL ${src.dir}/dtd/XMLSchemaToHTML.xsl"/>
           <arg value="-IN  ${src.sql.dir}/scarab-schema.xml"/>
           <arg value="-OUT ${src.sql.dir}/scarab-schema.html"/>
           -->
           <classpath>
               <fileset dir="${lib.repo}/xalan-j_2_3_1/bin">
                   <include name="xalan.jar"/>
                   <include name="xml-apis.jar"/>
                   <include name="xercesImpl.jar"/>
               </fileset>
           </classpath>
        </java>

        <copy file="${src.sql.dir}/scarab-schema.html"
            tofile="${www.dir}/generated-scarab-schema.html"/>

    </target>

    <!-- Remove any torque *.generation files.  This forces torque to rebuild. -->
    <target name="remove-generation">
        <delete file="${src.sql.dir}/report.scarab.sql.generation"/>
        <delete file="${src.java.dir.scarab}/report.scarab.om.generation"/>
        <delete file="${src.dir}/report.scarab.datadtd.generation"/>
        <!-- delete file="${torque.dir.scarab}/report.scarab.om.generation"/-->
    </target>

    <!-- ================================================================== -->
    <!-- Complete buld of all components (for testing changes to build.xml) -->
    <!-- ================================================================== -->
    <target name="test-complete-build">
        <antcall target="clean"/>
        <antcall target="compile"/>
        <antcall target="datadtd"/>
        <antcall target="datadoc"/>
        <antcall target="war"/>
        <antcall target="dist"/>
    </target>

    <target name="migrate-b15-b16" depends="prepare">

        <property name="migration.dest.dir" 
            value="${build.dir}/migration/classes"/> 

        <path id="migration-cp">
          <path refid="classpath"/>
          <pathelement location="${migration.dest.dir}"/>
        </path>

        <mkdir dir="${migration.dest.dir}"/>
        <javac srcdir="${src.dir}/migration"
            destdir="${migration.dest.dir}"
            excludes="**/package.html,torque/**"
            debug="${debug}"
            deprecation="${deprecation}"
            optimize="${optimize}">

            <classpath refid="classpath"/>
        </javac>

      <taskdef name="b15b16-1" 
       classname="org.tigris.scarab.migration.b15b16.DB_1_MoveIssueCreateInfo">
       <classpath refid="migration-cp"/>
      </taskdef>

        <b15b16-1
            driver="${scarab.database.jdbc.driver}"
            url="${scarab.database.url}"
            userid="${scarab.database.admin.username}"
            password="${scarab.database.admin.password}">
            <classpath refid="migration-cp"/>
        </b15b16-1>

    </target>
    
    <!-- ================================================================== -->
    <!-- Generate SQL from Torque for all databases                         -->
    <!-- ================================================================== -->
    <target name="sql-all" description="Generate SQL DDL for all databases">
    	<antcall target="sql-specific-db">
    		<param name="generatesql.database.type" value="mysql"/>    			    		
    	</antcall>
    	<antcall target="sql-specific-db">
    		<param name="generatesql.database.type" value="mssql"/>    			    		
    	</antcall>   
    	<antcall target="sql-specific-db">
    		<param name="generatesql.database.type" value="oracle"/>    			    		
    	</antcall>     	 	
    	<antcall target="sql-specific-db">
    		<param name="generatesql.database.type" value="db2"/>    			    		
    	</antcall>     	
    	<antcall target="sql-specific-db">
    		<param name="generatesql.database.type" value="hypersonic"/>    			    		
    	</antcall>     	
    	<antcall target="sql-specific-db">
    		<param name="generatesql.database.type" value="postgresql"/>    			    		
    	</antcall>       	
    </target>
    <target name="sql-specific-db" depends="prepare-build-dir,torque-copy-all-schema">

        <filter token="DATABASE_TYPE" value="${generatesql.database.type}"/>
        <!-- copy the scarab specific build.properties over -->
        <copy file="${src.conf.dir}/torque.props" 
              tofile="${torque.dir.scarab}/build.properties"
              filtering="true" overwrite="true"/>

        <!-- move the generated .sql files into the target directory -->
        <ant antfile="build-torque.xml"
             target="sql"
             inheritAll="false">
            <!-- See the Torque tasks' build.properties for options -->
            <property name="torque.home" value="${torque.dir.scarab}"/>
            <property name="lib.dir" value="${lib.dir}"/>
            <property name="torque.output.dir" value="${src.dir}"/>
            <property name="build.properties"
                      value="${torque.dir.scarab}/build.properties"/>
            <property name="idTableXMLFile" value=""/>
        </ant>
		
		<mkdir dir="${build.sql.scarab}/${generatesql.database.type}/"/>
		
        <move file="${src.sql.dir}/${project}-schema.sql"
            tofile="${build.sql.scarab}/${generatesql.database.type}/${project}.sql"/>
        <move file="${src.sql.dir}/turbine-schema.sql"
            tofile="${build.sql.scarab}/${generatesql.database.type}/turbine.sql"/>
        <move file="${src.sql.dir}/scheduler-schema.sql"
            tofile="${build.sql.scarab}/${generatesql.database.type}/scheduler.sql"/>
        <move file="${src.sql.dir}/id-table-schema.sql"
            tofile="${build.sql.scarab}/${generatesql.database.type}/id-table.sql"/>
    </target>    
    
</project>

