<project name="Tomcat" default="main" basedir=".">
  <property name="build.compiler" value="classic"/>
  <property name="tomcat.build" value="../build/tomcat"/>
  <property name="tomcat.home" value="../dist/tomcat"/>

  <!-- ==================== Copy static files ==================== -->
  <!-- IF YOU CHANGE, sync dist.prepare !!! -->
  <target name="prepare">
    <mkdir dir="${tomcat.build}"/>
    <mkdir dir="${tomcat.build}/classes"/>
    <mkdir dir="${tomcat.build}/conf"/>
    <mkdir dir="${tomcat.build}/src"/>
    <mkdir dir="${tomcat.build}/lib"/>
    <mkdir dir="${tomcat.build}/bin"/>
    <mkdir dir="${tomcat.build}/webapps"/>

    <copydir src="src/shell" dest="${tomcat.build}/bin" />
    <copydir src="src/etc" dest="${tomcat.build}/conf"/>
    <copydir src="src/doc" dest="${tomcat.build}/doc"/>
    <copydir src="src/share/javax" dest="${tomcat.build}/src/javax"/>
    <mkdir dir="${tomcat.build}/lib/test"/>
    <mkdir dir="${tomcat.build}/lib/test/Golden"/>
    <copydir src="src/tests/share/tests/jsp/Golden" dest="${tomcat.build}/lib/test/Golden"/>

    <!-- include ant, it is used for testing and will be used for
         configuration and few other tasks -->
    <copydir src="${ant.home}/bin" dest="${tomcat.build}/bin"/>
    <copyfile src="${ant.home}/lib/xml.jar" dest="${tomcat.build}/lib/xml.jar"/>
    <copyfile src="${ant.home}/lib/ant.jar" dest="${tomcat.build}/lib/ant.jar"/>

    <copyfile src="src/share/org/apache/tomcat/deployment/web.xml"
              dest="${tomcat.build}/conf/web.xml"/>
    <copyfile src="src/share/org/apache/tomcat/deployment/web.dtd"
              dest="${tomcat.build}/conf/web.dtd"/>
    <copyfile src="LICENSE" dest="${tomcat.build}/LICENSE"/>

    <chmod perm="+x" src="${tomcat.build}/bin/tomcat.sh"/>
    <chmod perm="+x" src="${tomcat.build}/bin/ant"/>
    <chmod perm="+x" src="${tomcat.build}/bin/startup.sh"/>
    <chmod perm="+x" src="${tomcat.build}/bin/shutdown.sh"/>
    <chmod perm="+x" src="${tomcat.build}/bin/test-tomcat.sh"/>
  </target>

  <!-- ==================== Build tomcat ==================== -->
  <target name="tomcat" depends="prepare">
    <javac srcdir="src/share" destdir="${tomcat.build}/classes"
           classpath="${tomcat.build}/lib/xml.jar" debug="on"/>
    <rmic base="${tomcat.build}/classes"
          class="org.apache.tomcat.shell.AdminImpl"/>
  </target>

  <!-- ==================== Build all web applications ==================== -->
  <target name="webapps" depends="prepare">
    <!-- Examples -->
    <mkdir dir="${tomcat.build}/webapps/examples"/>
    <copydir src="src/examples" dest="${tomcat.build}/webapps/examples"/>
    <javac srcdir="src/examples/WEB-INF/classes"
           destdir="${tomcat.build}/webapps/examples/WEB-INF/classes"
           classpath="${tomcat.build}/classes"/>
    <javac srcdir="src/examples/jsp/plugin/applet"
           destdir="${tomcat.build}/webapps/examples/jsp/plugin/applet"/>
    <jar   jarfile="${tomcat.build}/webapps/examples.war"
           basedir="${tomcat.build}/webapps/examples"
           items="." /> 

    <!-- Root context -->
    <mkdir dir="${tomcat.build}/webapps/ROOT"/>
    <copydir src="src/webpages" dest="${tomcat.build}/webapps/ROOT"/>
    <javac srcdir="src/webpages/WEB-INF/classes"
           destdir="${tomcat.build}/webapps/ROOT/WEB-INF/classes"
           classpath="${tomcat.build}/classes"/>
    <jar   jarfile="${tomcat.build}/webapps/ROOT.war"
           basedir="${tomcat.build}/webapps/ROOT"
           items="." /> 

    <!-- Test application -->
    <mkdir dir="${tomcat.build}/webapps/test"/>
    <copydir src="src/tests/webpages" dest="${tomcat.build}/webapps/test"/>
    <javac srcdir="src/tests/webpages/WEB-INF/classes"
           destdir="${tomcat.build}/webapps/test/WEB-INF/classes"
           classpath="${tomcat.build}/classes"/>
    <jar   jarfile="${tomcat.build}/webapps/test.war"
           basedir="${tomcat.build}/webapps/test"
           items="." /> 

  </target>

  <!-- ==================== Copy the files to distribution format ==================== -->
  <target name="dist" depends="main,webapps">
    <mkdir dir="${tomcat.home}"/>
    <mkdir dir="${tomcat.home}/classes"/>
    <mkdir dir="${tomcat.home}/conf"/>
    <mkdir dir="${tomcat.home}/src"/>
    <mkdir dir="${tomcat.home}/lib"/>
    <mkdir dir="${tomcat.home}/bin"/>
    <mkdir dir="${tomcat.home}/webapps"/>
    <mkdir dir="${tomcat.home}/webapps/ROOT"/>

    <copydir src="${tomcat.build}/bin" dest="${tomcat.home}/bin" />
    <copydir src="${tomcat.build}/conf" dest="${tomcat.home}/conf"/>
    <copydir src="${tomcat.build}/doc" dest="${tomcat.home}/doc"/>
    <copydir src="${tomcat.build}/src" dest="${tomcat.home}/src"/>
    <copydir src="${tomcat.build}/lib" dest="${tomcat.home}/lib"/>
    <copyfile src="${tomcat.build}/LICENSE" dest="${tomcat.home}/LICENSE"/>

    <copydir src="${tomcat.build}/webapps/ROOT" dest="${tomcat.home}/webapps/ROOT"/>
    <copydir src="${tomcat.build}/webapps/examples" dest="${tomcat.home}/webapps/examples"/>
    <copydir src="${tomcat.build}/webapps/test" dest="${tomcat.home}/webapps/test"/>
    <!-- Copy only war format for examples and test  -->
    <copyfile src="${tomcat.build}/webapps/examples.war" 
              dest="${tomcat.home}/webapps/examples.war"/>
    <copyfile src="${tomcat.build}/webapps/test.war" 
              dest="${tomcat.home}/webapps/test.war"/>


    <!-- create tomcat jar files -->
    <jar jarfile="${tomcat.home}/lib/webserver.jar"
         basedir="${tomcat.build}/classes"
         items="org/apache/tomcat"/> 
    <jar jarfile="${tomcat.home}/lib/servlet.jar"
         basedir="${tomcat.build}/classes"
         items="javax/servlet"/>
    <jar jarfile="${tomcat.home}/lib/jasper.jar"
         basedir="${tomcat.build}/classes"
         items="org/apache/jasper"/>

    <!-- Change permissions for unix -->
    <chmod perm="+x" src="${tomcat.home}/bin/tomcat.sh"/>
    <chmod perm="+x" src="${tomcat.build}/bin/ant"/>
    <chmod perm="+x" src="${tomcat.build}/bin/startup.sh"/>
    <chmod perm="+x" src="${tomcat.build}/bin/shutdown.sh"/>
  </target>
  
  <!-- ==================== Admin ==================== -->
  <target name="clean">
    <deltree dir="${tomcat.build}"/>
  </target>
  
  <target name="dist.clean">
    <deltree dir="${tomcat.home}"/>
  </target>

  <target name="all" depends="clean,main,dist,webapps"/>
  <target name="main" depends="tomcat"/>
  
</project>
