<project name="Tomcat" default="main" basedir=".">
  <property name="build.compiler" value="classic"/>

  <property name="tomcat.build" value="../build/tomcat"/>
  <property name="tomcat.home" value="../dist/tomcat"/>

  <!-- classpath needed when compiling tomcat tests 
       We use build/classes since there is 1 dependency to internal tomcat classes 
    -->
  <property name="test.classpath" value="${tomcat.build}/classes:../jakarta-tools/moo.jar" />

  <!-- Create directories, copy static files -->
  <target name="prepare">
    <mkdir dir="${tomcat.build}"/>
    <mkdir dir="${tomcat.build}/classes"/>
    <mkdir dir="${tomcat.build}/etc"/>
    <mkdir dir="${tomcat.build}/src"/>
    <mkdir dir="${tomcat.build}/lib"/>

    <copydir src="src/webpages" dest="${tomcat.build}/webpages"/>
    <copydir src="src/examples" dest="${tomcat.build}/examples"/>
    <copydir src="src/share/javax" dest="${tomcat.build}/src/javax"/>
    <copyfile src="../jakarta-tools/projectx-tr2.jar" dest="${tomcat.build}/lib/xml.jar"/>

    <copydir src="src/shell" dest="${tomcat.build}" />

    <!-- XXX clean this up ! -->
    <copyfile src="src/share/org/apache/tomcat/shell/deployment/server.xml"
           dest="${tomcat.build}/server.xml"/>
    <!-- XXX Where should it be ? -->
    <copyfile src="src/share/org/apache/tomcat/shell/deployment/server.xml"
            dest="${tomcat.build}/etc/server.xml"/>
    <copyfile src="src/share/org/apache/tomcat/shell/deployment/server.dtd"
     dest="${tomcat.build}/etc/server.dtd"/>
    <copyfile src="src/share/org/apache/tomcat/deployment/web.xml"
     dest="${tomcat.build}/etc/web.xml"/>
    <copyfile src="src/share/org/apache/tomcat/deployment/web.dtd"
     dest="${tomcat.build}/etc/web.dtd"/>

    <copyfile src="LICENSE" dest="${tomcat.build}/LICENSE"/>
    <copyfile src="src/etc/readme" dest="${tomcat.build}/README"/>
    <copyfile src="src/etc/faq" dest="${tomcat.build}/FAQ"/>

    <copyfile src="src/etc/SimpleStartup.java"
              dest="${tomcat.build}/etc/SimpleStartup.java"/>
  </target>

  <target name="main" depends="prepare">
    <javac srcdir="src/share" destdir="${tomcat.build}/classes"
     classpath="${tomcat.build}/lib/xml.jar" debug="on"/>
    <javac srcdir="src/examples/WEB-INF/classes"
     destdir="${tomcat.build}/examples/WEB-INF/classes"
     classpath="${tomcat.build}/classes"/>
    <javac srcdir="src/webpages/WEB-INF/classes"
     destdir="${tomcat.build}/webpages/WEB-INF/classes"
     classpath="${tomcat.build}/classes"/>

    <javac srcdir="src/examples/jsp/plugin/applet"
     destdir="${tomcat.build}/examples/jsp/plugin/applet"/>

    <rmic base="${tomcat.build}/classes"
     class="org.apache.tomcat.shell.AdminImpl"/>

<!--

    <javac srcdir="${tomcat.build}/examples/WEB-INF/classes/jsp/tags"
            destdir="${tomcat.build}/examples/WEB-INF/classes/jsp/tags"
            classpath="${tomcat.build}/classes"/>
     <mkdir dir="${tomcat.build}/examples/jsp/libs"/>
     <jar jarfile="${tomcat.build}/examples/jsp/libs/taglib.jar" 
          basedir="${tomcat.build}/examples/WEB-INF/classes/jsp/tags"
          items="examples,META-INF/taglib.tld"/>
-->

  </target>

  <target name="dist" depends="main">
    <!-- cut & paste of "prepare", with tomcat.home instead of tomcat_build 
         XXX create "parametrized" targets
         XXX do we need all the files in tomcat_build ??
      -->
    <mkdir dir="${tomcat.home}" />
    <mkdir dir="${tomcat.home}/lib" />
    <mkdir dir="${tomcat.home}/etc" />
    <mkdir dir="${tomcat.home}/src" />
    <mkdir dir="${tomcat.home}/examples" />
    <mkdir dir="${tomcat.home}/webpages" />

    <copydir src="src/share/javax" dest="${tomcat.home}/src/javax"/>
    <copyfile src="../jakarta-tools/ant.jar" dest="${tomcat.home}/lib/ant.jar"/>
    <copyfile src="../jakarta-tools/projectx-tr2.jar" dest="${tomcat.home}/lib/xml.jar"/>

    <copydir src="src/shell" dest="${tomcat.home}" />

    <!-- XXX clean this up ! -->
    <copyfile src="src/share/org/apache/tomcat/shell/deployment/server.xml"
           dest="${tomcat.home}/server.xml"/>
    <!-- XXX Where should it be ? -->
    <copyfile src="src/share/org/apache/tomcat/shell/deployment/server.xml"
            dest="${tomcat.home}/etc/server.xml"/>
    <copyfile src="src/share/org/apache/tomcat/shell/deployment/server.dtd"
     dest="${tomcat.home}/etc/server.dtd"/>
    <copyfile src="src/share/org/apache/tomcat/deployment/web.xml"
     dest="${tomcat.home}/etc/web.xml"/>
    <copyfile src="src/share/org/apache/tomcat/deployment/web.dtd"
     dest="${tomcat.home}/etc/web.dtd"/>

    <copyfile src="src/etc/license.txt" dest="${tomcat.home}/LICENSE"/>
    <copyfile src="src/etc/readme" dest="${tomcat.home}/README"/>
    <copyfile src="src/etc/faq" dest="${tomcat.home}/FAQ"/>
    <copyfile src="src/etc/SimpleStartup.java"
              dest="${tomcat.home}/etc/SimpleStartup.java"/>

    <copydir src="${tomcat.build}/webpages" dest="${tomcat.home}/webpages"/>
    <copydir src="${tomcat.build}/examples" dest="${tomcat.home}/examples"/>

    <!-- XXX add manifest for autorun! -->
    <jar jarfile="${tomcat.home}/webserver.jar"
        basedir="${tomcat.build}/classes"
        items="org/apache/tomcat"/> 
    <jar jarfile="${tomcat.home}/lib/servlet.jar"
        basedir="${tomcat.build}/classes"
        items="javax/servlet"/>
    <jar jarfile="${tomcat.home}/lib/jasper.jar"
        basedir="${tomcat.build}/classes"
        items="org/apache/jasper"/>
  </target>

  <target name="test" depends="main">
    <mkdir dir="${tomcat.build}/test"/>
    <mkdir dir="${tomcat.build}/test/classes"/>
    <mkdir dir="${tomcat.build}/test/lib"/>
    <mkdir dir="${tomcat.build}/test/webpages"/>

    <copydir src="src/tests/webpages"
        dest="${tomcat.build}/test/webpages"/>

    <copydir src="src/tests/bin" dest="${tomcat.build}/test"/>
    <copyfile src="src/tests/server.xml"
        dest="${tomcat.build}/test/server.xml"/>
    <copyfile src="src/tests/testlist.txt"
        dest="${tomcat.build}/test/testlist.txt"/>
    <copyfile src="../jakarta-tools/moo.jar"
        dest="${tomcat.build}/test/lib/moo.jar"/>
    <copyfile src="../jakarta-tools/moo.jar"
        dest="${tomcat.build}/test/webpages/WEB-INF/lib/moo.jar"/>

    <javac srcdir="src/tests/share"
        destdir="${tomcat.build}/test/classes"
        classpath="${test.classpath}"/>
    <javac srcdir="src/tests/webpages/WEB-INF/classes"
        destdir="${tomcat.build}/test/webpages/WEB-INF/classes"
        classpath="${test.classpath}"/>

  </target>

  <target name="servlet">

    <mkdir dir="${tomcat.build}"/>
    <mkdir dir="${tomcat.build}/classes"/>

    <javac srcdir="src/share/javax" destdir="${tomcat.build}/classes"/>

    <jar jarfile="../jakarta-tools/servlet-2.2.0.jar"
        basedir="${tomcat.build}/classes"
        items="javax"/>
  </target>

  <target name="clean">
    <deltree dir="${tomcat.build}"/>
  </target>

  <target name="all" depends="clean,main,dist,test"/>
  
</project>
