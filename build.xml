<?xml version="1.0" encoding="UTF-8"?>
<!-- Emacs indentation & editting support: 
     edit XEMACS_HOME/xemacs-pacakges/etc/psgml/CATALOG
     Add: "DOCTYPE project ant.dtd"
     copy ant.dtd to .../etc/psgml/
    ant.dtd is generated with:
    <antstructure output="ant.dtd"/>
<!DOCTYPE ant SYSTEM "ant.dtd" >
-->
<project name="Tomcat" default="main" basedir=".">

  <!-- Compilation properties -->

  <property name="build.compiler" value="classic"/>
  <property name="optimize" value="false"/>
  <property name="debug" value="off"/>

  <!-- Directories -->

  <property name="tomcat.build" value="../build/tomcat"/>
  <property name="tomcat.home" value="../dist/tomcat"/>
  <property name="tomcat.dist" value="${tomcat.home}"/>


  <!-- External packages we depend on -->

  <property name="ant.home" value="../jakarta-ant"/>
  <property name="jaxp" value="../jaxp-1.0.1"/>

  <property name="servlet22.jar" value="bin/servlet22.jar"/>
 
  <property name="servlet.jar" value="${servlet22.jar}"/>

  <!-- ==================== Initialization - guessing config ========== -->
  <target name="init">
    <available property="jsse.present" classname="javax.net.ssl.SSLServerSocket"/>
    <available property="jdk12.present" classname="java.security.PrivilegedAction"/>
  </target>

  <!-- ==================== Copy static files ==================== -->
  <!-- IF YOU CHANGE, sync dist.prepare !!! -->

  <target name="prepare" depends="init">
    <mkdir dir="src/doc"/> <!-- Temp change until dir is not empty -->
    <mkdir dir="${tomcat.build}"/>
    <mkdir dir="${tomcat.build}/classes"/>
    <mkdir dir="${tomcat.build}/conf"/>
    <mkdir dir="${tomcat.build}/src"/>
    <mkdir dir="${tomcat.build}/lib"/>
    <mkdir dir="${tomcat.build}/logs"/>
    <mkdir dir="${tomcat.build}/bin"/>
    <mkdir dir="${tomcat.build}/doc"/>
    <mkdir dir="${tomcat.build}/webapps"/>
    <mkdir dir="${tomcat.build}/native"/>

    <copy todir="${tomcat.build}/bin">
            <fileset dir="src/shell"/>
        </copy>
    <copy todir="${tomcat.build}/conf">
            <fileset dir="src/etc"/>
        </copy>
    <copy todir="${tomcat.build}/doc">
            <fileset dir="src/doc"/>
        </copy>
    <copy todir="${tomcat.build}/native">
            <fileset dir="src/native"/>
        </copy>
    <copy tofile="${tomcat.build}/LICENSE" file="LICENSE"/>

    <!-- include ant, it is used for testing and will be used for
    configuration and few other tasks -->
    <copy todir="${tomcat.build}/bin">
            <fileset dir="${ant.home}/bin"/>
        </copy>
    <copy tofile="${tomcat.build}/lib/jaxp.jar" 
	  file="${ant.home}/lib/jaxp.jar"/>
    <copy tofile="${tomcat.build}/lib/parser.jar" 
	  file="${ant.home}/lib/parser.jar"/>
    <copy tofile="${tomcat.build}/lib/jaxp.jar" file="${jaxp}/jaxp.jar"/>
    <copy tofile="${tomcat.build}/lib/parser.jar" file="${jaxp}/parser.jar"/>
    <copy tofile="${tomcat.build}/lib/jaxp.jar" file="${jaxp}/jaxp.jar"/>
    <copy tofile="${tomcat.build}/lib/crimson.jar" file="${jaxp}/crimson.jar"/>
    
    <!-- This act as a "default", Tomcat3.3 will not load it in
         classpath, just a hack to ease the transition
     -->
    <copy tofile="${tomcat.build}/lib/servlet.jar" file="${servlet22.jar}"/>

    <fixcrlf srcdir="${tomcat.build}/bin" includes="**/*.sh" cr="remove"/>
    <fixcrlf srcdir="${tomcat.build}/bin" includes="**/*.bat" cr="add"/>

    <chmod perm="+x" file="${tomcat.build}/bin/ant"/>
    <chmod perm="+x" file="${tomcat.build}/bin/antRun"/>
    <chmod perm="+x" file="${tomcat.build}/bin/tomcat.sh"/>
    <chmod perm="+x" file="${tomcat.build}/bin/jspc.sh"/>
    <chmod perm="+x" file="${tomcat.build}/bin/startup.sh"/>
    <chmod perm="+x" file="${tomcat.build}/bin/shutdown.sh"/>
  </target>

  <!-- ==================== Tomcat util ==================== -->
  <!-- Independent ( stand alone ) utilities -->

  <target name="tomcat_util" depends="init">
    <javac destdir="${tomcat.build}/classes" 
	   debug="${debug}" 
	   optimize="${optimize}" 
	   deprecation="off" 
	   srcdir="src/share">
      <!-- no dependencies -->
      <include name="org/apache/tomcat/util/**"/>    
      <exclude name="**/util/net/SSLSocketFactory.java" unless="jsse.present"/>
      <exclude name="**/util/compat/Jdk12Support.java" unless="jdk12.present"/>
    </javac>
    <jar jarfile="${tomcat.build}/lib/tomcat_util.jar" 
	 basedir="${tomcat.build}/classes"> 
      <include name="org/apache/tomcat/util/**"/>    
      <include name="org/apache/tomcat/logging/**"/>    
    </jar>
  </target>

  <!-- ==================== Tomcat.jar ( starter )  ==================== -->

  <target name="tomcat.jar" depends="init">
    <javac destdir="${tomcat.build}/classes" 
	   debug="${debug}" 
	   optimize="${optimize}" 
	   deprecation="off" 
	   srcdir="src/share">
      <!-- no dependencies -->
      <include name="org/apache/tomcat/startup/Main.java"/>    
      <include name="org/apache/tomcat/util/SimpleClassLoader.java"/>    
      <include name="org/apache/tomcat/util/IntrospectionUtils.java"/>    
    </javac>
    <jar jarfile="${tomcat.build}/lib/tomcat.jar" 
	 basedir="${tomcat.build}/classes" 
	 manifest="src/build/manifest"> 
      <include name="org/apache/tomcat/startup/Main.class"/> 
      <include name="org/apache/tomcat/startup/Main$*.class"/> 
      <include name="org/apache/tomcat/util/SimpleClassLoader**"/> 
      <include name="org/apache/tomcat/util/IntrospectionUtils**"/> 
    </jar>
  </target>

  <target name="stop-tomcat.jar" depends="init">
    <javac destdir="${tomcat.build}/classes" 
	   debug="${debug}" 
	   optimize="${optimize}" 
	   deprecation="off" 
	   srcdir="src/share">
      <!-- no dependencies -->
      <include name="org/apache/tomcat/startup/StopTomcat.java"/>    
    </javac>
    <jar jarfile="${tomcat.build}/lib/stop-tomcat.jar" 
	 basedir="${tomcat.build}/classes" 
	 manifest="src/build/manifest.stop-tomcat"> 
      <include name="org/apache/tomcat/startup/StopTomcat.class"/> 
      <include name="org/apache/tomcat/util/StringManager.class"/> 
      <include name="org/apache/tomcat/resources/LocalStrings*"/> 
    </jar>
  </target>

  <!-- ==================== Tomcat core ==================== -->

  <target name="tomcat_core" depends="init">
    <javac destdir="${tomcat.build}/classes" 
	   debug="${debug}" 
	   optimize="${optimize}" 
	   deprecation="off" 
	   srcdir="src/share">
      <classpath>
	<pathelement location="${tomcat.build}/lib/tomcat_util.jar"/>
      </classpath>
      <include name="org/apache/tomcat/core/**"/>    
    </javac>
    <copy todir="${tomcat.build}/classes/org/apache/tomcat">
            <fileset dir="src/share/org/apache/tomcat">
                <include name="**/*.properties"/>
                <include name="**/*.dtd"/>
            </fileset>
        </copy>
    <jar jarfile="${tomcat.build}/lib/tomcat_core.jar" 
	 basedir="${tomcat.build}/classes"> 
      <include name="org/apache/tomcat/core/**"/>    
      <include name="org/apache/tomcat/resources/**"/>    
    </jar>
  </target>

  <!-- ==================== Tomcat config ==================== -->

  <target name="tomcat-startup" depends="init">
    <javac destdir="${tomcat.build}/classes" 
	   debug="${debug}" 
	   optimize="${optimize}" 
	   deprecation="off" 
	   srcdir="src/share">
      <classpath>
	<pathelement location="${tomcat.build}/lib/tomcat_util.jar"/>
	<pathelement location="${tomcat.build}/lib/tomcat_core.jar"/>
      </classpath>
      <include name="org/apache/tomcat/startup/**"/>    
      <exclude name="**/EmbededTomcat.java" unless="jdk12.present"/>
    </javac>
    <jar jarfile="${tomcat.build}/lib/tomcat-startup.jar" 
	 basedir="${tomcat.build}/classes"
	 manifest="src/build/manifest.startup"> 
      <include name="org/apache/tomcat/startup/**"/>    
    </jar>
  </target>

  <!-- ==================== Servlet 22 (default) implementation ========== -->
  <target name="facade22" depends="init">
    <javac 
	   destdir="${tomcat.build}/classes" 
	   debug="${debug}" 
	   optimize="${optimize}" 
	   deprecation="off" 
	   srcdir="src/facade22">
      <classpath>
	<pathelement location="${servlet22.jar}"/>
	<pathelement location="${tomcat.build}/lib/tomcat_util.jar"/>
	<pathelement location="${tomcat.build}/lib/tomcat_core.jar"/>
      </classpath>
      <include name="org/apache/tomcat/facade/**"/>    
    </javac>
    <jar jarfile="${tomcat.build}/lib/facade22.jar" 
	 basedir="${tomcat.build}/classes"
	 manifest="src/build/manifest.facade22"> 
      <include name="org/apache/tomcat/facade/**"/> 
    </jar>
  </target>

  <!-- ====================  "Standard" interceptors  ========== -->
  <target name="tomcat_modules" depends="init">
    <javac destdir="${tomcat.build}/classes" 
	   srcdir="src/share" 
	   debug="${debug}" 
	   optimize="${optimize}" 
	   deprecation="off">
      <classpath>
	<pathelement location="${tomcat.build}/lib/tomcat_util.jar"/>
	<pathelement location="${tomcat.build}/lib/tomcat_core.jar"/>
      </classpath>
      <include name="org/apache/tomcat/modules/**"/>    
      <!-- <exclude 
          name="org/apache/tomcat/modules/generators/Jdk12Interceptor.java" 
	  unless="jdk12.present"/>
       -->
      <exclude 
	  name="org/apache/tomcat/modules/config/LoaderInterceptor12.java" 
          unless="jdk12.present"/>
      <exclude 
	  name="org/apache/tomcat/modules/config/PolicyInterceptor.java" 
	  unless="jdk12.present"/>
    </javac>

    <jar 
        jarfile="${tomcat.build}/lib/tomcat_modules.jar" 
        basedir="${tomcat.build}/classes"> 
      <include name="org/apache/tomcat/modules/**"/> 
    </jar>
  </target>

  <!-- ====================  Jasper ( 1.0 )  ========== -->
  <target name="jasper" depends="init">
    <javac 
	   destdir="${tomcat.build}/classes" 
	   srcdir="src/share" 
	   debug="${debug}" 
	   optimize="${optimize}" 
	   deprecation="off">
      <classpath>
	<pathelement location="${servlet22.jar}"/>
      </classpath>
      <include name="org/apache/jasper/**"/>    
      <exclude name="org/apache/jasper/servlet/JasperLoader12.java" 
	unless="jdk12.present"/>
    </javac>
    <copy todir="${tomcat.build}/classes/org/apache/jasper">
            <fileset dir="src/share/org/apache/jasper">
                <include name="**/*.properties"/>
                <include name="**/*.dtd"/>
            </fileset>
        </copy>
    <jar jarfile="${tomcat.build}/lib/jasper.jar" 
	 basedir="${tomcat.build}/classes" 
	 includes="org/apache/jasper/**"/>
  </target>

  <target name="tomcat-jars-new" depends="tomcat_util,tomcat.jar,stop-tomcat.jar,tomcat_core,jasper,tomcat_modules,facade22,tomcat-startup">
  </target>

  <!-- ==================== J2EE integration ========== -->
  <target name="j2ee">
    <ant antfile="src/j2ee/build.xml" target="tomcat-j2ee.jar"/>
  </target>

  <!-- ==================== Build all web applications ==================== -->

  <target name="webapps" depends="prepare">
    <!-- Examples -->
    <mkdir dir="${tomcat.build}/webapps/examples"/>
    <copy todir="${tomcat.build}/webapps/examples">
      <fileset dir="src/examples"/>
    </copy>
    <javac srcdir="src/examples/WEB-INF/classes" 
	   optimize="${optimize}" 
	   destdir="${tomcat.build}/webapps/examples/WEB-INF/classes" 
	   classpath="${tomcat.build}/classes;${servlet22.jar}"/>
    <javac srcdir="src/examples/jsp/plugin/applet" 
	   optimize="${optimize}" 
	   destdir="${tomcat.build}/webapps/examples/jsp/plugin/applet"/>


      <!-- Root context -->
    <mkdir dir="${tomcat.build}/webapps/ROOT"/>
    <copy todir="${tomcat.build}/webapps/ROOT">
      <fileset dir="src/webpages"/>
    </copy>
    <copy todir="${tomcat.build}/webapps/ROOT/doc">
      <fileset dir="src/doc"/>
    </copy>
    <javac srcdir="src/webpages/WEB-INF/classes" 
	   optimize="${optimize}" 
	   destdir="${tomcat.build}/webapps/ROOT/WEB-INF/classes" 
	   classpath="${tomcat.build}/classes;${servlet22.jar}"/>
      
      <!-- admin context -->
    <mkdir dir="${tomcat.build}/webapps/admin"/>
    <copy todir="${tomcat.build}/webapps/admin">
      <fileset dir="src/admin"/>
    </copy>
    <copy tofile="${tomcat.build}/webapps/admin/WEB-INF/lib/ant.jar" 
	  file="${ant.home}/lib/ant.jar"/>
    <!-- temp - the old GTest -->
    <javac srcdir="src/tests/share/gtest" 
	   optimize="${optimize}" 
	   destdir="${tomcat.build}/webapps/admin/WEB-INF/classes" 
	   classpath="${tomcat.build}/classes;${servlet22.jar}"/>
    <javac srcdir="src/admin/WEB-INF/classes" 
	   optimize="${optimize}" 
	   destdir="${tomcat.build}/webapps/admin/WEB-INF/classes" 
	   classpath="${tomcat.build}/classes;${servlet22.jar}"/>
      
  </target>

  <!-- ==================== Build the internal test app =================== -->

  <target name="sanity-test">
    <ant antfile="src/tests/build.xml" />
  </target>

  <target name="watchdog-web-based">
    <ant antfile="src/tests/build.xml" target="watchdog" />
  </target>

  <!-- ==================== Copy the files to distribution format ======== -->
  <target name="dist" depends="main,webapps,tomcat-jars-new">

    <mkdir dir="${tomcat.dist}"/>
    <copy todir="${tomcat.dist}">
            <fileset dir="${tomcat.build}"/>
        </copy>
    <!-- copy todir="${tomcat.dist}/src/org">
            <fileset dir="src/share/org"/>
       </copy -->
    <copy tofile="${tomcat.dist}/lib/jaxp.jar" file="${jaxp}/jaxp.jar"/>
    <copy tofile="${tomcat.dist}/lib/parser.jar" file="${jaxp}/parser.jar"/>
    <copy tofile="${tomcat.dist}/lib/servlet.jar" file="${servlet22.jar}"/>
    <!-- copy todir="${tomcat.dist}/src/org">
            <fileset dir="src/facade22/org"/>
        </copy -->

    <!-- Add Tomcat internal javadoc -->
    <mkdir dir="${tomcat.dist}/webapps/ROOT/javadoc"/>
<!--    <javadoc packagenames="org.apache.tomcat.*"-->
    <javadoc packagenames="org.apache.tomcat.core" sourcepath="src/share;src/facade22" destdir="${tomcat.dist}/webapps/ROOT/javadoc" author="true" version="true" use="true" windowtitle="Tomcat internal API" doctitle="Tomcat internal" bottom="Copyright © 2000 Apache Software Foundation. All Rights Reserved."/>

    <delete dir="${tomcat.dist}/classes"/>


    <!-- create webapp WARS -->
    <jar jarfile="${tomcat.dist}/webapps/examples.war" basedir="${tomcat.dist}/webapps/examples" excludes="jsp/snp/snoop.jsp" includes="**"/> 
    <delete dir="${tomcat.dist}/webapps/examples"/>

    <jar jarfile="${tomcat.dist}/webapps/admin.war" basedir="${tomcat.dist}/webapps/admin" includes="**"/> 
    <delete dir="${tomcat.dist}/webapps/admin"/>

    <jar jarfile="${tomcat.dist}/webapps/ROOT.war" basedir="${tomcat.dist}/webapps/ROOT" includes="**"/>
    <delete dir="${tomcat.dist}/webapps/ROOT"/>


    <!-- Change permissions for unix -->
    <chmod perm="+x" file="${tomcat.dist}/bin/tomcat.sh"/>
    <chmod perm="+x" file="${tomcat.dist}/bin/jspc.sh"/>
    <chmod perm="+x" file="${tomcat.dist}/bin/startup.sh"/>
    <chmod perm="+x" file="${tomcat.dist}/bin/shutdown.sh"/>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the distribution with ZIP                                  -->
  <!-- =================================================================== -->
  <target name="dist-zip" depends="dist">
    <zip zipfile="${Name}-${version}.zip" basedir="${tomcat.dist}" includes="**"/>
  </target>
  
  <target name="dist-new" depends="dist">
    <mkdir dir="${tomcat.dist}/lib/shared"/>
    <mkdir dir="${tomcat.dist}/lib/common"/>
    <copy file ="${tomcat.dist}/lib/servlet.jar"
        todir="${tomcat.dist}/lib/common" />
    <copy file ="${tomcat.dist}/lib/jasper.jar"
        todir="${tomcat.dist}/lib/shared" />
    <copy file ="${tomcat.dist}/lib/tomcat_util.jar"
        todir="${tomcat.dist}/lib/shared" />
  </target>

  <target name="new" depends="main">
    <mkdir dir="${tomcat.build}/lib/shared"/>
    <mkdir dir="${tomcat.build}/lib/common"/>
    <copy file ="${tomcat.build}/lib/servlet.jar"
        todir="${tomcat.build}/lib/common" />
    <copy file ="${tomcat.build}/lib/jasper.jar"
        todir="${tomcat.build}/lib/shared" />
    <copy file ="${tomcat.build}/lib/tomcat_util.jar"
        todir="${tomcat.build}/lib/shared" />
<!--
    <delete>
        <fileset dir="${tomcat.build}/classes"/>
    </delete>
-->
  </target>


  <!-- ==================== Admin & agreagate ==================== -->
   
  <!-- The self-test app should be removed in the release, but it's 
       useful to have it builded by default -->
  <target name="tomcat" depends="prepare,tomcat-jars-new">
  </target>

  <target name="clean-classes" depends="init">
    <delete dir="${tomcat.build}/classes/org"/>
  </target>

  <target name="clean" depends="init">
    <delete dir="${tomcat.build}"/>
    <delete dir="${tomcat.dist}"/>
  </target>

  
  <target name="all" depends="clean,dist"/>
  <target name="main" depends="tomcat,webapps,sanity-test"/>
    
</project>
